<!DOCTYPE html><html class=split data-revision="$Revision: 8891 $" lang=en-GB-x-hixie><title>HTML Standard</title><script>
   var loadTimer = new Date();
   var current_revision = "r" + document.documentElement.getAttribute('data-revision').substr(11);
   current_revision = current_revision.substr(0, current_revision.length - 2);
   var last_known_revision = current_revision;
   function F( /* varargs... */) {
     var fragment = document.createDocumentFragment();
     for (var index = 0; index < arguments.length; index += 1) {
       if (arguments[index] instanceof Array) {
         fragment.appendChild(F.apply(this, arguments[index]));
       } else if (typeof arguments[index] == 'string') {
         fragment.appendChild(document.createTextNode(arguments[index]));
       } else {
         fragment.appendChild(arguments[index]);
       }
     }
     return fragment;
   }
   function E(name, /* optional */ attributes /*, varargs... */) {
     var element = document.createElement(name);
     var index = 1;
     if ((arguments.length > 1) && (typeof attributes != 'string') &&
         (!(attributes instanceof Node)) && (!(attributes instanceof Array))) {
       for (var attName in attributes) {
         if (typeof attributes[attName] == 'boolean') {
           if (attributes[attName])
             element.setAttribute(attName, '');
         } else if (typeof attributes[attName] == 'function') {
           element[attName] = attributes[attName];
         } else {
           element.setAttribute(attName, attributes[attName]);
         }
       }
       index = 2;
     }
     for (; index < arguments.length; index += 1) {
       if (arguments[index] instanceof Array) {
         element.appendChild(F.apply(this, arguments[index]));
       } else if (typeof arguments[index] == 'string') {
         element.appendChild(document.createTextNode(arguments[index]));
       } else {
         element.appendChild(arguments[index]);
       }
     }
     return element;
   }
   function getCookie(name) {
     var params = location.search.substr(1).split("&");
     for (var index = 0; index < params.length; index++) {
       if (params[index] == name)
         return "1";
       var data = params[index].split("=");
       if (data[0] == name)
         return unescape(data[1]);
     }
     var cookies = document.cookie.split("; ");
     for (var index = 0; index < cookies.length; index++) {
       var data = cookies[index].split("=");
       if (data[0] == name)
         return unescape(data[1]);
     }
     return null;
   }
   var currentAlert;
   var currentAlertTimeout;
   function showAlert(s, href) {
     if (!currentAlert) {
       currentAlert = document.createElement('div');
       currentAlert.id = 'alert';
       var x = document.createElement('button');
       x.textContent = '\u2573';
       x.onclick = closeAlert2;
       currentAlert.appendChild(x);
       currentAlert.appendChild(document.createElement('span'));
       currentAlert.onmousemove = function () {
         clearTimeout(currentAlertTimeout);
         currentAlert.className = '';
         currentAlertTimeout = setTimeout(closeAlert, 10000);
       }
       document.body.appendChild(currentAlert);
     } else {
       clearTimeout(currentAlertTimeout);
       currentAlert.className = '';
     }
     currentAlert.lastChild.textContent = '';
     currentAlert.lastChild.appendChild(F(s));
     if (href) {
       var link = document.createElement('a');
       link.href = href;
       link.textContent = href;
       currentAlert.lastChild.appendChild(F(' ', link));
     }
     currentAlertTimeout = setTimeout(closeAlert, 10000);
   }
   function closeAlert() {
     clearTimeout(currentAlertTimeout);
     if (currentAlert) {
       currentAlert.className = 'closed';
       currentAlertTimeout = setTimeout(closeAlert2, 3000);
     }
   }
   function closeAlert2() {
     clearTimeout(currentAlertTimeout);
     if (currentAlert) {
       currentAlert.parentNode.removeChild(currentAlert);
       currentAlert = null;
     }
   }
   window.addEventListener('keydown', function (event) {
     if (event.keyCode == 27) {
       if (currentAlert)
         closeAlert2();
     } else {
       closeAlert();
     }
   }, false);
   window.addEventListener('scroll', function (event) {
     closeAlert();
   }, false);
   function load(script) {
     var e = document.createElement('script');
     e.setAttribute('src', '/' + script);
     document.body.appendChild(e);
   }

   var startedInit = 0;
   function init() {
     startedInit = 1;
     if (location.search == '?slow-browser')
       return;
     load('reviewer.js');
     if (document.documentElement.className == "big" || document.documentElement.className == "big split index")
       load('toc.js');
     load('updater.js');
     load('dfn.js');
     load('status.js');
     if (getCookie('profile') == '1')
       document.getElementsByTagName('h2')[0].textContent += '; load: ' + (new Date() - loadTimer) + 'ms';
   }
   if (document.documentElement.className == "")
     setTimeout(function () {
       if (!startedInit)
         showAlert("Too slow? Try reading the multipage copy of the spec instead:", "https://whatwg.org/html");
     }, 6000);

   window.addEventListener('keypress', function (event) {
     if ((event.which == 114) && (event.metaKey)) {
       if (!confirm('Are you sure you want to reload this page?'))
         event.preventDefault();
     }
   }, false);
  </script><script>
   function toggleStatus(div) {
     div.parentNode.classList.toggle('wrapped');
   }
  </script><link rel=stylesheet href=https://whatwg.org/style/specification><link rel=icon href=https://whatwg.org/images/icon><style>
   [hidden] { display: none; }

   .proposal { border: blue solid; padding: 1em; }
   .bad, .bad *:not(.X\58X) { color: gray; border-color: gray; background: transparent; }
   #updatesStatus { display: none; z-index: 10; }
   #updatesStatus.relevant { display: block; position: fixed; right: 1em; top: 1em; padding: 0.5em; font: bold small sans-serif; min-width: 25em; width: 30%; max-width: 40em; height: auto; border: ridge 4px gray; background: #EEEEEE; color: black; }
   div.head .logo { width: 11em; margin-bottom: 20em; }

   #configUI { position: absolute; z-index: 20; top: auto; right: 0; width: 11em; padding: 0 0.5em 0 0.5em; font-size: small; background: gray; background: rgba(32,32,32,0.9); color: white; border-radius: 0.5em 0 0 0.5em; }
   #configUI p { margin: 0.75em 0; padding: 0.3em; }
   #configUI p label { display: block; }
   #configUI #updateUI, #configUI .loginUI { text-align: center; }
   #configUI input[type=button] { display: block; margin: auto; }
   #configUI :link, #configUI :visited { color: white; }
   #configUI :link:hover, #configUI :visited:hover { background: transparent; }

   #alert { position: fixed; top: 20%; left: 20%; right: 20%; font-size: 2em; padding: 0.5em; z-index: 40; background: gray; background: rgba(32,32,32,0.9); color: white; border-radius: 0.5em; transition: opacity 1s linear; }
   #alert.closed { opacity: 0; }
   #alert button { position: absolute; top: -1em; right: 2em; border-radius: 0.5em 0.5em 0 0; border: none; line-height: 0.9; color: white; background: rgb(64,64,64); font-size: 0.6em; font-weight: 900; cursor: pointer; padding: 0.25em; }
   #alert :link, #alert :visited { color: white; text-decoration: underline; }
   #alert :link:hover, #alert :visited:hover { background: transparent; }

   @media print { #configUI, #alert { display: none; } }

   .fingerprint { position: absolute; right: 0; z-index: 5; }

   .status { font: 1em sans-serif; width: 9em; padding: 0.3em; position: absolute; z-index: 8; top: auto; right: 0.3em; background: #EEE; color: black; box-shadow: 0 0 3px #999; overflow: hidden; margin: -2em 0 0 0; border-collapse: initial; border-spacing: initial; }
   .status.wrapped { width: 1em; height: 1em; }
   .status.wrapped > :not(input) { display: none; }
   .status > input { position: absolute; right: 0; top: 0; width: 1em; height: 1em; border: none; background: transparent; padding: 0; margin: 0; }
   .status > p { font-size: 0.6em; margin: 0; padding: 0; }
   .status > p + p { padding-top: 0.5em; }
   .status > .support { display: block; }
   .status > .support > span { padding: 0.2em 0; display: block; display: table; }
   .status > .support > span.partial { color: #666666; filter: grayscale(50%); }
   .status > .support > span.no { color: #CCCCCC; filter: grayscale(100%); }
   .status > .support > span:first-of-type { padding-top: 0.5em; }
   .status > .support > span > span { padding: 0 0.5em; display: table-cell; vertical-align: top; }
   .status > .support > span > span:first-child { width: 100%; }
   .status > .support > span > span:last-child { width: 100%; white-space: pre; padding: 0; }
   .status > .support > span::before { content: ' '; display: table-cell; min-width: 1.5em; height: 1.5em; background: no-repeat center center; background-size: contain; text-align: right; font-size: 0.75em; font-weight: bold; }
   .status > .support > .and_chr::before { background-image: url(https://resources.whatwg.org/browser-logos/chrome-android.png); }
   .status > .support > .and_ff::before { background-image: url(https://resources.whatwg.org/browser-logos/firefox.png); }
   .status > .support > .and_uc::before { background-image: url(https://resources.whatwg.org/browser-logos/uc.png); } /* UC Browser for Android */
   .status > .support > .android::before { background-image: url(https://resources.whatwg.org/browser-logos/android.svg); }
   .status > .support > .bb::before { background-image: url(https://resources.whatwg.org/browser-logos/bb.jpg); } /* Blackberry Browser */
   .status > .support > .chrome::before { background-image: url(https://resources.whatwg.org/browser-logos/chrome.png); }
   .status > .support > .firefox::before { background-image: url(https://resources.whatwg.org/browser-logos/firefox.png); }
   .status > .support > .ie::before { background-image: url(https://resources.whatwg.org/browser-logos/ie.png); }
   .status > .support > .ie_mob::before { background-image: url(https://resources.whatwg.org/browser-logos/ie-mobile.svg); }
   .status > .support > .ios_saf::before { background-image: url(https://resources.whatwg.org/browser-logos/safari-ios.svg); }
   .status > .support > .op_mini::before { background-image: url(https://resources.whatwg.org/browser-logos/opera-mobile.png); }
   .status > .support > .op_mob::before { background-image: url(https://resources.whatwg.org/browser-logos/opera-mobile.png); }
   .status > .support > .opera::before { background-image: url(https://resources.whatwg.org/browser-logos/opera.png); }
   .status > .support > .safari::before { background-image: url(https://resources.whatwg.org/browser-logos/safari.png); }
   .status > .caniuse { text-align: right; font-style: italic; }

   .panel { position: fixed; z-index: 30; top: 10%; left: 0; margin: auto; right: 0; width: 35em; border: double thick; background: #EEEEEE; color: black; padding: 1em; font: 1em sans-serif; max-height: 70%; overflow: auto; }
   .panel h2 { margin: 0; text-align: center; }
   .panel ul { min-height: 6em; }
   .panel p { text-align: right; margin: 0; }
   .panel form { background: transparent; color: black; margin: 0.5em -0.5em 1em; padding: 0.5em; }
   .panel form.changed { background: yellow; color: black; }
   .panel form p { text-align: left; margin: 1em 0 0; }
   .panel form p:first-child { margin-top: 0; }
   .panel form p:last-child { margin-bottom: 0; }
   .panel form p textarea { width: 100% /* need the keyword that makes it fit to the parent here XXX */; min-height: 4em; display: block; }
   .panel form dl { line-height: 1.5em; }
   .panel form dt { display: inline-block; width: 20em; white-space: nowrap; text-align: right; font-weight: normal; margin: 0; padding: 0; }
   .panel form dd { display: inline; margin: 0 0 0 1em; padding: 0; }
   .panel form dd:after { display: block; }
   ul.checkboxes { list-style-type: none; }
   .progress { text-decoration: blink; }

   .applies .yes { background: yellow; }
  </style><style>
   .applies thead th > * { display: block; }
   .applies thead code { display: block; }
   .applies td { text-align: center; }

   .matrix, .matrix td { border: hidden; text-align: right; }
   .matrix { margin-left: 2em; }

   .vertical-summary-table tr > th[rowspan="2"]:first-child + th,
   .vertical-summary-table tr > td[rowspan="2"]:first-child + td { border-bottom: hidden; }

   .dice-example { border-collapse: collapse; border-style: hidden solid solid hidden; border-width: thin; margin-left: 3em; }
   .dice-example caption { width: 30em; font-size: smaller; font-style: italic; padding: 0.75em 0; text-align: left; }
   .dice-example td, .dice-example th { border: solid thin; width: 1.35em; height: 1.05em; text-align: center; padding: 0; }

   td.eg { border-width: thin; text-align: center; }

   #table-example-1 { border: solid thin; border-collapse: collapse; margin-left: 3em; }
   #table-example-1 caption { padding-bottom: 0.5em; }
   #table-example-1 thead, #table-example-1 tbody { border: none; }
   #table-example-1 th, #table-example-1 td { border: solid thin; }
   #table-example-1 th { font-weight: normal; }
   #table-example-1 td { border-style: none solid; vertical-align: top; }
   #table-example-1 th { padding: 0.5em; vertical-align: middle; text-align: center; }
   #table-example-1 tbody tr:first-child td { padding-top: 0.5em; }
   #table-example-1 tbody tr:last-child td { padding-bottom: 1.5em; }
   #table-example-1 tbody td:first-child { padding-left: 2.5em; padding-right: 0; width: 9em; }
   #table-example-1 tbody td:first-child::after { content: leader(". "); }
   #table-example-1 tbody td { padding-left: 2em; padding-right: 2em; }
   #table-example-1 tbody td:first-child + td { width: 10em; }
   #table-example-1 tbody td:first-child + td ~ td { width: 2.5em; }
   #table-example-1 tbody td:first-child + td + td + td ~ td { width: 1.25em; }

   .apple-table-examples { border: none; border-collapse: separate; border-spacing: 1.5em 0em; width: 40em; margin-left: 3em; }
   .apple-table-examples * { font-family: "Times", serif; }
   .apple-table-examples td, .apple-table-examples th { border: none; white-space: nowrap; padding-top: 0; padding-bottom: 0; }
   .apple-table-examples tbody th:first-child { border-left: none; width: 100%; }
   .apple-table-examples thead th:first-child ~ th { font-size: smaller; font-weight: bolder; border-bottom: solid 2px; text-align: center; }
   .apple-table-examples tbody th::after, .apple-table-examples tfoot th::after { content: leader(". ") }
   .apple-table-examples tbody th, .apple-table-examples tfoot th { font: inherit; text-align: left; }
   .apple-table-examples td { text-align: right; vertical-align: top; }
   .apple-table-examples.e1 tbody tr:last-child td { border-bottom: solid 1px; }
   .apple-table-examples.e1 tbody + tbody tr:last-child td { border-bottom: double 3px; }
   .apple-table-examples.e2 th[scope=row] { padding-left: 1em; }
   .apple-table-examples sup { line-height: 0; }

   .three-column-nowrap tr > td:first-child,
   .three-column-nowrap tr > td:first-child + td,
   .three-column-nowrap tr > td:first-child + td + td { white-space: nowrap; }

   .details-example img { vertical-align: top; }

   #base64-table {
     white-space: nowrap;
     font-size: 0.6em;
     column-width: 6em;
     column-count: 5;
     column-gap: 1em;
     -moz-column-width: 6em;
     -moz-column-count: 5;
     -moz-column-gap: 1em;
     -webkit-column-width: 6em;
     -webkit-column-count: 5;
     -webkit-column-gap: 1em;
   }
   #base64-table thead { display: none; }
   #base64-table * { border: none; }
   #base64-table tbody td:first-child:after { content: ':'; }
   #base64-table tbody td:last-child { text-align: right; }

   #named-character-references-table {
     white-space: nowrap;
     font-size: 0.6em;
     column-width: 30em;
     column-gap: 1em;
     -moz-column-width: 30em;
     -moz-column-gap: 1em;
     -webkit-column-width: 30em;
     -webkit-column-gap: 1em;
   }
   #named-character-references-table > table > tbody > tr > td:first-child + td,
   #named-character-references-table > table > tbody > tr > td:last-child { text-align: center; }
   #named-character-references-table > table > tbody > tr > td:last-child:hover > span { position: absolute; top: auto; left: auto; margin-left: 0.5em; line-height: 1.2; font-size: 5em; border: outset; padding: 0.25em 0.5em; background: white; width: 1.25em; height: auto; text-align: center; }
   #named-character-references-table > table > tbody > tr#entity-CounterClockwiseContourIntegral > td:first-child { font-size: 0.5em; }

   .glyph.control { color: red; }
  </style><style>
   #table-example-1 * { font-family: "Essays1743", serif; line-height: 1.01em; }
   @font-face {
     font-family: 'Essays1743';
     src: url('/fonts/Essays1743.ttf');
   }
   @font-face {
     font-family: 'Essays1743';
     font-weight: bold;
     src: url('/fonts/Essays1743-Bold.ttf');
   }
   @font-face {
     font-family: 'Essays1743';
     font-style: italic;
     src: url('/fonts/Essays1743-Italic.ttf');
   }
   @font-face {
     font-family: 'Essays1743';
     font-style: italic;
     font-weight: bold;
     src: url('/fonts/Essays1743-BoldItalic.ttf');
   }
  </style><script src=link-fixup.js></script><body onload=init()>
  <header id=head class="head with-buttons">
   <p><a href=https://whatwg.org/ class=logo><img alt=WHATWG src=//whatwg.org/images/logo width=101 height=101></a></p>
   <hgroup><h1 class=allcaps>HTML</h1><h2 id=living-standard class="no-num no-toc">Living Standard — Last Updated <span class=pubdate>21 July 2015</span></h2></hgroup>
   
   
  </header>

  

  

  
  

  
  

  

  <nav><a href=webappapis.html>← 8 Web application APIs</a> — <a href=index.html>Table of Contents</a> — <a href=workers.html>10 Web workers →</a></nav><ol class=toc><li id=toc-comms><a href=comms.html#comms>9 Communication</a><ol><li><a href=comms.html#the-messageevent-interfaces>9.1 The <code>MessageEvent</code> interfaces</a><li><a href=comms.html#server-sent-events>9.2 Server-sent events</a><ol><li><a href=comms.html#server-sent-events-intro>9.2.1 Introduction</a><li><a href=comms.html#the-eventsource-interface>9.2.2 The <code>EventSource</code> interface</a><li><a href=comms.html#processing-model-10>9.2.3 Processing model</a><li><a href=comms.html#parsing-an-event-stream>9.2.4 Parsing an event stream</a><li><a href=comms.html#event-stream-interpretation>9.2.5 Interpreting an event stream</a><li><a href=comms.html#authoring-notes>9.2.6 Authoring notes</a><li><a href=comms.html#eventsource-push>9.2.7 Connectionless push and other features</a><li><a href=comms.html#garbage-collection-2>9.2.8 Garbage collection</a><li><a href=comms.html#implementation-advice>9.2.9 Implementation advice</a><li><a href=comms.html#iana-considerations>9.2.10 IANA considerations</a><ol><li><a href=comms.html#text/event-stream>9.2.10.1 <code>text/event-stream</code></a><li><a href=comms.html#last-event-id>9.2.10.2 <code>Last-Event-ID</code></a></ol></ol><li><a href=comms.html#network>9.3 Web sockets</a><ol><li><a href=comms.html#network-intro>9.3.1 Introduction</a><li><a href=comms.html#the-websocket-interface>9.3.2 The <code>WebSocket</code> interface</a><li><a href=comms.html#feedback-from-the-protocol>9.3.3 Feedback from the protocol</a><li><a href=comms.html#ping-and-pong-frames>9.3.4 Ping and Pong frames</a><li><a href=comms.html#parsing-websocket-urls>9.3.5 Parsing WebSocket URLs</a><li><a href=comms.html#the-closeevent-interfaces>9.3.6 The <code>CloseEvent</code> interfaces</a><li><a href=comms.html#garbage-collection-3>9.3.7 Garbage collection</a></ol><li><a href=comms.html#web-messaging>9.4 Cross-document messaging</a><ol><li><a href=comms.html#introduction-12>9.4.1 Introduction</a><li><a href=comms.html#security-postmsg>9.4.2 Security</a><ol><li><a href=comms.html#authors>9.4.2.1 Authors</a><li><a href=comms.html#user-agents>9.4.2.2 User agents</a></ol><li><a href=comms.html#posting-messages>9.4.3 Posting messages</a></ol><li><a href=comms.html#channel-messaging>9.5 Channel messaging</a><ol><li><a href=comms.html#introduction-13>9.5.1 Introduction</a><ol><li><a href=comms.html#examples-5>9.5.1.1 Examples</a><li><a href=comms.html#ports-as-the-basis-of-an-object-capability-model-on-the-web>9.5.1.2 Ports as the basis of an object-capability model on the Web</a><li><a href=comms.html#ports-as-the-basis-of-abstracting-out-service-implementations>9.5.1.3 Ports as the basis of abstracting out service implementations</a></ol><li><a href=comms.html#message-channels>9.5.2 Message channels</a><li><a href=comms.html#message-ports>9.5.3 Message ports</a><li><a href=comms.html#broadcasting-to-many-ports>9.5.4 Broadcasting to many ports</a><li><a href=comms.html#ports-and-garbage-collection>9.5.5 Ports and garbage collection</a></ol><li><a href=comms.html#broadcasting-to-other-browsing-contexts>9.6 Broadcasting to other browsing contexts</a></ol></ol><h2 id=comms>9 Communication</h2>

  <h3 id=the-messageevent-interfaces>9.1 The <code id=the-messageevent-interfaces:messageevent><a href=#messageevent>MessageEvent</a></code> interfaces</h3>

  <p>Messages in <a href=#server-sent-events id=the-messageevent-interfaces:server-sent-events>server-sent events</a>, <a href=#network id=the-messageevent-interfaces:network>Web sockets</a>, <a href=#web-messaging id=the-messageevent-interfaces:web-messaging>cross-document
  messaging</a>, <a href=#channel-messaging id=the-messageevent-interfaces:channel-messaging>channel messaging</a>, and <a href=#broadcasting-to-other-browsing-contexts id=the-messageevent-interfaces:broadcasting-to-other-browsing-contexts>broadcast channels</a> use the
  <code id=the-messageevent-interfaces:messageevent-2><a href=#messageevent>MessageEvent</a></code> interface for their <code id=the-messageevent-interfaces:event-message><a href=indices.html#event-message>message</a></code>
  events:</p>

  <pre class=idl>[Constructor(DOMString type, optional <a href=#messageeventinit id=the-messageevent-interfaces:messageeventinit>MessageEventInit</a> eventInitDict), Exposed=(Window,Worker)]
interface <dfn id=messageevent>MessageEvent</dfn> : <a id=the-messageevent-interfaces:event href=infrastructure.html#event>Event</a> {
  readonly attribute any <a href=#dom-messageevent-data id=the-messageevent-interfaces:dom-messageevent-data>data</a>;
  readonly attribute DOMString <a href=#dom-messageevent-origin id=the-messageevent-interfaces:dom-messageevent-origin>origin</a>;
  readonly attribute DOMString <a href=#dom-messageevent-lasteventid id=the-messageevent-interfaces:dom-messageevent-lasteventid>lastEventId</a>;
  readonly attribute (<a id=the-messageevent-interfaces:windowproxy href=browsers.html#windowproxy>WindowProxy</a> or <a href=#messageport id=the-messageevent-interfaces:messageport>MessagePort</a>)? <a href=#dom-messageevent-source id=the-messageevent-interfaces:dom-messageevent-source>source</a>;
  readonly attribute <a href=#messageport id=the-messageevent-interfaces:messageport-2>MessagePort</a>[]? <a href=#dom-messageevent-ports id=the-messageevent-interfaces:dom-messageevent-ports>ports</a>;

  void <a href=#dom-messageevent-initmessageevent id=the-messageevent-interfaces:dom-messageevent-initmessageevent>initMessageEvent</a>(DOMString typeArg, boolean canBubbleArg, boolean cancelableArg, any dataArg, DOMString originArg, DOMString lastEventIdArg, (<a id=the-messageevent-interfaces:windowproxy-2 href=browsers.html#windowproxy>WindowProxy</a> or <a href=#messageport id=the-messageevent-interfaces:messageport-3>MessagePort</a>) sourceArg, sequence&lt;<a href=#messageport id=the-messageevent-interfaces:messageport-4>MessagePort</a>>? portsArg);
};

dictionary <dfn id=messageeventinit>MessageEventInit</dfn> : <a id=the-messageevent-interfaces:eventinit href=infrastructure.html#eventinit>EventInit</a> {
  any data;
  DOMString origin;
  DOMString lastEventId;
  (<a id=the-messageevent-interfaces:windowproxy-3 href=browsers.html#windowproxy>WindowProxy</a> or <a href=#messageport id=the-messageevent-interfaces:messageport-5>MessagePort</a>)? source;
  sequence&lt;<a href=#messageport id=the-messageevent-interfaces:messageport-6>MessagePort</a>> ports;
};</pre>

  <dl class=domintro><dt><var>event</var> . <code id=the-messageevent-interfaces:dom-messageevent-data-2><a href=#dom-messageevent-data>data</a></code><dd>

    <p>Returns the data of the message.</p>

   <dt><var>event</var> . <code id=the-messageevent-interfaces:dom-messageevent-origin-2><a href=#dom-messageevent-origin>origin</a></code><dd>

    <p>Returns the origin of the message, for <a href=#server-sent-events id=the-messageevent-interfaces:server-sent-events-2>server-sent events</a> and
    <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-2>cross-document messaging</a>.</p>

   <dt><var>event</var> . <code id=the-messageevent-interfaces:dom-messageevent-lasteventid-2><a href=#dom-messageevent-lasteventid>lastEventId</a></code><dd>

    <p>Returns the <a href=#concept-event-stream-last-event-id id=the-messageevent-interfaces:concept-event-stream-last-event-id>last event ID string</a>, for
    <a href=#server-sent-events id=the-messageevent-interfaces:server-sent-events-3>server-sent events</a>.</p>

   <dt><var>event</var> . <code id=the-messageevent-interfaces:dom-messageevent-source-2><a href=#dom-messageevent-source>source</a></code><dd>

    <p>Returns the <code id=the-messageevent-interfaces:windowproxy-4><a href=browsers.html#windowproxy>WindowProxy</a></code> of the source window, for <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-3>cross-document
    messaging</a>, and the <code id=the-messageevent-interfaces:messageport-7><a href=#messageport>MessagePort</a></code> being attached, in the <code id=the-messageevent-interfaces:event-workerglobalscope-connect><a href=indices.html#event-workerglobalscope-connect>connect</a></code> event fired at
    <code id=the-messageevent-interfaces:sharedworkerglobalscope><a href=workers.html#sharedworkerglobalscope>SharedWorkerGlobalScope</a></code> objects.</p>

   <dt><var>event</var> . <code id=the-messageevent-interfaces:dom-messageevent-ports-2><a href=#dom-messageevent-ports>ports</a></code><dd>

    <p>Returns the <code id=the-messageevent-interfaces:messageport-8><a href=#messageport>MessagePort</a></code> array sent with the message, for <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-4>cross-document
    messaging</a> and <a href=#channel-messaging id=the-messageevent-interfaces:channel-messaging-2>channel messaging</a>.</p>

   </dl>

  

  <p>The <dfn id=dom-messageevent-data><code>data</code></dfn> attribute must return the value
  it was initialised to. When the object is created, this attribute must be initialised to null. It
  represents the message being sent.</p>

  <p>The <dfn id=dom-messageevent-origin><code>origin</code></dfn> attribute must return the
  value it was initialised to. When the object is created, this attribute must be initialised to the
  empty string. It represents, in <a href=#server-sent-events id=the-messageevent-interfaces:server-sent-events-4>server-sent events</a> and <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-5>cross-document
  messaging</a>, the <a id=the-messageevent-interfaces:origin-2 href=browsers.html#origin-2>origin</a> of the document that sent the message (typically the
  scheme, hostname, and port of the document, but not its path or fragment identifier).</p>

  <p>The <dfn id=dom-messageevent-lasteventid><code>lastEventId</code></dfn> attribute must
  return the value it was initialised to. When the object is created, this attribute must be
  initialised to the empty string. It represents, in <a href=#server-sent-events id=the-messageevent-interfaces:server-sent-events-5>server-sent events</a>, the <a href=#concept-event-stream-last-event-id id=the-messageevent-interfaces:concept-event-stream-last-event-id-2>last event ID string</a> of the event source.</p>

  <p>The <dfn id=dom-messageevent-source><code>source</code></dfn> attribute must return the
  value it was initialised to. When the object is created, this attribute must be initialised to
  null. It represents, in <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-6>cross-document messaging</a>, the <code id=the-messageevent-interfaces:windowproxy-5><a href=browsers.html#windowproxy>WindowProxy</a></code> of the
  <a id=the-messageevent-interfaces:browsing-context href=browsers.html#browsing-context>browsing context</a> of the <code id=the-messageevent-interfaces:window><a href=browsers.html#window>Window</a></code> object from which the message came; and
  in the <code id=the-messageevent-interfaces:event-workerglobalscope-connect-2><a href=indices.html#event-workerglobalscope-connect>connect</a></code> events used by <a href=workers.html#sharedworkerglobalscope id=the-messageevent-interfaces:sharedworkerglobalscope-2>shared workers</a>, the newly connecting
  <code id=the-messageevent-interfaces:messageport-9><a href=#messageport>MessagePort</a></code>.</p>

  <p>The <dfn id=dom-messageevent-ports><code>ports</code></dfn> attribute must return the
  value it was initialised to. When the object is created, this attribute must be initialised to
  null. It represents, in
  <a href=#web-messaging id=the-messageevent-interfaces:web-messaging-7>cross-document messaging</a> and <a href=#channel-messaging id=the-messageevent-interfaces:channel-messaging-3>channel messaging</a>, the
  <code id=the-messageevent-interfaces:messageport-10><a href=#messageport>MessagePort</a></code> array being sent, if any.</p>

  
  <p>The <dfn id=dom-messageevent-initmessageevent><code>initMessageEvent()</code></dfn>
  method must initialise the event in a manner analogous to the similarly-named <code id=the-messageevent-interfaces:dom-event-initevent><a href=infrastructure.html#dom-event-initevent>initEvent()</a></code> method. <a href=references.html#refsDOM>[DOM]</a></p>

  


  <h3 id=server-sent-events>9.2 <dfn>Server-sent events</dfn></h3>

  <h4 id=server-sent-events-intro>9.2.1 Introduction</h4>

  <p><i>This section is non-normative.</i></p>

  <p>To enable servers to push data to Web pages over HTTP or using dedicated server-push protocols,
  this specification introduces the <code id=server-sent-events-intro:eventsource><a href=#eventsource>EventSource</a></code> interface.</p>

  <p>Using this API consists of creating an <code id=server-sent-events-intro:eventsource-2><a href=#eventsource>EventSource</a></code> object and registering an event
  listener.</p>

  <pre>var source = new EventSource('updates.cgi');
source.onmessage = function (event) {
  alert(event.data);
};</pre>

  <p>On the server-side, the script ("<code>updates.cgi</code>" in this case) sends
  messages in the following form, with the <code id=server-sent-events-intro:text/event-stream><a href=#text/event-stream>text/event-stream</a></code> MIME type:</p>

  <pre>data: This is the first message.

data: This is the second message, it
data: has two lines.

data: This is the third message.</pre>

  <hr>

  <p>Authors can separate events by using different event types. Here is a stream that has two event
  types, "add" and "remove":</p>

  <pre>event: add
data: 73857293

event: remove
data: 2153

event: add
data: 113411</pre>

  <p>The script to handle such a stream would look like this (where <code>addHandler</code>
  and <code>removeHandler</code> are functions that take one argument, the event):</p>

  <pre>var source = new EventSource('updates.cgi');
source.addEventListener('add', addHandler, false);
source.addEventListener('remove', removeHandler, false);</pre>

  <p>The default event type is "message".</p>

  <p>Event streams are always decoded as UTF-8. There is no way to specify another character
  encoding.</p>

  <hr>

  <p>Event stream requests can be redirected using HTTP 301 and 307 redirects as with normal HTTP
  requests. Clients will reconnect if the connection is closed; a client can be told to stop
  reconnecting using the HTTP 204 No Content response code.</p>

  <p>Using this API rather than emulating it using <code id=server-sent-events-intro:xmlhttprequest><a href=infrastructure.html#xmlhttprequest>XMLHttpRequest</a></code> or an
  <code id=server-sent-events-intro:the-iframe-element><a href=embedded-content.html#the-iframe-element>iframe</a></code> allows the user agent to make better use of network resources in cases where
  the user agent implementor and the network operator are able to coordinate in advance. Amongst
  other benefits, this can result in significant savings in battery life on portable devices. This
  is discussed further in the section below on <a href=#eventsource-push>connectionless
  push</a>.</p>


  <h4 id=the-eventsource-interface>9.2.2 The <code id=the-eventsource-interface:eventsource><a href=#eventsource>EventSource</a></code> interface</h4>

  <pre class=idl>[<a href=#dom-eventsource id=the-eventsource-interface:dom-eventsource>Constructor</a>(DOMString url, optional <a href=#eventsourceinit id=the-eventsource-interface:eventsourceinit>EventSourceInit</a> eventSourceInitDict), Exposed=(Window,Worker)]
interface <dfn id=eventsource>EventSource</dfn> : <a id=the-eventsource-interface:eventtarget href=infrastructure.html#eventtarget>EventTarget</a> {
  readonly attribute DOMString <a href=#dom-eventsource-url id=the-eventsource-interface:dom-eventsource-url>url</a>;
  readonly attribute boolean <a href=#dom-eventsource-withcredentials id=the-eventsource-interface:dom-eventsource-withcredentials>withCredentials</a>;

  // ready state
  const unsigned short <a href=#dom-eventsource-connecting id=the-eventsource-interface:dom-eventsource-connecting>CONNECTING</a> = 0;
  const unsigned short <a href=#dom-eventsource-open id=the-eventsource-interface:dom-eventsource-open>OPEN</a> = 1;
  const unsigned short <a href=#dom-eventsource-closed id=the-eventsource-interface:dom-eventsource-closed>CLOSED</a> = 2;
  readonly attribute unsigned short <a href=#dom-eventsource-readystate id=the-eventsource-interface:dom-eventsource-readystate>readyState</a>;

  // networking
  attribute <a id=the-eventsource-interface:eventhandler href=webappapis.html#eventhandler>EventHandler</a> <a href=#handler-eventsource-onopen id=the-eventsource-interface:handler-eventsource-onopen>onopen</a>;
  attribute <a id=the-eventsource-interface:eventhandler-2 href=webappapis.html#eventhandler>EventHandler</a> <a href=#handler-eventsource-onmessage id=the-eventsource-interface:handler-eventsource-onmessage>onmessage</a>;
  attribute <a id=the-eventsource-interface:eventhandler-3 href=webappapis.html#eventhandler>EventHandler</a> <a href=#handler-eventsource-onerror id=the-eventsource-interface:handler-eventsource-onerror>onerror</a>;
  void <a href=#dom-eventsource-close id=the-eventsource-interface:dom-eventsource-close>close</a>();
};

dictionary <dfn id=eventsourceinit>EventSourceInit</dfn> {
  boolean <dfn id=dom-eventsourceinit-withcredentials>withCredentials</dfn> = false;
};</pre>

  <p>The <dfn id=dom-eventsource><code>EventSource()</code></dfn> constructor takes one or two
  arguments. The first specifies the <a id=the-eventsource-interface:url href=infrastructure.html#url>URL</a> to which to connect. The second specifies the
  settings, if any, in the form of an <code id=the-eventsource-interface:eventsourceinit-2><a href=#eventsourceinit>EventSourceInit</a></code> dictionary. When the <code id=the-eventsource-interface:dom-eventsource-2><a href=#dom-eventsource>EventSource()</a></code> constructor is invoked, the UA must run these
  steps:</p>

  <ol><li><p><a href=infrastructure.html#resolve-a-url id=the-eventsource-interface:resolve-a-url>Resolve</a> the <a id=the-eventsource-interface:url-2 href=infrastructure.html#url>URL</a> specified in the first
   argument, relative to the <a id=the-eventsource-interface:api-base-url href=webappapis.html#api-base-url>API base URL</a> specified by the <a id=the-eventsource-interface:entry-settings-object href=webappapis.html#entry-settings-object>entry settings
   object</a>.<li><p>If the previous step failed, then throw a <code id=the-eventsource-interface:syntaxerror><a href=infrastructure.html#syntaxerror>SyntaxError</a></code> exception and abort
   these steps.<li><p>Create a new <code id=the-eventsource-interface:eventsource-2><a href=#eventsource>EventSource</a></code> object.<li><p>Let <var>CORS mode</var> be <a href=infrastructure.html#attr-crossorigin-anonymous id=the-eventsource-interface:attr-crossorigin-anonymous>Anonymous</a>.<li><p>If the second argument is present, and the <code id=the-eventsource-interface:dom-eventsourceinit-withcredentials><a href=#dom-eventsourceinit-withcredentials>withCredentials</a></code> dictionary member has the
   value true, then set <var>CORS mode</var> to <a href=infrastructure.html#attr-crossorigin-use-credentials id=the-eventsource-interface:attr-crossorigin-use-credentials>Use Credentials</a> and initialise the new
   <code id=the-eventsource-interface:eventsource-3><a href=#eventsource>EventSource</a></code> object's <code id=the-eventsource-interface:dom-eventsource-withcredentials-2><a href=#dom-eventsource-withcredentials>withCredentials</a></code> attribute to true.<li><p>Return the new <code id=the-eventsource-interface:eventsource-4><a href=#eventsource>EventSource</a></code> object, but continue these steps
   <a id=the-eventsource-interface:in-parallel href=infrastructure.html#in-parallel>in parallel</a>.<li>

    <p>Do a <a id=the-eventsource-interface:potentially-cors-enabled-fetch href=infrastructure.html#potentially-cors-enabled-fetch>potentially CORS-enabled fetch</a> of the resulting <a id=the-eventsource-interface:absolute-url href=infrastructure.html#absolute-url>absolute
    URL</a> using the <a id=the-eventsource-interface:referrer-source href=webappapis.html#referrer-source>referrer source</a> specified by the <a id=the-eventsource-interface:entry-settings-object-2 href=webappapis.html#entry-settings-object>entry settings
    object</a>, with the <i>mode</i> being <var>CORS mode</var>, and the <i>origin</i> being the <a id=the-eventsource-interface:origin-2 href=browsers.html#origin-2>origin</a> specified by the <a id=the-eventsource-interface:entry-settings-object-3 href=webappapis.html#entry-settings-object>entry settings
    object</a>, and process the resource obtained in
    this fashion, if any, as described below.</p>

    <p class=note>The definition of the <a href=infrastructure.html#fetch id=the-eventsource-interface:fetch>fetching</a> algorithm (which is
    used by CORS) is such that if the browser is already fetching the resource identified by the
    given <a id=the-eventsource-interface:absolute-url-2 href=infrastructure.html#absolute-url>absolute URL</a>, that connection can be reused, instead of a new connection
    being established. All messages received up to this point are dispatched immediately, in this
    case.</p>

   </ol>

  <hr>

  <p>The <dfn id=dom-eventsource-url><code>url</code></dfn> attribute must return the
  <a id=the-eventsource-interface:absolute-url-3 href=infrastructure.html#absolute-url>absolute URL</a> that resulted from <a href=infrastructure.html#resolve-a-url id=the-eventsource-interface:resolve-a-url-2>resolving</a> the
  value that was passed to the constructor.</p> 

  <p>The <dfn id=dom-eventsource-withcredentials><code>withCredentials</code></dfn> attribute
  must return the value to which it was last initialised. When the object is created, it must be
  initialised to false.</p>

  <p>The <dfn id=dom-eventsource-readystate><code>readyState</code></dfn> attribute represents
  the state of the connection. It can have the following values:</p>

  <dl><dt><dfn id=dom-eventsource-connecting><code>CONNECTING</code></dfn> (numeric value 0)<dd>The connection has not yet been established, or it was closed and the user agent is
   reconnecting.<dt><dfn id=dom-eventsource-open><code>OPEN</code></dfn> (numeric value 1)<dd>The user agent has an open connection and is dispatching events as it receives them.<dt><dfn id=dom-eventsource-closed><code>CLOSED</code></dfn> (numeric value 2)<dd>The connection is not open, and the user agent is not trying to reconnect. Either there was a
   fatal error or the <code id=the-eventsource-interface:dom-eventsource-close-2><a href=#dom-eventsource-close>close()</a></code> method was invoked.</dl>

  <p>When the object is created its <code id=the-eventsource-interface:dom-eventsource-readystate-2><a href=#dom-eventsource-readystate>readyState</a></code> must
  be set to <code id=the-eventsource-interface:dom-eventsource-connecting-2><a href=#dom-eventsource-connecting>CONNECTING</a></code> (0). The rules given below
  for handling the connection define when the value changes.</p>

  <p>The <dfn id=dom-eventsource-close><code>close()</code></dfn> method must abort any
  instances of the <a id=the-eventsource-interface:fetch-2 href=infrastructure.html#fetch>fetch</a> algorithm started for this <code id=the-eventsource-interface:eventsource-5><a href=#eventsource>EventSource</a></code> object,
  and must set the <code id=the-eventsource-interface:dom-eventsource-readystate-3><a href=#dom-eventsource-readystate>readyState</a></code> attribute to <code id=the-eventsource-interface:dom-eventsource-closed-2><a href=#dom-eventsource-closed>CLOSED</a></code>.</p> 

  <p>The following are the <a id=the-eventsource-interface:event-handlers href=webappapis.html#event-handlers>event handlers</a> (and their corresponding <a href=webappapis.html#event-handler-event-type id=the-eventsource-interface:event-handler-event-type>event handler event types</a>) that must be supported, as <a id=the-eventsource-interface:event-handler-idl-attributes href=webappapis.html#event-handler-idl-attributes>event
  handler IDL attributes</a>, by all objects implementing the <code id=the-eventsource-interface:eventsource-6><a href=#eventsource>EventSource</a></code>
  interface:</p>

  <table><thead><tr><th><a href=webappapis.html#event-handlers id=the-eventsource-interface:event-handlers-2>Event handler</a> <th><a id=the-eventsource-interface:event-handler-event-type-2 href=webappapis.html#event-handler-event-type>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-eventsource-onopen><code>onopen</code></dfn> <td> <code id=the-eventsource-interface:event-open><a href=indices.html#event-open>open</a></code>
    <tr><td><dfn id=handler-eventsource-onmessage><code>onmessage</code></dfn> <td> <code id=the-eventsource-interface:event-message><a href=indices.html#event-message>message</a></code>
    <tr><td><dfn id=handler-eventsource-onerror><code>onerror</code></dfn> <td> <code id=the-eventsource-interface:event-error><a href=indices.html#event-error>error</a></code>
  </table>

  <hr>

  <p>In addition to the above, each <code id=the-eventsource-interface:eventsource-7><a href=#eventsource>EventSource</a></code> object has the following associated
  with it:</p>

  <ul><li>A <dfn id=concept-event-stream-reconnection-time>reconnection time</dfn>, in
   milliseconds. This must initially be a user-agent-defined value, probably in the region of a few
   seconds.<li>A <dfn id=concept-event-stream-last-event-id>last event ID string</dfn>. This must
   initially be the empty string.</ul>

  <p>These values are not currently exposed on the interface.</p>


  <h4 id=processing-model-10>9.2.3 Processing model</h4>

  <p>The resource indicated in the argument to the <code id=processing-model-10:dom-eventsource><a href=#dom-eventsource>EventSource</a></code>
  constructor is <a href=infrastructure.html#fetch id=processing-model-10:fetch>fetched</a> when the constructor is run.</p>

  <p>For HTTP connections, the <code id=processing-model-10:http-accept><a href=infrastructure.html#http-accept>Accept</a></code> header may be included; if
  included, it must contain only formats of event framing that are supported by the user agent (one
  of which must be <code id=processing-model-10:text/event-stream><a href=#text/event-stream>text/event-stream</a></code>, as described below).</p>

  <p>If the event source's <a href=#concept-event-stream-last-event-id id=processing-model-10:concept-event-stream-last-event-id>last event ID
  string</a> is not the empty string, then a <code id=processing-model-10:last-event-id><a href=#last-event-id>Last-Event-ID</a></code> HTTP header must be included with the request,
  whose value is the value of the event source's <a href=#concept-event-stream-last-event-id id=processing-model-10:concept-event-stream-last-event-id-2>last event ID string</a>, encoded as UTF-8.</p>

  <p>User agents should use the <code id=processing-model-10:http-cache-control><a href=infrastructure.html#http-cache-control>Cache-Control: no-cache</a></code>
  header in requests to bypass any caches for requests of event sources. (This header is not a <a href=infrastructure.html#custom-request-headers id=processing-model-10:custom-request-headers>custom request header</a>, so the user agent will still use the
  CORS <a id=processing-model-10:simple-cross-origin-request href=infrastructure.html#simple-cross-origin-request>simple cross-origin request</a> mechanism.) User agents should ignore HTTP cache
  headers in the response, never caching event sources.</p>

  <hr>

  <p>As data is received, the <a href=webappapis.html#concept-task id=processing-model-10:concept-task>tasks</a> queued by the <a id=processing-model-10:networking-task-source href=webappapis.html#networking-task-source>networking
  task source</a> to handle the data must act as follows.</p>

  <p>HTTP 200 OK responses with a <a id=processing-model-10:content-type href=infrastructure.html#content-type>Content-Type</a> header specifying the type
  <code id=processing-model-10:text/event-stream-2><a href=#text/event-stream>text/event-stream</a></code>, ignoring any <a id=processing-model-10:mime-type href=infrastructure.html#mime-type>MIME type</a> parameters, must be processed
  line by line <a href=#event-stream-interpretation>as described below</a>.</p>

  <p>When a successful response with a supported <a id=processing-model-10:mime-type-2 href=infrastructure.html#mime-type>MIME type</a> is received, such that the
  user agent begins parsing the contents of the stream, the user agent must <a href=#announce-the-connection id=processing-model-10:announce-the-connection>announce the
  connection</a>.</p>

  <p>The <a href=webappapis.html#concept-task id=processing-model-10:concept-task-2>task</a> that the <a id=processing-model-10:networking-task-source-2 href=webappapis.html#networking-task-source>networking task source</a> places
  on the <a id=processing-model-10:task-queue href=webappapis.html#task-queue>task queue</a> once the <a href=infrastructure.html#fetch id=processing-model-10:fetch-2>fetching algorithm</a> for such a
  resource (with the correct <a id=processing-model-10:mime-type-3 href=infrastructure.html#mime-type>MIME type</a>) has completed must cause the user agent to
  <a href=#reestablish-the-connection id=processing-model-10:reestablish-the-connection>reestablish the connection</a> <a id=processing-model-10:in-parallel href=infrastructure.html#in-parallel>in parallel</a>. This applies whether the connection is
  closed gracefully or unexpectedly (but does not apply when the <a id=processing-model-10:fetch-3 href=infrastructure.html#fetch>fetch</a> algorithm is
  canceled by the user agent, e.g. in response to <code id=processing-model-10:dom-window-stop><a href=browsers.html#dom-window-stop>window.stop()</a></code>,
  since in those cases the final <a href=webappapis.html#concept-task id=processing-model-10:concept-task-3>task</a> is actually discarded).
  It doesn't apply for the error conditions listed below except
  where explicitly specified.</p>

  <p>HTTP 200 OK responses that have a <a id=processing-model-10:content-type-2 href=infrastructure.html#content-type>Content-Type</a> specifying an unsupported type, or
  that have no <a id=processing-model-10:content-type-3 href=infrastructure.html#content-type>Content-Type</a> at all, must cause the user agent to <a href=#fail-the-connection id=processing-model-10:fail-the-connection>fail the
  connection</a>.</p> 

  <p>HTTP 305 Use Proxy, 401 Unauthorized, and 407 Proxy Authentication Required should be treated
  transparently as for any other subresource.</p>

  <p>HTTP 301 Moved Permanently, 302 Found, 303 See Other, and 307 Temporary Redirect responses are
  handled by the <a href=infrastructure.html#fetch id=processing-model-10:fetch-4>fetching</a> and CORS algorithms. In the case of 301
  redirects, the user agent must also remember the new URL so that subsequent requests for this
  resource for this <code id=processing-model-10:eventsource><a href=#eventsource>EventSource</a></code> object start with the URL given for the last 301 seen
  for requests for this object.</p>

  <p id=event-source-network-errors-reconnect>Network errors that prevents the connection from
  being established in the first place (e.g. DNS errors), must cause the user agent to
  <a href=#reestablish-the-connection id=processing-model-10:reestablish-the-connection-2>reestablish the connection</a> <a id=processing-model-10:in-parallel-2 href=infrastructure.html#in-parallel>in parallel</a>.</p>

  <p id=event-source-fail-reasons>Any other HTTP response code not listed here, as well as the
  cancelation of the <a id=processing-model-10:fetch-5 href=infrastructure.html#fetch>fetch</a> algorithm by the user agent (e.g. in response to <code id=processing-model-10:dom-window-stop-2><a href=browsers.html#dom-window-stop>window.stop()</a></code> or the user canceling the network connection
  manually) must cause the user agent to <a href=#fail-the-connection id=processing-model-10:fail-the-connection-2>fail the connection</a>.</p>  

  <p>For non-HTTP protocols, UAs should act in equivalent ways.</p>

  <hr>

  <p>When a user agent is to <dfn id=announce-the-connection>announce the connection</dfn>, the user agent must <a id=processing-model-10:queue-a-task href=webappapis.html#queue-a-task>queue a
  task</a> which, if the <code id=processing-model-10:dom-eventsource-readystate><a href=#dom-eventsource-readystate>readyState</a></code> attribute is
  set to a value other than <code id=processing-model-10:dom-eventsource-closed><a href=#dom-eventsource-closed>CLOSED</a></code>, sets the <code id=processing-model-10:dom-eventsource-readystate-2><a href=#dom-eventsource-readystate>readyState</a></code> attribute to <code id=processing-model-10:dom-eventsource-open><a href=#dom-eventsource-open>OPEN</a></code> and <a href=webappapis.html#fire-a-simple-event id=processing-model-10:fire-a-simple-event>fires a simple
  event</a> named <code id=processing-model-10:event-open><a href=indices.html#event-open>open</a></code> at the <code id=processing-model-10:eventsource-2><a href=#eventsource>EventSource</a></code>
  object.</p>

  <p>When a user agent is to <dfn id=reestablish-the-connection>reestablish the connection</dfn>, the user agent must run the
  following steps. These steps are run <a id=processing-model-10:in-parallel-3 href=infrastructure.html#in-parallel>in parallel</a>, not as part of a <a href=webappapis.html#concept-task id=processing-model-10:concept-task-4>task</a>. (The tasks that it queues, of course, are run like normal tasks
  and not themselves <a id=processing-model-10:in-parallel-4 href=infrastructure.html#in-parallel>in parallel</a>.)</p>

  <ol><li>

    <p><a id=processing-model-10:queue-a-task-2 href=webappapis.html#queue-a-task>Queue a task</a> to run the following steps:</p>

    <ol><li><p>If the <code id=processing-model-10:dom-eventsource-readystate-3><a href=#dom-eventsource-readystate>readyState</a></code> attribute is set to
     <code id=processing-model-10:dom-eventsource-closed-2><a href=#dom-eventsource-closed>CLOSED</a></code>, abort the task.<li><p>Set the <code id=processing-model-10:dom-eventsource-readystate-4><a href=#dom-eventsource-readystate>readyState</a></code> attribute to <code id=processing-model-10:dom-eventsource-connecting><a href=#dom-eventsource-connecting>CONNECTING</a></code>.<li><p><a id=processing-model-10:fire-a-simple-event-2 href=webappapis.html#fire-a-simple-event>Fire a simple event</a> named <code id=processing-model-10:event-error><a href=indices.html#event-error>error</a></code> at the
     <code id=processing-model-10:eventsource-3><a href=#eventsource>EventSource</a></code> object.</ol>

   <li><p>Wait a delay equal to the reconnection time of the event source.<li><p>Optionally, wait some more. In particular, if the previous attempt failed, then user
   agents might introduce an exponential backoff delay to avoid overloading a potentially already
   overloaded server. Alternatively, if the operating system has reported that there is no network
   connectivity, user agents might wait for the operating system to announce that the network
   connection has returned before retrying.<li><p>Wait until the aforementioned task has run, if it has not yet run.<li>

    <p><a id=processing-model-10:queue-a-task-3 href=webappapis.html#queue-a-task>Queue a task</a> to run the following steps:</p>

    <ol><li><p>If the <code id=processing-model-10:dom-eventsource-readystate-5><a href=#dom-eventsource-readystate>readyState</a></code> attribute is not set
     to <code id=processing-model-10:dom-eventsource-connecting-2><a href=#dom-eventsource-connecting>CONNECTING</a></code>, abort these steps.<li><p>Perform a <a id=processing-model-10:potentially-cors-enabled-fetch href=infrastructure.html#potentially-cors-enabled-fetch>potentially CORS-enabled fetch</a> of the <a id=processing-model-10:absolute-url href=infrastructure.html#absolute-url>absolute
     URL</a> of the event source resource, using the same <i>referrer source</i>, and with the
     same <i>mode</i> and <i>origin</i>, as those
     used in the original request triggered by the <code id=processing-model-10:dom-eventsource-2><a href=#dom-eventsource>EventSource()</a></code> constructor, and process the resource obtained in
     this fashion, if any, as described earlier in this section.</ol>

   </ol>

  <p>When a user agent is to <dfn id=fail-the-connection>fail the connection</dfn>, the user agent must <a id=processing-model-10:queue-a-task-4 href=webappapis.html#queue-a-task>queue a
  task</a> which, if the <code id=processing-model-10:dom-eventsource-readystate-6><a href=#dom-eventsource-readystate>readyState</a></code> attribute is
  set to a value other than <code id=processing-model-10:dom-eventsource-closed-3><a href=#dom-eventsource-closed>CLOSED</a></code>, sets the <code id=processing-model-10:dom-eventsource-readystate-7><a href=#dom-eventsource-readystate>readyState</a></code> attribute to <code id=processing-model-10:dom-eventsource-closed-4><a href=#dom-eventsource-closed>CLOSED</a></code> and <a href=webappapis.html#fire-a-simple-event id=processing-model-10:fire-a-simple-event-3>fires a simple
  event</a> named <code id=processing-model-10:event-error-2><a href=indices.html#event-error>error</a></code> at the <code id=processing-model-10:eventsource-4><a href=#eventsource>EventSource</a></code> object.
  <strong>Once the user agent has <a href=#fail-the-connection id=processing-model-10:fail-the-connection-3>failed the connection</a>, it
  does <em>not</em> attempt to reconnect!</strong></p>

  <hr>

  <p>The <a id=processing-model-10:task-source href=webappapis.html#task-source>task source</a> for any <a href=webappapis.html#concept-task id=processing-model-10:concept-task-5>tasks</a> that are <a href=webappapis.html#queue-a-task id=processing-model-10:queue-a-task-5>queued</a> by <code id=processing-model-10:eventsource-5><a href=#eventsource>EventSource</a></code> objects is the <dfn id=remote-event-task-source>remote event
  task source</dfn>.</p>


  <h4 id=parsing-an-event-stream>9.2.4 Parsing an event stream</h4>

  <p>This event stream format's <a id=parsing-an-event-stream:mime-type href=infrastructure.html#mime-type>MIME type</a> is <code id=parsing-an-event-stream:text/event-stream><a href=#text/event-stream>text/event-stream</a></code>.</p>

  <p>The event stream format is as described by the <code>stream</code> production of the
  following ABNF, the character set for which is Unicode. <a href=references.html#refsABNF>[ABNF]</a></p>

  <pre>stream        = [ bom ] *event
event         = *( comment / field ) end-of-line
comment       = colon *any-char end-of-line
field         = 1*name-char [ colon [ space ] *any-char ] end-of-line
end-of-line   = ( cr lf / cr / lf )

; characters
lf            = %x000A ; U+000A LINE FEED (LF)
cr            = %x000D ; U+000D CARRIAGE RETURN (CR)
space         = %x0020 ; U+0020 SPACE
colon         = %x003A ; U+003A COLON (:)
bom           = %xFEFF ; U+FEFF BYTE ORDER MARK
name-char     = %x0000-0009 / %x000B-000C / %x000E-0039 / %x003B-10FFFF
                ; a <a id=parsing-an-event-stream:unicode-character href=infrastructure.html#unicode-character>Unicode character</a> other than U+000A LINE FEED (LF), U+000D CARRIAGE RETURN (CR), or U+003A COLON (:)
any-char      = %x0000-0009 / %x000B-000C / %x000E-10FFFF
                ; a <a id=parsing-an-event-stream:unicode-character-2 href=infrastructure.html#unicode-character>Unicode character</a> other than U+000A LINE FEED (LF) or U+000D CARRIAGE RETURN (CR)</pre>

  <p>Event streams in this format must always be encoded as UTF-8. <a href=references.html#refsENCODING>[ENCODING]</a></p>

  <p>Lines must be separated by either a U+000D CARRIAGE RETURN U+000A LINE FEED (CRLF) character
  pair, a single U+000A LINE FEED (LF) character, or a single U+000D CARRIAGE RETURN (CR)
  character.</p>

  <p>Since connections established to remote servers for such resources are expected to be
  long-lived, UAs should ensure that appropriate buffering is used. In particular, while line
  buffering with lines are defined to end with a single U+000A LINE FEED (LF) character is safe,
  block buffering or line buffering with different expected line endings can cause delays in event
  dispatch.</p>


  <h4 id=event-stream-interpretation>9.2.5 Interpreting an event stream</h4>

  <p>Streams must be decoded using the <a id=event-stream-interpretation:utf-8-decode href=infrastructure.html#utf-8-decode>UTF-8 decode</a> algorithm.</p>

  <p class=note>The <a id=event-stream-interpretation:utf-8-decode-2 href=infrastructure.html#utf-8-decode>UTF-8 decode</a> algorithm strips one leading UTF-8 Byte Order Mark
  (BOM), if any.</p>

  <p>The stream must then be parsed by reading everything line by line, with a U+000D CARRIAGE
  RETURN U+000A LINE FEED (CRLF) character pair, a single U+000A LINE FEED (LF) character not
  preceded by a U+000D CARRIAGE RETURN (CR) character, and a single U+000D CARRIAGE RETURN (CR)
  character not followed by a U+000A LINE FEED (LF) character being the ways in which a line can
  end.</p>

  <p>When a stream is parsed, a <var>data</var> buffer, an <var>event type</var>
  buffer, and a <var>last event ID</var> buffer must be associated with it. They must be
  initialised to the empty string</p>

  <p>Lines must be processed, in the order they are received, as follows:</p>

  <dl class=switch><dt>If the line is empty (a blank line)<dd><p><a href=#dispatchMessage id=event-stream-interpretation:dispatchMessage>Dispatch the event</a>, as defined below.<dt>If the line starts with a U+003A COLON character (:)<dd><p>Ignore the line.<dt>If the line contains a U+003A COLON character (:)<dd>

    <p>Collect the characters on the line before the first U+003A COLON character (:), and let <var>field</var> be that string.</p>

    <p>Collect the characters on the line after the first U+003A COLON character (:), and let <var>value</var> be that string. If <var>value</var> starts with a U+0020 SPACE
    character, remove it from <var>value</var>.</p>

    <p><a href=#processField>Process the field</a> using the steps described below, using <var>field</var> as the field name and <var>value</var> as the field value.</p>

   <dt>Otherwise, the string is not empty but does not contain a U+003A COLON character (:)<dd>

    <p><a href=#processField>Process the field</a> using the steps described below, using the
    whole line as the field name, and the empty string as the field value.</p>

   </dl>

  <p>Once the end of the file is reached, any pending data must be discarded. (If the file ends in
  the middle of an event, before the final empty line, the incomplete event is not dispatched.)</p>

  <hr>

  <p id=processField>The steps to <dfn>process the field</dfn> given a field name and a
  field value depend on the field name, as given in the following list. Field names must be compared
  literally, with no case folding performed.</p>

  <dl class=switch><dt>If the field name is "event"<dd><p>Set the <var>event type</var> buffer to field value.<dt>If the field name is "data"<dd><p>Append the field value to the <var>data</var> buffer, then append a single U+000A
   LINE FEED (LF) character to the <var>data</var> buffer.<dt>If the field name is "id"<dd><p>Set the <var>last event ID</var> buffer to the field value.<dt>If the field name is "retry"<dd><p>If the field value consists of only <a id=event-stream-interpretation:ascii-digits href=infrastructure.html#ascii-digits>ASCII digits</a>, then interpret the field
   value as an integer in base ten, and set the event stream's <a href=#concept-event-stream-reconnection-time id=event-stream-interpretation:concept-event-stream-reconnection-time>reconnection time</a> to that integer.
   Otherwise, ignore the field.<dt>Otherwise<dd><p>The field is ignored.</dl>


  <p>When the user agent is required to <dfn id=dispatchMessage>dispatch the
  event</dfn>, the user agent must process the <var>data</var> buffer, the <var>event type</var> buffer, and the <var>last event ID</var> buffer using steps
  appropriate for the user agent.</p>

  <p>For Web browsers, the appropriate steps to <a href=#dispatchMessage id=event-stream-interpretation:dispatchMessage-2>dispatch the event</a> are as follows:</p>

  <ol><li><p>Set the <a href=#concept-event-stream-last-event-id id=event-stream-interpretation:concept-event-stream-last-event-id>last event ID string</a> of
   the event source to the value of the <var>last event ID</var> buffer. The buffer does
   not get reset, so the <a href=#concept-event-stream-last-event-id id=event-stream-interpretation:concept-event-stream-last-event-id-2>last event ID
   string</a> of the event source remains set to this value until the next time it is set by the
   server.<li><p>If the <var>data</var> buffer is an empty string, set the <var>data</var> buffer and the <var>event type</var> buffer to the empty string and
   abort these steps.<li><p>If the <var>data</var> buffer's last character is a U+000A LINE FEED (LF)
   character, then remove the last character from the <var>data</var> buffer.<li><p>Create an event that uses the <code id=event-stream-interpretation:messageevent><a href=#messageevent>MessageEvent</a></code> interface, with the event type
   <code id=event-stream-interpretation:event-message><a href=indices.html#event-message>message</a></code>, which does not bubble, is not cancelable, and has no
   default action. The <code id=event-stream-interpretation:dom-messageevent-data><a href=#dom-messageevent-data>data</a></code> attribute must be
   initialised to the value of the <var>data</var> buffer, the <code id=event-stream-interpretation:dom-messageevent-origin><a href=#dom-messageevent-origin>origin</a></code> attribute must be initialised to the <a href=browsers.html#unicode-serialisation-of-an-origin id=event-stream-interpretation:unicode-serialisation-of-an-origin>Unicode serialisation</a> of the
   <a id=event-stream-interpretation:origin-2 href=browsers.html#origin-2>origin</a> of the event stream's final URL (i.e. the URL after redirects), and the <code id=event-stream-interpretation:dom-messageevent-lasteventid><a href=#dom-messageevent-lasteventid>lastEventId</a></code> attribute must be initialised to the
   <a href=#concept-event-stream-last-event-id id=event-stream-interpretation:concept-event-stream-last-event-id-3>last event ID string</a> of the event
   source. This event is not <a href=infrastructure.html#concept-events-trusted id=event-stream-interpretation:concept-events-trusted>trusted</a>.<li><p>If the <var>event type</var> buffer has a value other than the empty string, change the
   <a href=infrastructure.html#concept-event-type id=event-stream-interpretation:concept-event-type>type</a> of the newly created event to equal the value of
   the <var>event type</var> buffer.<li><p>Set the <var>data</var> buffer and the <var>event type</var> buffer to
   the empty string.<li><p><a id=event-stream-interpretation:queue-a-task href=webappapis.html#queue-a-task>Queue a task</a> which, if the <code id=event-stream-interpretation:dom-eventsource-readystate><a href=#dom-eventsource-readystate>readyState</a></code> attribute is set to a value other than <code id=event-stream-interpretation:dom-eventsource-closed><a href=#dom-eventsource-closed>CLOSED</a></code>, <a href=infrastructure.html#concept-event-dispatch id=event-stream-interpretation:concept-event-dispatch>dispatches</a> the newly created event at the
   <code id=event-stream-interpretation:eventsource><a href=#eventsource>EventSource</a></code> object.</ol>

  <p class=note>If an event doesn't have an "id" field, but an earlier event did set the event
  source's <a href=#concept-event-stream-last-event-id id=event-stream-interpretation:concept-event-stream-last-event-id-4>last event ID string</a>, then the
  event's <code id=event-stream-interpretation:dom-messageevent-lasteventid-2><a href=#dom-messageevent-lasteventid>lastEventId</a></code> field will be set to the
  value of whatever the last seen "id" field was.</p>

  <p>For other user agents, the appropriate steps to <a href=#dispatchMessage id=event-stream-interpretation:dispatchMessage-3>dispatch the event</a> are
  implementation dependent, but at a minimum they must set the <var>data</var> and <var>event type</var> buffers to the empty string before returning.</p>

  <div class=example>

   <p>The following event stream, once followed by a blank line:</p>
   <pre>data: YHOO
data: +2
data: 10</pre>

   <p>...would cause an event <code id=event-stream-interpretation:event-message-2><a href=indices.html#event-message>message</a></code> with the interface
   <code id=event-stream-interpretation:messageevent-2><a href=#messageevent>MessageEvent</a></code> to be dispatched on the <code id=event-stream-interpretation:eventsource-2><a href=#eventsource>EventSource</a></code> object. The event's
   <code id=event-stream-interpretation:dom-messageevent-data-2><a href=#dom-messageevent-data>data</a></code> attribute would contain the string "<code>YHOO\n+2\n10</code>" (where "<code>\n</code>" represents a newline).</p>

   <p>This could be used as follows:
   <pre>var stocks = new EventSource("http://stocks.example.com/ticker.php");
stocks.onmessage = function (event) {
  var data = event.data.split('\n');
  updateStocks(data[0], data[1], data[2]);
};</pre>

   <p>...where <code>updateStocks()</code> is a function defined as:</p>

   <pre>function updateStocks(symbol, delta, value) { ... }</pre>

   <p>...or some such.</p>

  </div>

  <div class=example>

   <p>The following stream contains four blocks. The first block has just a comment, and will fire
   nothing. The second block has two fields with names "data" and "id" respectively; an event will
   be fired for this block, with the data "first event", and will then set the last event ID to "1"
   so that if the connection died between this block and the next, the server would be sent a <code id=event-stream-interpretation:last-event-id><a href=#last-event-id>Last-Event-ID</a></code> header with the value "1". The third block fires
   an event with data "second event", and also has an "id" field, this time with no value, which
   resets the last event ID to the empty string (meaning no <code id=event-stream-interpretation:last-event-id-2><a href=#last-event-id>Last-Event-ID</a></code> header will now be sent in the event of a
   reconnection being attempted). Finally, the last block just fires an event with the data
   " third event" (with a single leading space character). Note that the last still has to
   end with a blank line, the end of the stream is not enough to trigger the dispatch of the last
   event.</p>

   <pre>: test stream

data: first event
id: 1

data:second event
id

data:  third event
</pre>
  </div>

  <div class=example>

   <p>The following stream fires two events:</p>

   <pre>data

data
data

data:</pre>

   <p>The first block fires events with the data set to the empty string, as would the last block if
   it was followed by a blank line. The middle block fires an event with the data set to a single
   newline character. The last block is discarded because it is not followed by a blank line.</p>

  </div>

  <div class=example>

   <p>The following stream fires two identical events:</p>

   <pre>data:test

data: test
</pre>

   <p>This is because the space after the colon is ignored if present.</p>

  </div>


  <h4 id=authoring-notes>9.2.6 Authoring notes</h4>

  <p>Legacy proxy servers are known to, in certain cases, drop HTTP connections after a short
  timeout. To protect against such proxy servers, authors can include a comment line (one starting
  with a ':' character) every 15 seconds or so.</p>

  <p>Authors wishing to relate event source connections to each other or to specific documents
  previously served might find that relying on IP addresses doesn't work, as individual clients can
  have multiple IP addresses (due to having multiple proxy servers) and individual IP addresses can
  have multiple clients (due to sharing a proxy server). It is better to include a unique identifier
  in the document when it is served and then pass that identifier as part of the URL when the
  connection is established.</p>

  <p>Authors are also cautioned that HTTP chunking can have unexpected negative effects on the
  reliability of this protocol. Where possible, chunking should be disabled for serving event
  streams unless the rate of messages is high enough for this not to matter.</p> 

  <p>Clients that support HTTP's per-server connection limitation might run into trouble when
  opening multiple pages from a site if each page has an <code id=authoring-notes:eventsource><a href=#eventsource>EventSource</a></code> to the same
  domain. Authors can avoid this using the relatively complex mechanism of using unique domain names
  per connection, or by allowing the user to enable or disable the <code id=authoring-notes:eventsource-2><a href=#eventsource>EventSource</a></code>
  functionality on a per-page basis, or by sharing a single <code id=authoring-notes:eventsource-3><a href=#eventsource>EventSource</a></code> object using a
  <a href=workers.html#sharedworkerglobalscope id=authoring-notes:sharedworkerglobalscope>shared worker</a>.</p>


  <h4 id=eventsource-push>9.2.7 Connectionless push and other features</h4>

  <p>User agents running in controlled environments, e.g. browsers on mobile handsets tied to
  specific carriers, may offload the management of the connection to a proxy on the network. In such
  a situation, the user agent for the purposes of conformance is considered to include both the
  handset software and the network proxy.</p>

  <div class=example>

   <p>For example, a browser on a mobile device, after having established a connection, might detect
   that it is on a supporting network and request that a proxy server on the network take over the
   management of the connection. The timeline for such a situation might be as follows:</p>

   <ol><li>Browser connects to a remote HTTP server and requests the resource specified by the author
    in the <code id=eventsource-push:dom-eventsource><a href=#dom-eventsource>EventSource</a></code> constructor.<li>The server sends occasional messages.<li>In between two messages, the browser detects that it is idle except for the network activity
    involved in keeping the TCP connection alive, and decides to switch to sleep mode to save
    power.<li>The browser disconnects from the server.<li>The browser contacts a service on the network, and requests that that service, a "push
    proxy", maintain the connection instead.<li>The "push proxy" service contacts the remote HTTP server and requests the resource specified
    by the author in the <code id=eventsource-push:dom-eventsource-2><a href=#dom-eventsource>EventSource</a></code> constructor (possibly
    including a <code id=eventsource-push:last-event-id><a href=#last-event-id>Last-Event-ID</a></code> HTTP header, etc).<li>The browser allows the mobile device to go to sleep.<li>The server sends another message.<li>The "push proxy" service uses a technology such as OMA push to convey the event to the
    mobile device, which wakes only enough to process the event and then returns to sleep.</ol>

  </div>

  <p>This can reduce the total data usage, and can therefore result in considerable power
  savings.</p>

  <p>As well as implementing the existing API and <code id=eventsource-push:text/event-stream><a href=#text/event-stream>text/event-stream</a></code> wire format as
  defined by this specification and in more distributed ways as described above, formats of event
  framing defined by <a id=eventsource-push:other-applicable-specifications href=infrastructure.html#other-applicable-specifications>other applicable specifications</a> may be supported. This
  specification does not define how they are to be parsed or processed.</p>


  <h4 id=garbage-collection-2>9.2.8 Garbage collection</h4>

  <p>While an <code id=garbage-collection-2:eventsource><a href=#eventsource>EventSource</a></code> object's <code id=garbage-collection-2:dom-eventsource-readystate><a href=#dom-eventsource-readystate>readyState</a></code> is <code id=garbage-collection-2:dom-eventsource-connecting><a href=#dom-eventsource-connecting>CONNECTING</a></code>, and the object has one or more event
  listeners registered for <code id=garbage-collection-2:event-open><a href=indices.html#event-open>open</a></code>, <code id=garbage-collection-2:event-message><a href=indices.html#event-message>message</a></code> or <code id=garbage-collection-2:event-error><a href=indices.html#event-error>error</a></code> events, there must
  be a strong reference from the <code id=garbage-collection-2:window><a href=browsers.html#window>Window</a></code> or <code id=garbage-collection-2:workerglobalscope><a href=workers.html#workerglobalscope>WorkerGlobalScope</a></code> object that
  the <code id=garbage-collection-2:eventsource-2><a href=#eventsource>EventSource</a></code> object's constructor was invoked from to the <code id=garbage-collection-2:eventsource-3><a href=#eventsource>EventSource</a></code>
  object itself.</p>

  <p>While an <code id=garbage-collection-2:eventsource-4><a href=#eventsource>EventSource</a></code> object's <code id=garbage-collection-2:dom-eventsource-readystate-2><a href=#dom-eventsource-readystate>readyState</a></code> is <code id=garbage-collection-2:dom-eventsource-open><a href=#dom-eventsource-open>OPEN</a></code>, and the object has one or more event listeners
  registered for <code id=garbage-collection-2:event-message-2><a href=indices.html#event-message>message</a></code> or <code id=garbage-collection-2:event-error-2><a href=indices.html#event-error>error</a></code> events, there must be a strong reference from the
  <code id=garbage-collection-2:window-2><a href=browsers.html#window>Window</a></code> or <code id=garbage-collection-2:workerglobalscope-2><a href=workers.html#workerglobalscope>WorkerGlobalScope</a></code> object that the <code id=garbage-collection-2:eventsource-5><a href=#eventsource>EventSource</a></code>
  object's constructor was invoked from to the <code id=garbage-collection-2:eventsource-6><a href=#eventsource>EventSource</a></code> object itself.</p>

  <p>While there is a task queued by an <code id=garbage-collection-2:eventsource-7><a href=#eventsource>EventSource</a></code> object on the <a href=#remote-event-task-source id=garbage-collection-2:remote-event-task-source>remote event
  task source</a>, there must be a strong reference from the <code id=garbage-collection-2:window-3><a href=browsers.html#window>Window</a></code> or
  <code id=garbage-collection-2:workerglobalscope-3><a href=workers.html#workerglobalscope>WorkerGlobalScope</a></code> object that the <code id=garbage-collection-2:eventsource-8><a href=#eventsource>EventSource</a></code> object's constructor was
  invoked from to that <code id=garbage-collection-2:eventsource-9><a href=#eventsource>EventSource</a></code> object.</p>

  <p>If a user agent is to <dfn id=concept-eventsource-forcibly-close>forcibly close</dfn> an
  <code id=garbage-collection-2:eventsource-10><a href=#eventsource>EventSource</a></code> object (this happens when a <code id=garbage-collection-2:document><a href=dom.html#document>Document</a></code> object goes away
  permanently), the user agent must abort any instances of the <a id=garbage-collection-2:fetch href=infrastructure.html#fetch>fetch</a> algorithm started
  for this <code id=garbage-collection-2:eventsource-11><a href=#eventsource>EventSource</a></code> object, and must set the <code id=garbage-collection-2:dom-eventsource-readystate-3><a href=#dom-eventsource-readystate>readyState</a></code> attribute to <code id=garbage-collection-2:dom-eventsource-closed><a href=#dom-eventsource-closed>CLOSED</a></code>.</p> 

  <p>If an <code id=garbage-collection-2:eventsource-12><a href=#eventsource>EventSource</a></code> object is garbage collected while its connection is still open,
  the user agent must abort any instance of the <a href=infrastructure.html#fetch id=garbage-collection-2:fetch-2>fetch</a> algorithm opened by
  this <code id=garbage-collection-2:eventsource-13><a href=#eventsource>EventSource</a></code>.</p> 

  <p class=note>It's possible for one active network connection to be shared by multiple
  <code id=garbage-collection-2:eventsource-14><a href=#eventsource>EventSource</a></code> objects and their <a id=garbage-collection-2:fetch-3 href=infrastructure.html#fetch>fetch</a> algorithms, which is why the above
  is phrased in terms of aborting the <a id=garbage-collection-2:fetch-4 href=infrastructure.html#fetch>fetch</a> algorithm and not the actual underlying
  download.</p>


  <h4 id=implementation-advice>9.2.9 Implementation advice</h4>

  <p><i>This section is non-normative.</i></p>

  <p>User agents are strongly urged to provide detailed diagnostic information about
  <code id=implementation-advice:eventsource><a href=#eventsource>EventSource</a></code> objects and their related network connections in their development
  consoles, to aid authors in debugging code using this API.</p>

  <p>For example, a user agent could have a panel displaying all the <code id=implementation-advice:eventsource-2><a href=#eventsource>EventSource</a></code>
  objects a page has created, each listing the constructor's arguments, whether there was a network
  error, what the CORS status of the connection is and what headers were sent by the client and
  received from the server to lead to that status, the messages that were received and how they were
  parsed, and so forth.</p>

  <p>Implementations are especially encouraged to report detailed information to their development
  consoles whenever an <code id=implementation-advice:event-error><a href=indices.html#event-error>error</a></code> event is fired, since little to no
  information can be made available in the events themselves.</p>


  <h4 id=iana-considerations>9.2.10 IANA considerations</h4>

  <h5 id=text/event-stream>9.2.10.1 <dfn><code>text/event-stream</code></dfn></h5>

  <p>This registration is for community review and will be submitted to the IESG for review,
  approval, and registration with IANA.</p>

  

  <dl><dt>Type name:<dd>text<dt>Subtype name:<dd>event-stream<dt>Required parameters:<dd>No parameters<dt>Optional parameters:<dd>
    <dl><dt><code>charset</code><dd>

      <p>The <code>charset</code> parameter may be provided. The parameter's value must be
      "<code>utf-8</code>". This parameter serves no purpose; it is only allowed for
      compatibility with legacy servers.</p>

     </dl>
   <dt>Encoding considerations:<dd>8bit (always UTF-8)<dt>Security considerations:<dd>

    <p>An event stream from an origin distinct from the origin of the content consuming the event
    stream can result in information leakage. To avoid this, user agents are required to apply CORS
    semantics. <a href=references.html#refsFETCH>[FETCH]</a></p>

    <p>Event streams can overwhelm a user agent; a user agent is expected to apply suitable
    restrictions to avoid depleting local resources because of an overabundance of information from
    an event stream.</p>

    <p>Servers can be overwhelmed if a situation develops in which the server is causing clients to
    reconnect rapidly. Servers should use a 5xx status code to indicate capacity problems, as this
    will prevent conforming clients from reconnecting automatically.</p>

   <dt>Interoperability considerations:<dd>
    Rules for processing both conforming and non-conforming content are defined in this
    specification.
   <dt>Published specification:<dd>
    This document is the relevant specification.
   <dt>Applications that use this media type:<dd>
    Web browsers and tools using Web services.
   <dt>Additional information:<dd>
    <dl><dt>Magic number(s):<dd>No sequence of bytes can uniquely identify an event stream.<dt>File extension(s):<dd>No specific file extensions are recommended for this type.<dt>Macintosh file type code(s):<dd>No specific Macintosh file type codes are recommended for this type.</dl>
   <dt>Person &amp; email address to contact for further information:<dd>Ian Hickson &lt;ian@hixie.ch><dt>Intended usage:<dd>Common<dt>Restrictions on usage:<dd>This format is only expected to be used by dynamic open-ended streams served using HTTP or a
   similar protocol. Finite resources are not expected to be labeled with this type.<dt>Author:<dd>Ian Hickson &lt;ian@hixie.ch><dt>Change controller:<dd>W3C</dl>

  <p>Fragment identifiers have no meaning with
  <code id=text/event-stream:text/event-stream><a href=#text/event-stream>text/event-stream</a></code> resources.</p>


  <h5 id=last-event-id>9.2.10.2 <dfn><code>Last-Event-ID</code></dfn></h5>

  <p>This section describes a header for registration in the Permanent Message Header Field
  Registry. <a href=references.html#refsRFC3864>[RFC3864]</a></p>

  <dl><dt>Header field name:<dd>Last-Event-ID<dt>Applicable protocol:<dd>http<dt>Status:<dd>standard<dt>Author/Change controller:<dd>W3C<dt>Specification document(s):<dd>
    This document is the relevant specification.
   <dt>Related information:<dd>None.</dl>


  <h3 id=network>9.3 <dfn>Web sockets</dfn></h3>

  <h4 id=network-intro>9.3.1 Introduction</h4>

  <p><i>This section is non-normative.</i></p>

  <p>To enable Web applications to maintain bidirectional communications with server-side processes,
  this specification introduces the <code id=network-intro:websocket><a href=#websocket>WebSocket</a></code> interface.</p>

  <p class=note>This interface does not allow for raw access to the underlying network. For
  example, this interface could not be used to implement an IRC client without proxying messages
  through a custom server.</p>


  <h4 id=the-websocket-interface>9.3.2 The <code id=the-websocket-interface:websocket><a href=#websocket>WebSocket</a></code> interface</h4>

  <pre class=idl>enum <dfn id=binarytype>BinaryType</dfn> { "<a href=#dom-binarytype-blob id=the-websocket-interface:dom-binarytype-blob>blob</a>", "<a href=#dom-binarytype-arraybuffer id=the-websocket-interface:dom-binarytype-arraybuffer>arraybuffer</a>" };
[<a href=#dom-websocket id=the-websocket-interface:dom-websocket>Constructor</a>(DOMString url, optional (DOMString or DOMString[]) protocols), Exposed=(Window,Worker)]
interface <dfn id=websocket>WebSocket</dfn> : <a id=the-websocket-interface:eventtarget href=infrastructure.html#eventtarget>EventTarget</a> {
  readonly attribute DOMString <a href=#dom-websocket-url id=the-websocket-interface:dom-websocket-url>url</a>;

  // ready state
  const unsigned short <a href=#dom-websocket-connecting id=the-websocket-interface:dom-websocket-connecting>CONNECTING</a> = 0;
  const unsigned short <a href=#dom-websocket-open id=the-websocket-interface:dom-websocket-open>OPEN</a> = 1;
  const unsigned short <a href=#dom-websocket-closing id=the-websocket-interface:dom-websocket-closing>CLOSING</a> = 2;
  const unsigned short <a href=#dom-websocket-closed id=the-websocket-interface:dom-websocket-closed>CLOSED</a> = 3;
  readonly attribute unsigned short <a href=#dom-websocket-readystate id=the-websocket-interface:dom-websocket-readystate>readyState</a>;
  readonly attribute unsigned long <a href=#dom-websocket-bufferedamount id=the-websocket-interface:dom-websocket-bufferedamount>bufferedAmount</a>;

  // networking
  attribute <a id=the-websocket-interface:eventhandler href=webappapis.html#eventhandler>EventHandler</a> <a href=#handler-websocket-onopen id=the-websocket-interface:handler-websocket-onopen>onopen</a>;
  attribute <a id=the-websocket-interface:eventhandler-2 href=webappapis.html#eventhandler>EventHandler</a> <a href=#handler-websocket-onerror id=the-websocket-interface:handler-websocket-onerror>onerror</a>;
  attribute <a id=the-websocket-interface:eventhandler-3 href=webappapis.html#eventhandler>EventHandler</a> <a href=#handler-websocket-onclose id=the-websocket-interface:handler-websocket-onclose>onclose</a>;
  readonly attribute DOMString <a href=#dom-websocket-extensions id=the-websocket-interface:dom-websocket-extensions>extensions</a>;
  readonly attribute DOMString <a href=#dom-websocket-protocol id=the-websocket-interface:dom-websocket-protocol>protocol</a>;
  void <a href=#dom-websocket-close id=the-websocket-interface:dom-websocket-close>close</a>([Clamp] optional unsigned short code, optional <a href=infrastructure.html#idl-usvstring id=the-websocket-interface:idl-usvstring>USVString</a> reason);

  // messaging
  attribute <a id=the-websocket-interface:eventhandler-4 href=webappapis.html#eventhandler>EventHandler</a> <a href=#handler-websocket-onmessage id=the-websocket-interface:handler-websocket-onmessage>onmessage</a>;
  attribute <a href=#binarytype id=the-websocket-interface:binarytype>BinaryType</a> <a href=#dom-websocket-binarytype id=the-websocket-interface:dom-websocket-binarytype>binaryType</a>;
  void <a href=#dom-websocket-send id=the-websocket-interface:dom-websocket-send>send</a>(<a href=infrastructure.html#idl-usvstring id=the-websocket-interface:idl-usvstring-2>USVString</a> data);
  void <a href=#dom-websocket-send id=the-websocket-interface:dom-websocket-send-2>send</a>(<a id=the-websocket-interface:blob href=infrastructure.html#blob>Blob</a> data);
  void <a href=#dom-websocket-send id=the-websocket-interface:dom-websocket-send-3>send</a>(<a id=the-websocket-interface:arraybuffer href=infrastructure.html#arraybuffer>ArrayBuffer</a> data);
  void <a href=#dom-websocket-send id=the-websocket-interface:dom-websocket-send-4>send</a>(<a id=the-websocket-interface:arraybufferview href=infrastructure.html#arraybufferview>ArrayBufferView</a> data);
};</pre>

  <p>The <dfn id=dom-websocket><code>WebSocket(<var>url</var>,
  <var>protocols</var>)</code></dfn> constructor takes one or two arguments. The first argument,
  <var>url</var>, specifies the <a id=the-websocket-interface:url href=infrastructure.html#url>URL</a> to which to connect. The second,
  <var>protocols</var>, if present, is either a string or an array of strings. If it is a string, it
  is equivalent to an array consisting of just that string; if it is omitted, it is equivalent to
  the empty array. Each string in the array is a subprotocol name. The connection will only be
  established if the server reports that it has selected one of these subprotocols. The subprotocol
  names must all be strings that match the requirements for elements that comprise the value of
  <code id=the-websocket-interface:http-sec-websocket-protocol><a href=infrastructure.html#http-sec-websocket-protocol>Sec-WebSocket-Protocol</a></code> fields as defined by the
  WebSocket protocol specification. <a href=references.html#refsWSP>[WSP]</a>

  <p>When the <code id=the-websocket-interface:dom-websocket-2><a href=#dom-websocket>WebSocket()</a></code> constructor is invoked, the UA must
  run these steps:</p>

  <ol><li><p><i id="the-websocket-interface:parse-a-websocket-url's-components"><a href="#parse-a-websocket-url's-components">Parse a WebSocket URL's components</a></i> from
   the <var>url</var> argument, to obtain <var>host</var>, <var>port</var>, <var>resource
   name</var>, and <var>secure</var>. If this fails, throw a <code id=the-websocket-interface:syntaxerror><a href=infrastructure.html#syntaxerror>SyntaxError</a></code> exception and
   abort these steps. <a href=references.html#refsWSP>[WSP]</a><li><p>If <var>secure</var> is false but the <a id=the-websocket-interface:origin-2 href=browsers.html#origin-2>origin</a> specified by the <a id=the-websocket-interface:entry-settings-object href=webappapis.html#entry-settings-object>entry
   settings object</a> has a scheme component that is itself a secure protocol, e.g. HTTPS, then
   throw a <code id=the-websocket-interface:securityerror><a href=infrastructure.html#securityerror>SecurityError</a></code> exception and abort these steps.<li>

    <p>If <var>port</var> is a port to which the user agent is configured to block access, then
    throw a <code id=the-websocket-interface:securityerror-2><a href=infrastructure.html#securityerror>SecurityError</a></code> exception and abort these steps. (User agents typically block
    access to well-known ports like SMTP.)</p>
    

    <p>Access to ports 80 and 443 should not be blocked, including the unlikely cases when
    <var>secure</var> is false but <var>port</var> is 443 or <var>secure</var> is true but
    <var>port</var> is 80.</p>
    

   <li>

    <p>If <var>protocols</var> is absent, let <var>protocols</var> be an empty array.</p>

    <p>Otherwise, if <var>protocols</var> is present and a string, let <var>protocols</var> instead
    be an array consisting of just that string.</p>

   <li><p>If any of the values in <var>protocols</var> occur more than once or otherwise fail to
   match the requirements for elements that comprise the value of <code id=the-websocket-interface:http-sec-websocket-protocol-2><a href=infrastructure.html#http-sec-websocket-protocol>Sec-WebSocket-Protocol</a></code> fields as defined by the
   WebSocket protocol specification, then throw a <code id=the-websocket-interface:syntaxerror-2><a href=infrastructure.html#syntaxerror>SyntaxError</a></code> exception and abort these
   steps. <a href=references.html#refsWSP>[WSP]</a><li><p>Let <var>origin</var> be the <a href=browsers.html#ascii-serialisation-of-an-origin id=the-websocket-interface:ascii-serialisation-of-an-origin>ASCII
   serialisation</a> of the <a id=the-websocket-interface:origin-2-2 href=browsers.html#origin-2>origin</a> specified by the <a id=the-websocket-interface:entry-settings-object-2 href=webappapis.html#entry-settings-object>entry settings
   object</a>, <a id=the-websocket-interface:converted-to-ascii-lowercase href=infrastructure.html#converted-to-ascii-lowercase>converted to ASCII lowercase</a>.<li><p>Return a new <code id=the-websocket-interface:websocket-2><a href=#websocket>WebSocket</a></code> object, but continue these steps
   <a id=the-websocket-interface:in-parallel href=infrastructure.html#in-parallel>in parallel</a>.<li><p>Let the new object's <dfn id=client-specified-protocols>client-specified protocols</dfn> be the values (if any) given in
   <var>protocols</var>.<li>

    <p><i id=the-websocket-interface:concept-websocket-establish><a href=infrastructure.html#concept-websocket-establish>Establish a WebSocket connection</a></i> given the set
    (<var>host</var>, <var>port</var>, <var>resource name</var>, <var>secure</var>), along with the
    <var>protocols</var> list, an empty list for the extensions, and <var>origin</var>. The
    <i id=the-websocket-interface:concept-websocket-cookie-headers><a href=infrastructure.html#concept-websocket-cookie-headers>headers to send appropriate cookies</a></i> must be a <code id=the-websocket-interface:http-cookie><a href=infrastructure.html#http-cookie>Cookie</a></code>
    header whose value is the <a id=the-websocket-interface:cookie-string href=infrastructure.html#cookie-string>cookie-string</a> computed from the user's cookie store and
    the URL <var>url</var>; for these purposes this is <em>not</em> a "non-HTTP" API. <a href=references.html#refsWSP>[WSP]</a>
    <a href=references.html#refsCOOKIES>[COOKIES]</a></p>

    <p>When the user agent <i id=the-websocket-interface:concept-websocket-validate><a href=infrastructure.html#concept-websocket-validate>validates the server's
    response</a></i> during the "<i id=the-websocket-interface:concept-websocket-establish-2><a href=infrastructure.html#concept-websocket-establish>establish a WebSocket
    connection</a></i>" algorithm, if the status code received from the server is not 101 (e.g. it is a
    redirect), the user agent must <i id=the-websocket-interface:concept-websocket-fail><a href=infrastructure.html#concept-websocket-fail>fail the WebSocket
    connection</a></i>.</p>

    <p class=warning>Following HTTP procedures here could introduce serious security problems in a
    Web browser context. For example, consider a host with a WebSocket server at one path and an
    open HTTP redirector at another. Suddenly, any script that can be given a particular WebSocket
    URL can be tricked into communicating to (and potentially sharing secrets with) any host on the
    Internet, even if the script checks that the URL has the right hostname.</p> 

    <p class=note>If the <i id=the-websocket-interface:concept-websocket-establish-3><a href=infrastructure.html#concept-websocket-establish>establish a WebSocket
    connection</a></i> algorithm fails, it triggers the <i id=the-websocket-interface:concept-websocket-fail-2><a href=infrastructure.html#concept-websocket-fail>fail the
    WebSocket connection</a></i> algorithm, which then invokes the <i id=the-websocket-interface:concept-websocket-close><a href=infrastructure.html#concept-websocket-close>close the WebSocket connection</a></i> algorithm, which then
    establishes that <i id=the-websocket-interface:concept-websocket-closed><a href=infrastructure.html#concept-websocket-closed>the WebSocket connection is closed</a></i>,
    which fires the <code id=the-websocket-interface:event-close><a href=indices.html#event-close>close</a></code> event <a href=#closeWebSocket>as
    described below</a>.</p>

   </ol>

  <hr>

  <p>The <dfn id=dom-websocket-url><code>url</code></dfn> attribute must return the result of
  <a href=infrastructure.html#resolve-a-url id=the-websocket-interface:resolve-a-url>resolving</a> the <a id=the-websocket-interface:url-2 href=infrastructure.html#url>URL</a> that was passed to the
  constructor, with the URL character encoding set to UTF-8. (It doesn't matter what it is resolved
  relative to, since we already know it is an <a id=the-websocket-interface:absolute-url href=infrastructure.html#absolute-url>absolute URL</a>.)</p>

  <p>The <dfn id=dom-websocket-readystate><code>readyState</code></dfn> attribute represents
  the state of the connection. It can have the following values:</p>

  <dl><dt><dfn id=dom-websocket-connecting><code>CONNECTING</code></dfn> (numeric value 0)<dd>The connection has not yet been established.<dt><dfn id=dom-websocket-open><code>OPEN</code></dfn> (numeric value 1)<dd><i id=the-websocket-interface:concept-websocket-established><a href=infrastructure.html#concept-websocket-established>The WebSocket connection is established</a></i> and
   communication is possible.<dt><dfn id=dom-websocket-closing><code>CLOSING</code></dfn> (numeric value 2)<dd>The connection is going through the closing handshake, or the <code id=the-websocket-interface:dom-websocket-close-2><a href=#dom-websocket-close>close()</a></code> method has been invoked.<dt><dfn id=dom-websocket-closed><code>CLOSED</code></dfn> (numeric value 3)<dd>The connection has been closed or could not be opened.</dl>

  <p>When the object is created its <code id=the-websocket-interface:dom-websocket-readystate-2><a href=#dom-websocket-readystate>readyState</a></code> must be
  set to <code id=the-websocket-interface:dom-websocket-connecting-2><a href=#dom-websocket-connecting>CONNECTING</a></code> (0).</p>

  <p>The <dfn id=dom-websocket-extensions><code>extensions</code></dfn> attribute must
  initially return the empty string. After <i id=the-websocket-interface:concept-websocket-established-2><a href=infrastructure.html#concept-websocket-established>the WebSocket
  connection is established</a></i>, its value might change, as defined below.</p>

  <p class=note>The <code id=the-websocket-interface:dom-websocket-extensions-2><a href=#dom-websocket-extensions>extensions</a></code> attribute returns
  the extensions selected by the server, if any. (Currently this will only ever be the empty
  string.)</p>

  <p>The <dfn id=dom-websocket-protocol><code>protocol</code></dfn> attribute must initially
  return the empty string. After <i>the WebSocket connection is established</i>, its value might
  change, as defined below.</p>

  <p class=note>The <code id=the-websocket-interface:dom-websocket-protocol-2><a href=#dom-websocket-protocol>protocol</a></code> attribute returns the
  subprotocol selected by the server, if any. It can be used in conjunction with the array form of
  the constructor's second argument to perform subprotocol negotiation.</p>

  <p>The <dfn id=dom-websocket-close><code>close()</code></dfn> method must run the following
  steps:</p>

  <ol><li><p>If the method's first argument is present but is neither an integer equal to 1000 nor an
   integer in the range 3000 to 4999, throw an <code id=the-websocket-interface:invalidaccesserror><a href=infrastructure.html#invalidaccesserror>InvalidAccessError</a></code> exception and abort
   these steps.<li>

    <p>If the method's second argument is present, then run these substeps:</p>

    <ol><li><p>Let <var>raw reason</var> be the method's second argument.<li><p>Let <var>reason</var> be the result of encoding <var>raw
     reason</var> as UTF-8.<li><p>If <var>reason</var> is longer than 123 bytes, then throw a
     <code id=the-websocket-interface:syntaxerror-3><a href=infrastructure.html#syntaxerror>SyntaxError</a></code> exception and abort these steps. <a href=references.html#refsENCODING>[ENCODING]</a></ol>

   <li><p>Run the first matching steps from the following list:</p>

    <dl class=switch><dt>If the <code id=the-websocket-interface:dom-websocket-readystate-3><a href=#dom-websocket-readystate>readyState</a></code> attribute is in the <code id=the-websocket-interface:dom-websocket-closing-2><a href=#dom-websocket-closing>CLOSING</a></code> (2) or <code id=the-websocket-interface:dom-websocket-closed-2><a href=#dom-websocket-closed>CLOSED</a></code> (3) state<dd>

      <p>Do nothing.</p>

      <p class=note>The connection is already closing or is already closed. If it has not already,
      a <code id=the-websocket-interface:event-close-2><a href=indices.html#event-close>close</a></code> event will eventually fire <a href=#closeWebSocket>as described below</a>.</p>

     <dt>If the WebSocket connection is not yet <i id=the-websocket-interface:concept-websocket-established-3><a href=infrastructure.html#concept-websocket-established>established</a></i> <a href=references.html#refsWSP>[WSP]</a><dd>

      <p><i id=the-websocket-interface:concept-websocket-fail-3><a href=infrastructure.html#concept-websocket-fail>Fail the WebSocket connection</a></i> and set the <code id=the-websocket-interface:dom-websocket-readystate-4><a href=#dom-websocket-readystate>readyState</a></code> attribute's value to <code id=the-websocket-interface:dom-websocket-closing-3><a href=#dom-websocket-closing>CLOSING</a></code> (2). <a href=references.html#refsWSP>[WSP]</a></p>

      <p class=note>The <i id=the-websocket-interface:concept-websocket-fail-4><a href=infrastructure.html#concept-websocket-fail>fail the WebSocket connection</a></i>
      algorithm invokes the <i id=the-websocket-interface:concept-websocket-close-2><a href=infrastructure.html#concept-websocket-close>close the WebSocket connection</a></i>
      algorithm, which then establishes that <i id=the-websocket-interface:concept-websocket-closed-2><a href=infrastructure.html#concept-websocket-closed>the WebSocket
      connection is closed</a></i>, which fires the <code id=the-websocket-interface:event-close-3><a href=indices.html#event-close>close</a></code> event <a href=#closeWebSocket>as described below</a>.</p>

     <dt>If the WebSocket closing handshake has not yet been <i id=the-websocket-interface:concept-websocket-closing-handshake><a href=infrastructure.html#concept-websocket-closing-handshake>started</a></i> <a href=references.html#refsWSP>[WSP]</a><dd>

      <p><i id=the-websocket-interface:concept-websocket-start-closing-handshake><a href=infrastructure.html#concept-websocket-start-closing-handshake>Start the WebSocket closing
      handshake</a></i> and set the <code id=the-websocket-interface:dom-websocket-readystate-5><a href=#dom-websocket-readystate>readyState</a></code>
      attribute's value to <code id=the-websocket-interface:dom-websocket-closing-4><a href=#dom-websocket-closing>CLOSING</a></code> (2). <a href=references.html#refsWSP>[WSP]</a></p>

      <p>If the first argument is present, then the status code to use in the
      WebSocket Close message must be the integer given by the first argument. <a href=references.html#refsWSP>[WSP]</a></p>

      <p>If the second argument is also present, then <var>reason</var> must be provided in the
      Close message after the status code. <a href=references.html#refsENCODING>[ENCODING]</a> <a href=references.html#refsWSP>[WSP]</a></p>

      <p class=note>The <i id=the-websocket-interface:concept-websocket-start-closing-handshake-2><a href=infrastructure.html#concept-websocket-start-closing-handshake>start the WebSocket
      closing handshake</a></i> algorithm eventually invokes the <i id=the-websocket-interface:concept-websocket-close-3><a href=infrastructure.html#concept-websocket-close>close the WebSocket connection</a></i> algorithm, which then
      establishes that <i id=the-websocket-interface:concept-websocket-closed-3><a href=infrastructure.html#concept-websocket-closed>the WebSocket connection is closed</a></i>,
      which fires the <code id=the-websocket-interface:event-close-4><a href=indices.html#event-close>close</a></code> event <a href=#closeWebSocket>as
      described below</a>.</p>

     <dt>Otherwise<dd>

      <p>Set the <code id=the-websocket-interface:dom-websocket-readystate-6><a href=#dom-websocket-readystate>readyState</a></code> attribute's value to <code id=the-websocket-interface:dom-websocket-closing-5><a href=#dom-websocket-closing>CLOSING</a></code> (2).</p>

      <p class=note><i id=the-websocket-interface:concept-websocket-closing-handshake-2><a href=infrastructure.html#concept-websocket-closing-handshake>The WebSocket closing
      handshake is started</a></i>, and will eventually invoke the <i id=the-websocket-interface:concept-websocket-close-4><a href=infrastructure.html#concept-websocket-close>close the WebSocket connection</a></i> algorithm, which will
      establish that <i id=the-websocket-interface:concept-websocket-closed-4><a href=infrastructure.html#concept-websocket-closed>the WebSocket connection is closed</a></i>,
      and thus the <code id=the-websocket-interface:event-close-5><a href=indices.html#event-close>close</a></code> event will fire, <a href=#closeWebSocket>as described below</a>.</p>

     </dl>

   </ol>

  <p class=note>The <code id=the-websocket-interface:dom-websocket-close-3><a href=#dom-websocket-close>close()</a></code> method does not discard
  previously sent messages before starting the WebSocket closing handshake — even if, in
  practice, the user agent is still busy sending those messages, the handshake will only start after
  the messages are sent.</p> 

  <hr>

  <p>The <dfn id=dom-websocket-bufferedamount><code>bufferedAmount</code></dfn> attribute must
  return the number of bytes of application data (UTF-8 text and binary data) that have been queued
  using <code id=the-websocket-interface:dom-websocket-send-5><a href=#dom-websocket-send>send()</a></code> but that, as of the last time the
  <a id=the-websocket-interface:event-loop href=webappapis.html#event-loop>event loop</a> reached <a href=webappapis.html#step1>step 1</a>, had not yet been transmitted to the network. (This thus
  includes any text sent during the execution of the current task, regardless of whether the user
  agent is able to transmit text in the background <a id=the-websocket-interface:in-parallel-2 href=infrastructure.html#in-parallel>in parallel</a> with script execution.) This does not include
  framing overhead incurred by the protocol, or buffering done by the operating system or network
  hardware. If the connection is closed, this attribute's value will only increase with each call to
  the <code id=the-websocket-interface:dom-websocket-send-6><a href=#dom-websocket-send>send()</a></code> method (the number does not reset to zero once
  the connection closes).</p>

  <div class=example>

   <p>In this simple example, the <code id=the-websocket-interface:dom-websocket-bufferedamount-2><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code>
   attribute is used to ensure that updates are sent either at the rate of one update every 50ms, if
   the network can handle that rate, or at whatever rate the network <em>can</em> handle, if that is
   too fast.</p>

   <pre>var socket = new WebSocket('ws://game.example.com:12010/updates');
socket.onopen = function () {
  setInterval(function() {
    if (socket.bufferedAmount == 0)
      socket.send(getUpdateData());
  }, 50);
};</pre>

   <p>The <code id=the-websocket-interface:dom-websocket-bufferedamount-3><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code> attribute can also be
   used to saturate the network without sending the data at a higher rate than the network can
   handle, though this requires more careful monitoring of the value of the attribute over time.</p>

  </div>

  <hr>

  <p>When a <code id=the-websocket-interface:websocket-3><a href=#websocket>WebSocket</a></code> object is created, its <dfn id=dom-websocket-binarytype><code>binaryType</code></dfn> IDL attribute must be set to the string
  "<code id=the-websocket-interface:dom-binarytype-blob-2><a href=#dom-binarytype-blob>blob</a></code>". On getting, it must return the last value it was
  set to. On setting, the user agent must set the IDL attribute to the new value.</p>

  <p class=note>This attribute allows authors to control how binary data is exposed to scripts. By
  setting the attribute to "<dfn id=dom-binarytype-blob><code>blob</code></dfn>", binary data
  is returned in <code id=the-websocket-interface:blob-2><a href=infrastructure.html#blob>Blob</a></code> form; by setting it to "<dfn id=dom-binarytype-arraybuffer><code>arraybuffer</code></dfn>", it is returned in
  <code id=the-websocket-interface:arraybuffer-2><a href=infrastructure.html#arraybuffer>ArrayBuffer</a></code> form. User agents can use this as a hint for how to handle incoming
  binary data: if the attribute is set to "<code id=the-websocket-interface:dom-binarytype-blob-3><a href=#dom-binarytype-blob>blob</a></code>", it is
  safe to spool it to disk, and if it is set to "<code id=the-websocket-interface:dom-binarytype-arraybuffer-2><a href=#dom-binarytype-arraybuffer>arraybuffer</a></code>", it is likely more efficient to keep the
  data in memory. Naturally, user agents are encouraged to use more subtle heuristics to decide
  whether to keep incoming data in memory or not, e.g. based on how big the data is or how common it
  is for a script to change the attribute at the last minute. This latter aspect is important in
  particular because it is quite possible for the attribute to be changed after the user agent has
  received the data but before the user agent has fired the event for it.</p>

  <p>The <dfn id=dom-websocket-send><code>send(<var>data</var>)</code></dfn> method transmits
  data using the connection. If the <code id=the-websocket-interface:dom-websocket-readystate-7><a href=#dom-websocket-readystate>readyState</a></code>
  attribute is <code id=the-websocket-interface:dom-websocket-connecting-3><a href=#dom-websocket-connecting>CONNECTING</a></code>, it must throw an
  <code id=the-websocket-interface:invalidstateerror><a href=infrastructure.html#invalidstateerror>InvalidStateError</a></code> exception. Otherwise, the user agent must run the appropriate set
  of steps from the following list:</p>

  <dl><dt>If the argument is a string<dd>

    <p>If <i id=the-websocket-interface:concept-websocket-established-4><a href=infrastructure.html#concept-websocket-established>the WebSocket connection is
    established</a></i> and <i id=the-websocket-interface:concept-websocket-closing-handshake-3><a href=infrastructure.html#concept-websocket-closing-handshake>the WebSocket closing
    handshake has not yet started</a></i>, then the user agent must <i id=the-websocket-interface:concept-websocket-send><a href=infrastructure.html#concept-websocket-send>send a WebSocket Message</a></i> comprised of the <var>data</var> argument using
    a text frame opcode; if the data cannot be sent, e.g. because it would need to be buffered but
    the buffer is full, the user agent must <a href=#concept-websocket-close-fail id=the-websocket-interface:concept-websocket-close-fail>flag the
    WebSocket as full</a> and then <i id=the-websocket-interface:concept-websocket-close-5><a href=infrastructure.html#concept-websocket-close>close the WebSocket
    connection</a></i>. Any invocation of this method with a string argument that does not throw an
    exception must increase the <code id=the-websocket-interface:dom-websocket-bufferedamount-4><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code>
    attribute by the number of bytes needed to express the argument as UTF-8. <a href=references.html#refsUNICODE>[UNICODE]</a>
    <a href=references.html#refsENCODING>[ENCODING]</a> <a href=references.html#refsWSP>[WSP]</a></p>

   <dt>If the argument is a <code id=the-websocket-interface:blob-3><a href=infrastructure.html#blob>Blob</a></code> object<dd>

    <p>If <i id=the-websocket-interface:concept-websocket-established-5><a href=infrastructure.html#concept-websocket-established>the WebSocket connection is established</a></i>, and
    <i id=the-websocket-interface:concept-websocket-closing-handshake-4><a href=infrastructure.html#concept-websocket-closing-handshake>the WebSocket closing handshake has not yet
    started</a></i>, then the user agent must <i id=the-websocket-interface:concept-websocket-send-2><a href=infrastructure.html#concept-websocket-send>send a WebSocket
    Message</a></i> comprised of <var>data</var> using a binary frame opcode; if the data cannot be
    sent, e.g. because it would need to be buffered but the buffer is full, the user agent must
    <a href=#concept-websocket-close-fail id=the-websocket-interface:concept-websocket-close-fail-2>flag the WebSocket as full</a> and then <i id=the-websocket-interface:concept-websocket-close-6><a href=infrastructure.html#concept-websocket-close>close the WebSocket connection</a></i>. The data to be sent is the
    raw data represented by the <code id=the-websocket-interface:blob-4><a href=infrastructure.html#blob>Blob</a></code> object.  Any invocation of this method with a
    <code id=the-websocket-interface:blob-5><a href=infrastructure.html#blob>Blob</a></code> argument that does not throw an exception must increase the <code id=the-websocket-interface:dom-websocket-bufferedamount-5><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code> attribute by the size of the
    <code id=the-websocket-interface:blob-6><a href=infrastructure.html#blob>Blob</a></code> object's raw data, in bytes.  <a href=references.html#refsWSP>[WSP]</a> <a href=references.html#refsFILEAPI>[FILEAPI]</a></p>

   <dt>If the argument is an <code id=the-websocket-interface:arraybuffer-3><a href=infrastructure.html#arraybuffer>ArrayBuffer</a></code> object<dd>

    <p>If <i id=the-websocket-interface:concept-websocket-established-6><a href=infrastructure.html#concept-websocket-established>the WebSocket connection is established</a></i>, and
    <i id=the-websocket-interface:concept-websocket-closing-handshake-5><a href=infrastructure.html#concept-websocket-closing-handshake>the WebSocket closing handshake has not yet
    started</a></i>, then the user agent must <i id=the-websocket-interface:concept-websocket-send-3><a href=infrastructure.html#concept-websocket-send>send a WebSocket
    Message</a></i> comprised of <var>data</var> using a binary frame opcode; if the data cannot be
    sent, e.g. because it would need to be buffered but the buffer is full, the user agent must
    <a href=#concept-websocket-close-fail id=the-websocket-interface:concept-websocket-close-fail-3>flag the WebSocket as full</a> and then <i id=the-websocket-interface:concept-websocket-close-7><a href=infrastructure.html#concept-websocket-close>close the WebSocket connection</a></i>. The data to be sent is the
    data stored in the buffer described by the <code id=the-websocket-interface:arraybuffer-4><a href=infrastructure.html#arraybuffer>ArrayBuffer</a></code> object. Any invocation of
    this method with an <code id=the-websocket-interface:arraybuffer-5><a href=infrastructure.html#arraybuffer>ArrayBuffer</a></code> argument that does not throw an exception must
    increase the <code id=the-websocket-interface:dom-websocket-bufferedamount-6><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code> attribute by the
    length of the <code id=the-websocket-interface:arraybuffer-6><a href=infrastructure.html#arraybuffer>ArrayBuffer</a></code> in bytes. <a href=references.html#refsWSP>[WSP]</a> <a href=references.html#refsECMA262>[ECMA262]</a></p>

   <dt>If the argument is an object that matches the <code id=the-websocket-interface:arraybufferview-2><a href=infrastructure.html#arraybufferview>ArrayBufferView</a></code> type definition<dd>

    <p>If <i id=the-websocket-interface:concept-websocket-established-7><a href=infrastructure.html#concept-websocket-established>the WebSocket connection is established</a></i>, and
    <i id=the-websocket-interface:concept-websocket-closing-handshake-6><a href=infrastructure.html#concept-websocket-closing-handshake>the WebSocket closing handshake has not yet
    started</a></i>, then the user agent must <i id=the-websocket-interface:concept-websocket-send-4><a href=infrastructure.html#concept-websocket-send>send a WebSocket
    Message</a></i> comprised of <var>data</var> using a binary frame opcode; if the data cannot be
    sent, e.g. because it would need to be buffered but the buffer is full, the user agent must
    <a href=#concept-websocket-close-fail id=the-websocket-interface:concept-websocket-close-fail-4>flag the WebSocket as full</a> and then <i id=the-websocket-interface:concept-websocket-close-8><a href=infrastructure.html#concept-websocket-close>close the WebSocket connection</a></i>. The data to be sent is the
    data stored in the section of the buffer described by the <code id=the-websocket-interface:arraybuffer-7><a href=infrastructure.html#arraybuffer>ArrayBuffer</a></code> object that
    <var>data</var> references. Any invocation of this method with this kind of argument that does
    not throw an exception must increase the <code id=the-websocket-interface:dom-websocket-bufferedamount-7><a href=#dom-websocket-bufferedamount>bufferedAmount</a></code> attribute by the length of
    <var>data</var>'s buffer in bytes. <a href=references.html#refsWSP>[WSP]</a> <a href=references.html#refsECMA262>[ECMA262]</a></p>

   </dl>

  <hr>

  <p>The following are the <a id=the-websocket-interface:event-handlers href=webappapis.html#event-handlers>event handlers</a> (and their corresponding <a href=webappapis.html#event-handler-event-type id=the-websocket-interface:event-handler-event-type>event handler event types</a>) that must be supported, as <a id=the-websocket-interface:event-handler-idl-attributes href=webappapis.html#event-handler-idl-attributes>event
  handler IDL attributes</a>, by all objects implementing the <code id=the-websocket-interface:websocket-4><a href=#websocket>WebSocket</a></code>
  interface:</p>

  <table><thead><tr><th><a href=webappapis.html#event-handlers id=the-websocket-interface:event-handlers-2>Event handler</a> <th><a id=the-websocket-interface:event-handler-event-type-2 href=webappapis.html#event-handler-event-type>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-websocket-onopen><code>onopen</code></dfn> <td> <code id=the-websocket-interface:event-open><a href=indices.html#event-open>open</a></code>
    <tr><td><dfn id=handler-websocket-onmessage><code>onmessage</code></dfn> <td> <code id=the-websocket-interface:event-message><a href=indices.html#event-message>message</a></code>
    <tr><td><dfn id=handler-websocket-onerror><code>onerror</code></dfn> <td> <code id=the-websocket-interface:event-error><a href=indices.html#event-error>error</a></code>
    <tr><td><dfn id=handler-websocket-onclose><code>onclose</code></dfn> <td> <code id=the-websocket-interface:event-close-6><a href=indices.html#event-close>close</a></code>
  </table>



  <h4 id=feedback-from-the-protocol>9.3.3 Feedback from the protocol</h4>

  <p>When <i id=feedback-from-the-protocol:concept-websocket-established><a href=infrastructure.html#concept-websocket-established>the WebSocket connection is established</a></i>, the
  user agent must <a id=feedback-from-the-protocol:queue-a-task href=webappapis.html#queue-a-task>queue a task</a> to run these steps:</p>

  <ol><li><p>If the <code id=feedback-from-the-protocol:websocket><a href=#websocket>WebSocket</a></code> object's <a href=#client-specified-protocols id=feedback-from-the-protocol:client-specified-protocols>client-specified protocols</a> was not an
   empty list, but the <i id=feedback-from-the-protocol:concept-websocket-subprotocol><a href=infrastructure.html#concept-websocket-subprotocol>subprotocol in use</a></i> is the null
   value, then <i id=feedback-from-the-protocol:concept-websocket-fail><a href=infrastructure.html#concept-websocket-fail>fail the WebSocket connection</a></i>, set the <code id=feedback-from-the-protocol:dom-websocket-readystate><a href=#dom-websocket-readystate>readyState</a></code> attribute's value to <code id=feedback-from-the-protocol:dom-websocket-closing><a href=#dom-websocket-closing>CLOSING</a></code> (2), and abort these steps. <a href=references.html#refsWSP>[WSP]</a><li><p>Change the <code id=feedback-from-the-protocol:dom-websocket-readystate-2><a href=#dom-websocket-readystate>readyState</a></code> attribute's value to
   <code id=feedback-from-the-protocol:dom-websocket-open><a href=#dom-websocket-open>OPEN</a></code> (1).<li><p>Change the <code id=feedback-from-the-protocol:dom-websocket-extensions><a href=#dom-websocket-extensions>extensions</a></code> attribute's value to
   the <i id=feedback-from-the-protocol:concept-websockets-active-extensions><a href=infrastructure.html#concept-websockets-active-extensions>extensions in use</a></i>, if is not the null
   value. <a href=references.html#refsWSP>[WSP]</a><li><p>Change the <code id=feedback-from-the-protocol:dom-websocket-protocol><a href=#dom-websocket-protocol>protocol</a></code> attribute's value to the
   <i id=feedback-from-the-protocol:concept-websocket-subprotocol-2><a href=infrastructure.html#concept-websocket-subprotocol>subprotocol in use</a></i>, if is not the null value. <a href=references.html#refsWSP>[WSP]</a><li><p>Act as if the user agent had <a href=infrastructure.html#receives-a-set-cookie-string id=feedback-from-the-protocol:receives-a-set-cookie-string>received a
   set-cookie-string</a> consisting of the <a href=infrastructure.html#concept-websocket-handshake-cookies id=feedback-from-the-protocol:concept-websocket-handshake-cookies>cookies set during the server's opening
   handshake</a>, for the URL <var>url</var> given to the <code id=feedback-from-the-protocol:dom-websocket><a href=#dom-websocket>WebSocket()</a></code> constructor. <a href=references.html#refsCOOKIES>[COOKIES]</a> <a href=references.html#refsENCODING>[ENCODING]</a>
   <a href=references.html#refsWSP>[WSP]</a><li><p><a id=feedback-from-the-protocol:fire-a-simple-event href=webappapis.html#fire-a-simple-event>Fire a simple event</a> named <code id=feedback-from-the-protocol:event-open><a href=indices.html#event-open>open</a></code> at the
   <code id=feedback-from-the-protocol:websocket-2><a href=#websocket>WebSocket</a></code> object.</p>

  </ol>

  <hr>

  <p>When <i id=feedback-from-the-protocol:concept-websocket-message-received><a href=infrastructure.html#concept-websocket-message-received>a WebSocket message has been received</a></i>
  with type <var>type</var> and data <var>data</var>, the user agent must <a id=feedback-from-the-protocol:queue-a-task-2 href=webappapis.html#queue-a-task>queue a task</a>
  to follow these steps: <a href=references.html#refsWSP>[WSP]</a></p>

  <ol><li>

    <p>If the <code id=feedback-from-the-protocol:dom-websocket-readystate-3><a href=#dom-websocket-readystate>readyState</a></code> attribute's value is not
    <code id=feedback-from-the-protocol:dom-websocket-open-2><a href=#dom-websocket-open>OPEN</a></code> (1), then abort these steps.</p>

   <li>

    <p>Let <var>event</var> be a newly created <a href=infrastructure.html#concept-events-trusted id=feedback-from-the-protocol:concept-events-trusted>trusted</a>
    event that uses the <code id=feedback-from-the-protocol:messageevent><a href=#messageevent>MessageEvent</a></code> interface, with the event type <code id=feedback-from-the-protocol:event-message><a href=indices.html#event-message>message</a></code>, which does not bubble, is not cancelable, and has no
    default action.</p>

   <li><p>Initialise <var>event</var>'s <code id=feedback-from-the-protocol:dom-messageevent-origin><a href=#dom-messageevent-origin>origin</a></code>
   attribute to the <a href=browsers.html#unicode-serialisation-of-an-origin id=feedback-from-the-protocol:unicode-serialisation-of-an-origin>Unicode serialisation</a>
   of the <a id=feedback-from-the-protocol:origin-2 href=browsers.html#origin-2>origin</a> of the <a id=feedback-from-the-protocol:url href=infrastructure.html#url>URL</a> that was passed to the <code id=feedback-from-the-protocol:websocket-3><a href=#websocket>WebSocket</a></code>
   object's constructor.<li>

    <p>If <var>type</var> indicates that the data is Text, then initialise <var>event</var>'s <code id=feedback-from-the-protocol:dom-messageevent-data><a href=#dom-messageevent-data>data</a></code> attribute to <var>data</var>.

    <p>If <var>type</var> indicates that the data is Binary, and <code id=feedback-from-the-protocol:dom-websocket-binarytype><a href=#dom-websocket-binarytype>binaryType</a></code> is set to "<code id=feedback-from-the-protocol:dom-binarytype-blob><a href=#dom-binarytype-blob>blob</a></code>", then initialise <var>event</var>'s <code id=feedback-from-the-protocol:dom-messageevent-data-2><a href=#dom-messageevent-data>data</a></code> attribute to a new <code id=feedback-from-the-protocol:blob><a href=infrastructure.html#blob>Blob</a></code> object that
    represents <var>data</var> as its raw data. <a href=references.html#refsFILEAPI>[FILEAPI]</a></p>

    <p>If <var>type</var> indicates that the data is Binary, and <code id=feedback-from-the-protocol:dom-websocket-binarytype-2><a href=#dom-websocket-binarytype>binaryType</a></code> is set to "<code id=feedback-from-the-protocol:dom-binarytype-arraybuffer><a href=#dom-binarytype-arraybuffer>arraybuffer</a></code>", then initialise <var>event</var>'s
    <code id=feedback-from-the-protocol:dom-messageevent-data-3><a href=#dom-messageevent-data>data</a></code> attribute to a new <code id=feedback-from-the-protocol:arraybuffer><a href=infrastructure.html#arraybuffer>ArrayBuffer</a></code>
    object whose contents are <var>data</var>. <a href=references.html#refsECMA262>[ECMA262]</a></p>

   <li>

    <p><a href=infrastructure.html#concept-event-dispatch id=feedback-from-the-protocol:concept-event-dispatch>Dispatch</a> <var>event</var> at the
    <code id=feedback-from-the-protocol:websocket-4><a href=#websocket>WebSocket</a></code> object.</p>

   </ol>

  <p class=note>User agents are encouraged to check if they can perform the above steps
  efficiently before they run the task, picking tasks from other <a href=webappapis.html#task-queue id=feedback-from-the-protocol:task-queue>task
  queues</a> while they prepare the buffers if not. For example, if the <code id=feedback-from-the-protocol:dom-websocket-binarytype-3><a href=#dom-websocket-binarytype>binaryType</a></code> attribute was set to "<code id=feedback-from-the-protocol:dom-binarytype-blob-2><a href=#dom-binarytype-blob>blob</a></code>" when the data arrived, and the user agent spooled all
  the data to disk, but just before running the above <a href=webappapis.html#concept-task id=feedback-from-the-protocol:concept-task>task</a> for
  this particular message the script switched <code id=feedback-from-the-protocol:dom-websocket-binarytype-4><a href=#dom-websocket-binarytype>binaryType</a></code> to "<code id=feedback-from-the-protocol:dom-binarytype-arraybuffer-2><a href=#dom-binarytype-arraybuffer>arraybuffer</a></code>", the user agent would want to page the
  data back to RAM before running this <a href=webappapis.html#concept-task id=feedback-from-the-protocol:concept-task-2>task</a> so as to avoid
  stalling the main thread while it created the <code id=feedback-from-the-protocol:arraybuffer-2><a href=infrastructure.html#arraybuffer>ArrayBuffer</a></code> object.</p>

  <div class=example>

   <p>Here is an example of how to define a handler for the <code id=feedback-from-the-protocol:event-message-2><a href=indices.html#event-message>message</a></code> event in the case of text frames:</p>

   <pre>mysocket.onmessage = function (event) {
  if (event.data == 'on') {
    turnLampOn();
  } else if (event.data == 'off') {
    turnLampOff();
  }
};</pre>

   <p>The protocol here is a trivial one, with the server just sending "on" or "off" messages.</p>

  </div>

  <hr>

  <p>When <i id=feedback-from-the-protocol:concept-websocket-closing-handshake><a href=infrastructure.html#concept-websocket-closing-handshake>the WebSocket closing handshake is
  started</a></i>, the user agent must <a id=feedback-from-the-protocol:queue-a-task-3 href=webappapis.html#queue-a-task>queue a task</a> to change the <code id=feedback-from-the-protocol:dom-websocket-readystate-4><a href=#dom-websocket-readystate>readyState</a></code> attribute's value to <code id=feedback-from-the-protocol:dom-websocket-closing-2><a href=#dom-websocket-closing>CLOSING</a></code> (2). (If the <code id=feedback-from-the-protocol:dom-websocket-close><a href=#dom-websocket-close>close()</a></code> method was called, the <code id=feedback-from-the-protocol:dom-websocket-readystate-5><a href=#dom-websocket-readystate>readyState</a></code> attribute's value will already be set to <code id=feedback-from-the-protocol:dom-websocket-closing-3><a href=#dom-websocket-closing>CLOSING</a></code> (2) when this task runs.) <a href=references.html#refsWSP>[WSP]</a></p>

  <hr>

  <p id=closeWebSocket>When <i id=feedback-from-the-protocol:concept-websocket-closed><a href=infrastructure.html#concept-websocket-closed>the WebSocket connection is
  closed</a></i>, possibly <i>cleanly</i>, the user agent must <a id=feedback-from-the-protocol:queue-a-task-4 href=webappapis.html#queue-a-task>queue a task</a> to run the
  following substeps:</p>

  <ol><li><p>Change the <code id=feedback-from-the-protocol:dom-websocket-readystate-6><a href=#dom-websocket-readystate>readyState</a></code> attribute's value to
   <code id=feedback-from-the-protocol:dom-websocket-closed><a href=#dom-websocket-closed>CLOSED</a></code> (3).<li><p>If the user agent was required to <i id=feedback-from-the-protocol:concept-websocket-fail-2><a href=infrastructure.html#concept-websocket-fail>fail the WebSocket
   connection</a></i>, or if the <i id=feedback-from-the-protocol:concept-websocket-closed-2><a href=infrastructure.html#concept-websocket-closed>the WebSocket connection was
   closed</a></i> after being <dfn id=concept-websocket-close-fail>flagged as full</dfn>,
   <a id=feedback-from-the-protocol:fire-a-simple-event-2 href=webappapis.html#fire-a-simple-event>fire a simple event</a> named <code>error</code> at the <code id=feedback-from-the-protocol:websocket-5><a href=#websocket>WebSocket</a></code>
   object. <a href=references.html#refsWSP>[WSP]</a><li><p>Create a <a href=infrastructure.html#concept-events-trusted id=feedback-from-the-protocol:concept-events-trusted-2>trusted</a> event that uses the
   <code id=feedback-from-the-protocol:closeevent><a href=#closeevent>CloseEvent</a></code> interface, with the event type <code id=feedback-from-the-protocol:event-close><a href=indices.html#event-close>close</a></code>,
   which does not bubble, is not cancelable, has no default action, whose <code id=feedback-from-the-protocol:dom-closeevent-wasclean><a href=#dom-closeevent-wasclean>wasClean</a></code> attribute is initialised to true if the
   connection closed <i>cleanly</i> and false otherwise, whose <code id=feedback-from-the-protocol:dom-closeevent-code><a href=#dom-closeevent-code>code</a></code> attribute is initialised to <i id=feedback-from-the-protocol:concept-websocket-close-code><a href=infrastructure.html#concept-websocket-close-code>the WebSocket connection close code</a></i>, and whose <code id=feedback-from-the-protocol:dom-closeevent-reason><a href=#dom-closeevent-reason>reason</a></code> attribute is initialised to the result of applying
   the <a id=feedback-from-the-protocol:utf-8-decoder href=infrastructure.html#utf-8-decoder>UTF-8 decoder</a> to <i id=feedback-from-the-protocol:concept-websocket-close-reason><a href=infrastructure.html#concept-websocket-close-reason>the WebSocket
   connection close reason</a></i>, and <a href=infrastructure.html#concept-event-dispatch id=feedback-from-the-protocol:concept-event-dispatch-2>dispatch</a> the event
   at the <code id=feedback-from-the-protocol:websocket-6><a href=#websocket>WebSocket</a></code> object. <a href=references.html#refsWSP>[WSP]</a></ol>

  <div class=warning>

   <p>User agents must not convey any failure information to scripts in a way that would allow a
   script to distinguish the following situations:</p>

   <ul><li>A server whose host name could not be resolved.

    <li>A server to which packets could not successfully be routed.

    <li>A server that refused the connection on the specified port.

    <li>A server that failed to correctly perform a TLS handshake (e.g., the server certificate
    can't be verified).

    <li>A server that did not complete the opening handshake (e.g. because it was not a WebSocket
    server).

    <li>A WebSocket server that sent a correct opening handshake, but that specified options that
    caused the client to drop the connection (e.g. the server specified a subprotocol that the
    client did not offer).

    <li>A WebSocket server that abruptly closed the connection after successfully completing the
    opening handshake.

   </ul>

   <p>In all of these cases, the <i id=feedback-from-the-protocol:concept-websocket-close-code-2><a href=infrastructure.html#concept-websocket-close-code>the WebSocket connection close code</a></i> would be 1006, as
   required by the WebSocket Protocol specification. <a href=references.html#refsWSP>[WSP]</a></p>

   <p>Allowing a script to distinguish these cases would allow a script to probe the user's local
   network in preparation for an attack.</p>

   <p class=note>In particular, this means the code 1015 is not used by the user agent (unless the
   server erroneously uses it in its close frame, of course).</p>

  </div>

  <hr>

  <p>The <a id=feedback-from-the-protocol:task-source href=webappapis.html#task-source>task source</a> for all <a href=webappapis.html#concept-task id=feedback-from-the-protocol:concept-task-3>tasks</a> <a href=webappapis.html#queue-a-task id=feedback-from-the-protocol:queue-a-task-5>queued</a> in this section is the <dfn id=websocket-task-source>WebSocket task source</dfn>.</p>


  <h4 id=ping-and-pong-frames>9.3.4 Ping and Pong frames</h4>

  <p>The WebSocket protocol specification defines Ping and Pong frames that can be used for
  keep-alive, heart-beats, network status probing, latency instrumentation, and so forth. These are
  not currently exposed in the API.</p>

  <p>User agents may send ping and unsolicited pong frames as desired, for example in an attempt to
  maintain local network NAT mappings, to detect failed connections, or to display latency metrics
  to the user. User agents must not use pings or unsolicited pongs to aid the server; it is assumed
  that servers will solicit pongs whenever appropriate for the server's needs.</p>

  


  <h4 id=parsing-websocket-urls>9.3.5 Parsing WebSocket URLs</h4>

  <p>The steps to <dfn id="parse-a-websocket-url's-components">parse a WebSocket URL's components</dfn> from a string <var>url</var> are as
  follows. These steps return either a <var>host</var>, a <var>port</var>, a <var>resource
  name</var>, and a <var>secure</var> flag, or they fail.</p>

  <ol><li><p>If the <var>url</var> string is not an <a id=parsing-websocket-urls:absolute-url href=infrastructure.html#absolute-url>absolute URL</a>, then fail this
   algorithm.<li>

    <p><a href=infrastructure.html#resolve-a-url id=parsing-websocket-urls:resolve-a-url>Resolve</a> the <var>url</var> string, with the URL character
    encoding set to UTF-8. <a href=references.html#refsENCODING>[ENCODING]</a></p> 

    <p class=note>It doesn't matter what it is resolved relative to, since we already know it is
    an <a id=parsing-websocket-urls:absolute-url-2 href=infrastructure.html#absolute-url>absolute URL</a> at this point.</p>

   <li><p>If the resulting <a id=parsing-websocket-urls:parsed-url href=infrastructure.html#parsed-url>parsed URL</a> does not have a <a href=infrastructure.html#concept-url-scheme id=parsing-websocket-urls:concept-url-scheme>scheme</a> component whose value is either "<code>ws</code>" or "<code>wss</code>", then fail this algorithm.<li><p>If the resulting <a id=parsing-websocket-urls:parsed-url-2 href=infrastructure.html#parsed-url>parsed URL</a> has a non-null <a href=infrastructure.html#concept-url-fragment id=parsing-websocket-urls:concept-url-fragment>fragment</a> component, then fail this algorithm.<li><p>If the <a href=infrastructure.html#concept-url-scheme id=parsing-websocket-urls:concept-url-scheme-2>scheme</a> component of the resulting
   <a id=parsing-websocket-urls:parsed-url-3 href=infrastructure.html#parsed-url>parsed URL</a> is "<code>ws</code>", set <var>secure</var> to false;
   otherwise, the <a href=infrastructure.html#concept-url-scheme id=parsing-websocket-urls:concept-url-scheme-3>scheme</a> component is "<code>wss</code>", set <var>secure</var> to true.<li><p>Let <var>host</var> be the value of the resulting <a id=parsing-websocket-urls:parsed-url-4 href=infrastructure.html#parsed-url>parsed URL</a>'s <a href=infrastructure.html#concept-url-host id=parsing-websocket-urls:concept-url-host>host</a> component.<li><p>If the resulting <a id=parsing-websocket-urls:parsed-url-5 href=infrastructure.html#parsed-url>parsed URL</a> has a <a href=infrastructure.html#concept-url-port id=parsing-websocket-urls:concept-url-port>port</a>
   component that is not the empty string, then let <var>port</var> be that component's value;
   otherwise, there is no explicit <var>port</var>.<li><p>If there is no explicit <var>port</var>, then: if <var>secure</var> is false, let
   <var>port</var> be 80, otherwise let <var>port</var> be 443.<li><p>Let <var>resource name</var> be the value of the resulting <a id=parsing-websocket-urls:parsed-url-6 href=infrastructure.html#parsed-url>parsed URL</a>'s <a href=infrastructure.html#concept-url-path id=parsing-websocket-urls:concept-url-path>path</a> component (which might be empty).<li><p>If <var>resource name</var> is the empty string, set it to a single character U+002F
   SOLIDUS (/).<li><p>If the resulting <a id=parsing-websocket-urls:parsed-url-7 href=infrastructure.html#parsed-url>parsed URL</a> has a non-null <a href=infrastructure.html#concept-url-query id=parsing-websocket-urls:concept-url-query>query</a> component, then append a single U+003F QUESTION MARK
   character (?) to <var>resource name</var>, followed by the value of the <a href=infrastructure.html#concept-url-query id=parsing-websocket-urls:concept-url-query-2>query</a> component.<li><p>Return <var>host</var>, <var>port</var>, <var>resource name</var>, and
   <var>secure</var>.</ol>


  <h4 id=the-closeevent-interfaces>9.3.6 The <code id=the-closeevent-interfaces:closeevent><a href=#closeevent>CloseEvent</a></code> interfaces</h4>

  <pre class=idl>[Constructor(DOMString type, optional <a href=#closeeventinit id=the-closeevent-interfaces:closeeventinit>CloseEventInit</a> eventInitDict), Exposed=(Window,Worker)]
interface <dfn id=closeevent>CloseEvent</dfn> : <a id=the-closeevent-interfaces:event href=infrastructure.html#event>Event</a> {
  readonly attribute boolean <a href=#dom-closeevent-wasclean id=the-closeevent-interfaces:dom-closeevent-wasclean>wasClean</a>;
  readonly attribute unsigned short <a href=#dom-closeevent-code id=the-closeevent-interfaces:dom-closeevent-code>code</a>;
  readonly attribute DOMString <a href=#dom-closeevent-reason id=the-closeevent-interfaces:dom-closeevent-reason>reason</a>;
};

dictionary <dfn id=closeeventinit>CloseEventInit</dfn> : <a id=the-closeevent-interfaces:eventinit href=infrastructure.html#eventinit>EventInit</a> {
  boolean wasClean;
  unsigned short code;
  DOMString reason;
};</pre>

  <p>The <dfn id=dom-closeevent-wasclean><code>wasClean</code></dfn> attribute must return the
  value it was initialised to. When the object is created, this attribute must be initialised to
  false. It represents whether the connection closed cleanly or not.</p>

  <p>The <dfn id=dom-closeevent-code><code>code</code></dfn> attribute must return the value it
  was initialised to. When the object is created, this attribute must be initialised to zero. It
  represents the WebSocket connection close code provided by the server.</p>

  <p>The <dfn id=dom-closeevent-reason><code>reason</code></dfn> attribute must return the
  value it was initialised to. When the object is created, this attribute must be initialised to
  empty string. It represents the WebSocket connection close reason provided by the server.</p>



  <h4 id=garbage-collection-3>9.3.7 Garbage collection</h4>

  <p>A <code id=garbage-collection-3:websocket><a href=#websocket>WebSocket</a></code> object whose <code id=garbage-collection-3:dom-websocket-readystate><a href=#dom-websocket-readystate>readyState</a></code>
  attribute's value was set to <code id=garbage-collection-3:dom-websocket-connecting><a href=#dom-websocket-connecting>CONNECTING</a></code> (0) as of
  the last time the <a id=garbage-collection-3:event-loop href=webappapis.html#event-loop>event loop</a> reached <a href=webappapis.html#step1>step 1</a> must not be garbage collected if there
  are any event listeners registered for <code id=garbage-collection-3:event-open><a href=indices.html#event-open>open</a></code> events, <code id=garbage-collection-3:event-message><a href=indices.html#event-message>message</a></code> events, <code id=garbage-collection-3:event-error><a href=indices.html#event-error>error</a></code> events, or
  <code id=garbage-collection-3:event-close><a href=indices.html#event-close>close</a></code> events.</p>

  <p>A <code id=garbage-collection-3:websocket-2><a href=#websocket>WebSocket</a></code> object whose <code id=garbage-collection-3:dom-websocket-readystate-2><a href=#dom-websocket-readystate>readyState</a></code>
  attribute's value was set to <code id=garbage-collection-3:dom-websocket-open><a href=#dom-websocket-open>OPEN</a></code> (1) as of the last time
  the <a id=garbage-collection-3:event-loop-2 href=webappapis.html#event-loop>event loop</a> reached <a href=webappapis.html#step1>step 1</a> must not be garbage collected if there are any event
  listeners registered for <code id=garbage-collection-3:event-message-2><a href=indices.html#event-message>message</a></code> events, <code id=garbage-collection-3:event-error-2><a href=indices.html#event-error>error</a></code>, or <code id=garbage-collection-3:event-close-2><a href=indices.html#event-close>close</a></code> events.</p>

  <p>A <code id=garbage-collection-3:websocket-3><a href=#websocket>WebSocket</a></code> object whose <code id=garbage-collection-3:dom-websocket-readystate-3><a href=#dom-websocket-readystate>readyState</a></code>
  attribute's value was set to <code id=garbage-collection-3:dom-websocket-closing><a href=#dom-websocket-closing>CLOSING</a></code> (2) as of the
  last time the <a id=garbage-collection-3:event-loop-3 href=webappapis.html#event-loop>event loop</a> reached <a href=webappapis.html#step1>step 1</a> must not be garbage collected if there are
  any event listeners registered for <code id=garbage-collection-3:event-error-3><a href=indices.html#event-error>error</a></code> or <code id=garbage-collection-3:event-close-3><a href=indices.html#event-close>close</a></code> events.</p>

  <p>A <code id=garbage-collection-3:websocket-4><a href=#websocket>WebSocket</a></code> object with <i id=garbage-collection-3:concept-websocket-established><a href=infrastructure.html#concept-websocket-established>an
  established connection</a></i> that has data queued to be transmitted to the network must not be
  garbage collected. <a href=references.html#refsWSP>[WSP]</a></p>

  <p>If a <code id=garbage-collection-3:websocket-5><a href=#websocket>WebSocket</a></code> object is garbage collected while its connection is still open, the
  user agent must <i id=garbage-collection-3:concept-websocket-start-closing-handshake><a href=infrastructure.html#concept-websocket-start-closing-handshake>start the WebSocket closing
  handshake</a></i>, with no status code for the Close message. <a href=references.html#refsWSP>[WSP]</a></p>

  <hr>

  <p>If a user agent is to <dfn id=make-disappear>make disappear</dfn> a <code id=garbage-collection-3:websocket-6><a href=#websocket>WebSocket</a></code> object (this happens
  when a <code id=garbage-collection-3:document><a href=dom.html#document>Document</a></code> object goes away), the user agent must follow the first appropriate
  set of steps from the following list:</p>

  <dl class=switch><dt>If the WebSocket connection is not yet <i id=garbage-collection-3:concept-websocket-established-2><a href=infrastructure.html#concept-websocket-established>established</a></i> <a href=references.html#refsWSP>[WSP]</a><dd>

    <p><i id=garbage-collection-3:concept-websocket-fail><a href=infrastructure.html#concept-websocket-fail>Fail the WebSocket connection</a></i>. <a href=references.html#refsWSP>[WSP]</a></p>

   <dt>If the WebSocket closing handshake has not yet been <i id=garbage-collection-3:concept-websocket-closing-handshake><a href=infrastructure.html#concept-websocket-closing-handshake>started</a></i> <a href=references.html#refsWSP>[WSP]</a><dd>

    <p><i id=garbage-collection-3:concept-websocket-start-closing-handshake-2><a href=infrastructure.html#concept-websocket-start-closing-handshake>Start the WebSocket closing
    handshake</a></i>, with the status code to use in the WebSocket Close message being
    1001. <a href=references.html#refsWSP>[WSP]</a></p>

   <dt>Otherwise<dd>

    <p>Do nothing.</p>

   </dl>


  <h3 id=web-messaging>9.4 <dfn id=crossDocumentMessages>Cross-document messaging</dfn></h3>

  <p>Web browsers, for security and privacy reasons, prevent documents in different domains from
  affecting each other; that is, cross-site scripting is disallowed.</p>

  <p>While this is an important security feature, it prevents pages from different domains from
  communicating even when those pages are not hostile. This section introduces a messaging system
  that allows documents to communicate with each other regardless of their source domain, in a way
  designed to not enable cross-site scripting attacks.</p>

  <p class=note>This API <a href=introduction.html#fingerprint-postMessage>has some privacy implications</a> that
  may not be immediately obvious.</p>

  

  <p>The <a id=web-messaging:task-source href=webappapis.html#task-source>task source</a> for the <a href=webappapis.html#concept-task id=web-messaging:concept-task>tasks</a> in
  <a href=#web-messaging id=web-messaging:web-messaging>cross-document messaging</a> is the <dfn id=posted-message-task-source>posted message task source</dfn>.</p>

  


  <h4 id=introduction-12>9.4.1 Introduction</h4>

  <p><i>This section is non-normative.</i></p>

  <div class=example>

   <p>For example, if document A contains an <code id=introduction-12:the-iframe-element><a href=embedded-content.html#the-iframe-element>iframe</a></code> element that contains document B,
   and script in document A calls <code id=introduction-12:dom-window-postmessage><a href=#dom-window-postmessage>postMessage()</a></code> on the
   <code id=introduction-12:window><a href=browsers.html#window>Window</a></code> object of document B, then a message event will be fired on that object,
   marked as originating from the <code id=introduction-12:window-2><a href=browsers.html#window>Window</a></code> of document A. The script in document A might
   look like:</p>

   <pre>var o = document.getElementsByTagName('iframe')[0];
o.contentWindow.postMessage('Hello world', 'http://b.example.org/');</pre>

   <p>To register an event handler for incoming events, the script would use <code>addEventListener()</code> (or similar mechanisms). For example, the script in document B
   might look like:</p>

   <pre>window.addEventListener('message', receiver, false);
function receiver(e) {
  if (e.origin == 'http://example.com') {
    if (e.data == 'Hello world') {
      e.source.postMessage('Hello', e.origin);
    } else {
      alert(e.data);
    }
  }
}</pre>

   <p>This script first checks the domain is the expected domain, and then looks at the message,
   which it either displays to the user, or responds to by sending a message back to the document
   which sent the message in the first place.</p>

  </div>



  <h4 id=security-postmsg>9.4.2 Security</h4>

  

  <h5 id=authors>9.4.2.1 Authors</h5>

  

  <p id=security-4 class=warning>Use of this API requires extra care to protect users from
  hostile entities abusing a site for their own purposes.</p>

  <p>Authors should check the <code id=authors:dom-messageevent-origin><a href=#dom-messageevent-origin>origin</a></code> attribute to
  ensure that messages are only accepted from domains that they expect to receive messages from.
  Otherwise, bugs in the author's message handling code could be exploited by hostile sites.</p>

  <p>Furthermore, even after checking the <code id=authors:dom-messageevent-origin-2><a href=#dom-messageevent-origin>origin</a></code>
  attribute, authors should also check that the data in question is of the expected format.
  Otherwise, if the source of the event has been attacked using a cross-site scripting flaw, further
  unchecked processing of information sent using the <code id=authors:dom-window-postmessage><a href=#dom-window-postmessage>postMessage()</a></code> method could result in the attack being
  propagated into the receiver.</p>

  <p>Authors should not use the wildcard keyword (*) in the <var>targetOrigin</var>
  argument in messages that contain any confidential information, as otherwise there is no way to
  guarantee that the message is only delivered to the recipient to which it was intended.</p>

  <hr>

  <p>Authors who accept messages from any origin are encouraged to consider the risks of a
  denial-of-service attack. An attacker could send a high volume of messages; if the receiving page
  performs expensive computation or causes network traffic to be sent for each such message, the
  attacker's message could be multplied into a denial-of-service attack. Authors are encouraged to
  employ rate limiting (only accepting a certain number of messages per minute) to make such attacks
  impractical.</p>


  

  <h5 id=user-agents>9.4.2.2 User agents</h5>

  <p>The integrity of this API is based on the inability for scripts of one <a id=user-agents:origin-2 href=browsers.html#origin-2>origin</a> to
  post arbitrary events (using <code>dispatchEvent()</code> or otherwise) to objects in
  other origins (those that are not the <a href=browsers.html#same-origin id=user-agents:same-origin>same</a>).</p>

  <p class=note>Implementors are urged to take extra care in the implementation of this feature.
  It allows authors to transmit information from one domain to another domain, which is normally
  disallowed for security reasons. It also requires that UAs be careful to allow access to certain
  properties but not others.</p>

  <hr>

  <p>User agents are also encouraged to consider rate-limiting message traffic between different
  <a href=browsers.html#origin-2 id=user-agents:origin-2-2>origins</a>, to protect naïve sites from denial-of-service
  attacks.</p>

  




  <h4 id=posting-messages>9.4.3 Posting messages</h4>

  <dl class=domintro><dt><var>window</var> . <code id=posting-messages:dom-window-postmessage><a href=#dom-window-postmessage>postMessage</a></code>(<var>message</var>, <var>targetOrigin</var> [, <var>transfer</var> ] )<dd>

    <p>Posts a message to the given window. Messages can be structured objects, e.g. nested objects
    and arrays, can contain JavaScript values (strings, numbers, <code id=posting-messages:idl-date><a href=infrastructure.html#idl-date>Date</a></code>
    objects, etc), and can contain certain data objects such as <code id=posting-messages:file><a href=infrastructure.html#file>File</a></code> <code id=posting-messages:blob><a href=infrastructure.html#blob>Blob</a></code>,
    <code id=posting-messages:filelist><a href=infrastructure.html#filelist>FileList</a></code>, and <code id=posting-messages:arraybuffer><a href=infrastructure.html#arraybuffer>ArrayBuffer</a></code> objects.</p>

    <p>Objects listed in <var>transfer</var> are transferred, not just cloned, meaning that
    they are no longer usable on the sending side.</p>

    <p>If the origin of the target window doesn't match the given origin, the message is discarded,
    to avoid information leakage. To send the message to the target regardless of origin, set the
    target origin to "<code>*</code>". To restrict the message to same-origin targets only,
    without needing to explicitly state the origin, set the target origin to "<code>/</code>".</p>

    <p>Throws a <code id=posting-messages:datacloneerror><a href=infrastructure.html#datacloneerror>DataCloneError</a></code> exception if <var>transfer</var> array contains
    duplicate objects or if <var>message</var> could not be cloned.</p>

   </dl>

  <p class=note>When posting a message to a <code id=posting-messages:window><a href=browsers.html#window>Window</a></code> of a <a id=posting-messages:browsing-context href=browsers.html#browsing-context>browsing context</a>
  that has just been navigated to a new <code id=posting-messages:document><a href=dom.html#document>Document</a></code> is likely to result in the message not
  receiving its intended recipient: the scripts in the target <a id=posting-messages:browsing-context-2 href=browsers.html#browsing-context>browsing context</a> have to
  have had time to set up listeners for the messages. Thus, for instance, in situations where a
  message is to be sent to the <code id=posting-messages:window-2><a href=browsers.html#window>Window</a></code> of newly created child <code id=posting-messages:the-iframe-element><a href=embedded-content.html#the-iframe-element>iframe</a></code>,
  authors are advised to have the child <code id=posting-messages:document-2><a href=dom.html#document>Document</a></code> post a message to their parent
  announcing their readiness to receive messages, and for the parent to wait for this message before
  beginning posting messages.</p>

  

  <p>When a script invokes the <dfn id=dom-window-postmessage><code>postMessage(<var>message</var>, <var>targetOrigin</var>, <var>transfer</var>)</code></dfn> method (with two or three arguments) on a
  <code id=posting-messages:window-3><a href=browsers.html#window>Window</a></code> object, the user agent must follow these steps:</p>

  <ol><li><p>If the value of the <var>targetOrigin</var> argument is neither a single U+002A
   ASTERISK character (*), a single U+002F SOLIDUS character (/), nor an <a id=posting-messages:absolute-url href=infrastructure.html#absolute-url>absolute URL</a>,
   then throw a <code id=posting-messages:syntaxerror><a href=infrastructure.html#syntaxerror>SyntaxError</a></code> exception and abort the overall set of steps.<li><p>Let <var>new ports</var> be an empty array.<li><p>Let <var>transfer map</var> be an empty association list of
   <code id=posting-messages:transferable><a href=infrastructure.html#transferable>Transferable</a></code> objects to placeholder objects.<li>

    <p>If the method was invoked with a third argument <var>transfer</var>, run these
    substeps:</p>

    <ol><li><p>If any object is listed in <var>transfer</var> more than once, or any of the
     <code id=posting-messages:transferable-2><a href=infrastructure.html#transferable>Transferable</a></code> objects listed in <var>transfer</var> are marked as <a href=infrastructure.html#concept-transferable-neutered id=posting-messages:concept-transferable-neutered>neutered</a>, then throw a
     <code id=posting-messages:datacloneerror-2><a href=infrastructure.html#datacloneerror>DataCloneError</a></code> exception and abort these steps.<li><p>For each object <var>x</var> in <var>transfer</var> in turn, add a
     mapping from <var>x</var> to a new unique placeholder object created for <var>x</var> to <var>transfer map</var>, and if <var>x</var> is a
     <code id=posting-messages:messageport><a href=#messageport>MessagePort</a></code> object, also append the placeholder object to the <var>new
     ports</var> array.</ol>

   <li><p>Let <var>message clone</var> be the result of obtaining a <a id=posting-messages:structured-clone href=infrastructure.html#structured-clone>structured
   clone</a> of the <var>message</var> argument, with <var>transfer map</var>
   as the <i>transfer map</i>. If this throws an exception, then throw that exception and abort
   these steps.<li>

    <p>If the method was invoked with a third argument <var>transfer</var>, run these
    substeps:</p>

    <ol><li><p>Let <var>new owner</var> be the <a id=posting-messages:environment-settings-object href=webappapis.html#environment-settings-object>environment settings object</a> of the
     <code id=posting-messages:window-4><a href=browsers.html#window>Window</a></code> object on which the method was invoked.<li><p>For each object <var>x</var> in <var>transfer</var> in turn, obtain
     a new object <var>y</var> by <a href=infrastructure.html#transfer-a-transferable-object id=posting-messages:transfer-a-transferable-object>transferring</a> the object <var>x</var> to <var>new
     owner</var>, and replace the placeholder object that was created for the object <var>x</var> by the new object <var>y</var> wherever the placeholder exists
     (i.e. in <var>message clone</var> and in <var>new ports</var>).</ol>

   <li><p>Make <var>new ports</var> into a <a href=infrastructure.html#dfn-read-only-array id=posting-messages:dfn-read-only-array>read
   only</a> array.<li><p>Return from the <code id=posting-messages:dom-window-postmessage-2><a href=#dom-window-postmessage>postMessage()</a></code> method, but
   <a id=posting-messages:in-parallel href=infrastructure.html#in-parallel>in parallel</a> continue running these steps.<li>

    <p>If the <var>targetOrigin</var> argument is a single literal U+002F SOLIDUS
    character (/), and the <code id=posting-messages:document-3><a href=dom.html#document>Document</a></code> of the <code id=posting-messages:window-5><a href=browsers.html#window>Window</a></code> object on which the
    method was invoked does not have the <a id=posting-messages:same-origin href=browsers.html#same-origin>same origin</a> as the <a id=posting-messages:responsible-document href=webappapis.html#responsible-document>responsible
    document</a> specified by the <a id=posting-messages:entry-settings-object href=webappapis.html#entry-settings-object>entry settings object</a>, then abort these steps
    silently.</p>

    <p>Otherwise, if the <var>targetOrigin</var> argument is an <a id=posting-messages:absolute-url-2 href=infrastructure.html#absolute-url>absolute URL</a>,
    and the <code id=posting-messages:document-4><a href=dom.html#document>Document</a></code> of the <code id=posting-messages:window-6><a href=browsers.html#window>Window</a></code> object on which the method was invoked
    does not have the <a id=posting-messages:same-origin-2 href=browsers.html#same-origin>same origin</a> as <var>targetOrigin</var>, then abort
    these steps silently.</p>

    <p>Otherwise, the <var>targetOrigin</var> argument is a single literal U+002A ASTERISK
    character (*), and no origin check is made.</p>

   <li><p>Create a <a href=infrastructure.html#concept-events-trusted id=posting-messages:concept-events-trusted>trusted</a> event that uses the
   <code id=posting-messages:messageevent><a href=#messageevent>MessageEvent</a></code> interface, with the event type <code id=posting-messages:event-message><a href=indices.html#event-message>message</a></code>, which does not bubble, is not cancelable, and has no
   default action. The <code id=posting-messages:dom-messageevent-data><a href=#dom-messageevent-data>data</a></code> attribute must be
   initialised to the value of <var>message clone</var>, the <code id=posting-messages:dom-messageevent-origin><a href=#dom-messageevent-origin>origin</a></code> attribute must be initialised to the <a href=browsers.html#unicode-serialisation-of-an-origin id=posting-messages:unicode-serialisation-of-an-origin>Unicode serialisation</a> of the
   <a id=posting-messages:origin-2 href=browsers.html#origin-2>origin</a> specified by the <a id=posting-messages:incumbent-settings-object href=webappapis.html#incumbent-settings-object>incumbent settings object</a>, the <code id=posting-messages:dom-messageevent-source><a href=#dom-messageevent-source>source</a></code> attribute must be initialised to the
   <code id=posting-messages:windowproxy><a href=browsers.html#windowproxy>WindowProxy</a></code> object corresponding to the <a id=posting-messages:global-object href=webappapis.html#global-object>global object</a> (a
   <code id=posting-messages:window-7><a href=browsers.html#window>Window</a></code> object) specified by the <a id=posting-messages:incumbent-settings-object-2 href=webappapis.html#incumbent-settings-object>incumbent settings object</a>, and the
   <code id=posting-messages:dom-messageevent-ports><a href=#dom-messageevent-ports>ports</a></code> attribute must be initialised to the <var>new
   ports</var> array.<li><p><a id=posting-messages:queue-a-task href=webappapis.html#queue-a-task>Queue a task</a> to <a href=infrastructure.html#concept-event-dispatch id=posting-messages:concept-event-dispatch>dispatch</a> the
   event created in the previous step at the <code id=posting-messages:window-8><a href=browsers.html#window>Window</a></code> object on which the method was
   invoked. The <a id=posting-messages:task-source href=webappapis.html#task-source>task source</a> for this <a href=webappapis.html#concept-task id=posting-messages:concept-task>task</a> is the
   <a href=#posted-message-task-source id=posting-messages:posted-message-task-source>posted message task source</a>.</ol>

  




  <h3 id=channel-messaging>9.5 <dfn>Channel messaging</dfn></h3>

  <h4 id=introduction-13>9.5.1 Introduction</h4>

  <p><i>This section is non-normative.</i></p>

  <p>To enable independent pieces of code (e.g. running in different <a href=browsers.html#browsing-context id=introduction-13:browsing-context>browsing contexts</a>) to communicate directly, authors can use <a href=#channel-messaging id=introduction-13:channel-messaging>channel
  messaging</a>.</p>

  <p>Communication channels in this mechanism are implemented as two-ways pipes, with a port at each
  end. Messages sent in one port are delivered at the other port, and vice-versa. Messages are
  delivered as DOM events, without interrupting or blocking running <a href=webappapis.html#concept-task id=introduction-13:concept-task>tasks</a>.</p>

  <p>To create a connection (two "entangled" ports), the <code>MessageChannel()</code>
  constructor is called:</p>

  <pre>var channel = new MessageChannel();</pre>

  <p>One of the ports is kept as the local port, and the other port is sent to the remote code, e.g.
  using <code id=introduction-13:dom-window-postmessage><a href=#dom-window-postmessage>postMessage()</a></code>:</p>

  <pre>otherWindow.postMessage('hello', 'http://example.com', [channel.port2]);</pre>

  <p>To send messages, the <code id=introduction-13:dom-messageport-postmessage><a href=#dom-messageport-postmessage>postMessage()</a></code> method on
  the port is used:</p>

  <pre>channel.port1.postMessage('hello');</pre>

  <p>To receive messages, one listens to <code id=introduction-13:event-message><a href=indices.html#event-message>message</a></code> events:</p>

  <pre>channel.port1.onmessage = handleMessage;
function handleMessage(event) {
  // message is in event.data
  // ...
}</pre>

  <p>Data sent on a port can be structured data; for example here an array of strings is passed on a
  <code id=introduction-13:messageport><a href=#messageport>MessagePort</a></code>:</p>

  <pre>port1.postMessage(['hello', 'world']);</pre>


  <h5 id=examples-5>9.5.1.1 Examples</h5>

  <p><i>This section is non-normative.</i></p>

  <div class=example>

   <p>In this example, two JavaScript libraries are connected to each other using
   <code id=examples-5:messageport><a href=#messageport>MessagePort</a></code>s. This allows the libraries to later be hosted in different frames, or
   in <code id=examples-5:worker><a href=workers.html#worker>Worker</a></code> objects, without any change to the APIs.</p>

   <pre>&lt;script src="contacts.js">&lt;/script> &lt;!-- exposes a contacts object -->
&lt;script src="compose-mail.js">&lt;/script> &lt;!-- exposes a composer object -->
&lt;script>
 var channel = new MessageChannel();
 composer.addContactsProvider(channel.port1);
 contacts.registerConsumer(channel.port2);
&lt;/script></pre>

   <p>Here's what the "addContactsProvider()" function's implementation could look like:</p>

   <pre>function addContactsProvider(port) {
  port.onmessage = function (event) {
    switch (event.data.messageType) {
      'search-result': handleSearchResult(event.data.results); break;
      'search-done': handleSearchDone(); break;
      'search-error': handleSearchError(event.data.message); break;
      // ...
    }
  };
};</pre>

   <p>Alternatively, it could be implemented as follows:</p>

   <pre>function addContactsProvider(port) {
  port.addEventListener('message', function (event) {
    if (event.data.messageType == 'search-result')
      handleSearchResult(event.data.results);
  });
  port.addEventListener('message', function (event) {
    if (event.data.messageType == 'search-done')
      handleSearchDone();
  });
  port.addEventListener('message', function (event) {
    if (event.data.messageType == 'search-error')
      handleSearchError(event.data.message);
  });
  // ...
  port.start();
};</pre>

   <p>The key difference is that when using <code id=examples-5:dom-eventtarget-addeventlistener><a href=infrastructure.html#dom-eventtarget-addeventlistener>addEventListener()</a></code>, the <code id=examples-5:dom-messageport-start><a href=#dom-messageport-start>start()</a></code> method must also be invoked. When using <code id=examples-5:handler-messageport-onmessage><a href=#handler-messageport-onmessage>onmessage</a></code>, the call to <code id=examples-5:dom-messageport-start-2><a href=#dom-messageport-start>start()</a></code> is implied.</p>

   <p>The <code id=examples-5:dom-messageport-start-3><a href=#dom-messageport-start>start()</a></code> method, whether called explicitly or
   implicitly (by setting <code id=examples-5:handler-messageport-onmessage-2><a href=#handler-messageport-onmessage>onmessage</a></code>), starts the
   flow of messages: messages posted on message ports are initially paused, so that they don't get
   dropped on the floor before the script has had a chance to set up its handlers.</p>

  </div>


  <h5 id=ports-as-the-basis-of-an-object-capability-model-on-the-web>9.5.1.2 Ports as the basis of an object-capability model on the Web</h5>

  <p><i>This section is non-normative.</i></p>

  <p>Ports can be viewed as a way to expose limited capabilities (in the object-capability model
  sense) to other actors in the system. This can either be a weak capability system, where the ports
  are merely used as a convenient model within a particular origin, or as a strong capability model,
  where they are provided by one origin <var>provider</var> as the only mechanism by which
  another origin <var>consumer</var> can effect change in or obtain information from <var>provider</var>.</p>

  <p>For example, consider a situation in which a social Web site embeds in one <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element><a href=embedded-content.html#the-iframe-element>iframe</a></code>
  the user's e-mail contacts provider (an address book site, from a second origin), and in a second
  <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-2><a href=embedded-content.html#the-iframe-element>iframe</a></code> a game (from a third origin). The outer social site and the game in the second
  <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-3><a href=embedded-content.html#the-iframe-element>iframe</a></code> cannot access anything inside the first <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-4><a href=embedded-content.html#the-iframe-element>iframe</a></code>; together they can
  only:</p>

  <ul class=brief><li><a id=ports-as-the-basis-of-an-object-capability-model-on-the-web:navigate href=browsers.html#navigate>Navigate</a> the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-5><a href=embedded-content.html#the-iframe-element>iframe</a></code> to a new <a id=ports-as-the-basis-of-an-object-capability-model-on-the-web:url href=infrastructure.html#url>URL</a>, such as the same
   <a id=ports-as-the-basis-of-an-object-capability-model-on-the-web:url-2 href=infrastructure.html#url>URL</a> but with a different fragment identifier, causing the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:window><a href=browsers.html#window>Window</a></code> in the
   <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-6><a href=embedded-content.html#the-iframe-element>iframe</a></code> to receive a <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:event-hashchange><a href=indices.html#event-hashchange>hashchange</a></code> event.<li>Resize the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-7><a href=embedded-content.html#the-iframe-element>iframe</a></code>, causing the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:window-2><a href=browsers.html#window>Window</a></code> in the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-8><a href=embedded-content.html#the-iframe-element>iframe</a></code> to
   receive a <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:event-resize><a href=infrastructure.html#event-resize>resize</a></code> event.<li>Send a <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:event-message><a href=indices.html#event-message>message</a></code> event to the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:window-3><a href=browsers.html#window>Window</a></code> in the
   <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-9><a href=embedded-content.html#the-iframe-element>iframe</a></code> using the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:dom-window-postmessage><a href=#dom-window-postmessage>window.postMessage()</a></code>
   API.</ul>

  <p>The contacts provider can use these methods, most particularly the third one, to provide an API
  that can be accessed by other origins to manipulate the user's address book. For example, it could
  respond to a message "<code>add-contact Guillaume Tell
  &lt;tell@pomme.example.net></code>" by adding the given person and e-mail address to the user's
  address book.</p>

  <p>To avoid any site on the Web being able to manipulate the user's contacts, the contacts
  provider might only allow certain trusted sites, such as the social site, to do this.</p>

  <p>Now suppose the game wanted to add a contact to the user's address book, and that the social
  site was willing to allow it to do so on its behalf, essentially "sharing" the trust that the
  contacts provider had with the social site. There are several ways it could do this; most simply,
  it could just proxy messages between the game site and the contacts site. However, this solution
  has a number of difficulties: it requires the social site to either completely trust the game site
  not to abuse the privilege, or it requires that the social site verify each request to make sure
  it's not a request that it doesn't want to allow (such as adding multiple contacts, reading the
  contacts, or deleting them); it also requires some additional complexity if there's ever the
  possibility of multiple games simultaneously trying to interact with the contacts provider.</p>

  <p>Using message channels and <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:messageport><a href=#messageport>MessagePort</a></code> objects, however, all of these problems can
  go away. When the game tells the social site that it wants to add a contact, the social site can
  ask the contacts provider not for it to add a contact, but for the <em>capability</em> to add a
  single contact. The contacts provider then creates a pair of <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:messageport-2><a href=#messageport>MessagePort</a></code> objects, and
  sends one of them back to the social site, who forwards it on to the game. The game and the
  contacts provider then have a direct connection, and the contacts provider knows to only honor a
  single "add contact" request, nothing else. In other words, the game has been granted the
  capability to add a single contact.</p>


  <h5 id=ports-as-the-basis-of-abstracting-out-service-implementations>9.5.1.3 Ports as the basis of abstracting out service implementations</h5>

  <p><i>This section is non-normative.</i></p>

  <p>Continuing the example from the previous section, consider the contacts provider in particular.
  While an initial implementation might have simply used <code id=ports-as-the-basis-of-abstracting-out-service-implementations:xmlhttprequest><a href=infrastructure.html#xmlhttprequest>XMLHttpRequest</a></code> objects in the
  service's <code id=ports-as-the-basis-of-abstracting-out-service-implementations:the-iframe-element><a href=embedded-content.html#the-iframe-element>iframe</a></code>, an evolution of the service might instead want to use a <a href=workers.html#sharedworker id=ports-as-the-basis-of-abstracting-out-service-implementations:sharedworker>shared worker</a> with a single <code id=ports-as-the-basis-of-abstracting-out-service-implementations:websocket><a href=#websocket>WebSocket</a></code> connection.</p>

  <p>If the initial design used <code id=ports-as-the-basis-of-abstracting-out-service-implementations:messageport><a href=#messageport>MessagePort</a></code> objects to grant capabilities, or even just
  to allow multiple simultaneous independent sessions, the service implementation can switch from
  the <code id=ports-as-the-basis-of-abstracting-out-service-implementations:xmlhttprequest-2><a href=infrastructure.html#xmlhttprequest>XMLHttpRequest</a></code>s-in-each-<code id=ports-as-the-basis-of-abstracting-out-service-implementations:the-iframe-element-2><a href=embedded-content.html#the-iframe-element>iframe</a></code> model to the
  shared-<code id=ports-as-the-basis-of-abstracting-out-service-implementations:websocket-2><a href=#websocket>WebSocket</a></code> model without changing the API at all: the ports on the service
  provider side can all be forwarded to the shared worker without it affecting the users of the API
  in the slightest.</p>



  <h4 id=message-channels>9.5.2 Message channels</h4>

  <pre class=idl>[<a href=#dom-messagechannel id=message-channels:dom-messagechannel>Constructor</a>, Exposed=(Window,Worker)]
interface <dfn id=messagechannel>MessageChannel</dfn> {
  readonly attribute <a href=#messageport id=message-channels:messageport>MessagePort</a> <a href=#dom-messagechannel-port1 id=message-channels:dom-messagechannel-port1>port1</a>;
  readonly attribute <a href=#messageport id=message-channels:messageport-2>MessagePort</a> <a href=#dom-messagechannel-port2 id=message-channels:dom-messagechannel-port2>port2</a>;
};</pre>

  <dl class=domintro><dt><var>channel</var> = new <code id=message-channels:dom-messagechannel-2><a href=#dom-messagechannel>MessageChannel</a></code>()<dd>

    <p>Returns a new <code id=message-channels:messagechannel><a href=#messagechannel>MessageChannel</a></code> object with two new <code id=message-channels:messageport-3><a href=#messageport>MessagePort</a></code> objects.</p>

   <dt><var>channel</var> . <code id=message-channels:dom-messagechannel-port1-2><a href=#dom-messagechannel-port1>port1</a></code><dd>

    <p>Returns the first <code id=message-channels:messageport-4><a href=#messageport>MessagePort</a></code> object.</p>

   <dt><var>channel</var> . <code id=message-channels:dom-messagechannel-port2-2><a href=#dom-messagechannel-port2>port2</a></code><dd>

    <p>Returns the second <code id=message-channels:messageport-5><a href=#messageport>MessagePort</a></code> object.</p>

   </dl>

  

  <p>When the <dfn id=dom-messagechannel><code>MessageChannel()</code></dfn> constructor is
  called, it must run the following algorithm:</p>

  <ol><li><p><a href=#create-a-new-messageport-object id=message-channels:create-a-new-messageport-object>Create a new <code>MessagePort</code> object</a> whose <a href=#concept-port-owner id=message-channels:concept-port-owner>owner</a> is the <a id=message-channels:incumbent-settings-object href=webappapis.html#incumbent-settings-object>incumbent settings object</a>, and let
   <var>port1</var> be that object.<li><p><a href=#create-a-new-messageport-object id=message-channels:create-a-new-messageport-object-2>Create a new <code>MessagePort</code> object</a> whose <a href=#concept-port-owner id=message-channels:concept-port-owner-2>owner</a> is the <a id=message-channels:incumbent-settings-object-2 href=webappapis.html#incumbent-settings-object>incumbent settings object</a>, and let
   <var>port2</var> be that object.<li><p><a href=#entangle id=message-channels:entangle>Entangle</a> the <var>port1</var> and <var>port2</var> objects.<li><p>Instantiate a new <code id=message-channels:messagechannel-2><a href=#messagechannel>MessageChannel</a></code> object, and let <var>channel</var> be that
   object.<li><p>Let the <code id=message-channels:dom-messagechannel-port1-3><a href=#dom-messagechannel-port1>port1</a></code> attribute of the
   <var>channel</var> object be <var>port1</var>.</p>

   <li><p>Let the <code id=message-channels:dom-messagechannel-port2-3><a href=#dom-messagechannel-port2>port2</a></code> attribute of the
   <var>channel</var> object be <var>port2</var>.</p>

   <li><p>Return <var>channel</var>.</ol>

  <p>The <dfn id=dom-messagechannel-port1><code>port1</code></dfn> and <dfn id=dom-messagechannel-port2><code>port2</code></dfn> attributes must return the values they were
  assigned when the <code id=message-channels:messagechannel-3><a href=#messagechannel>MessageChannel</a></code> object was created.</p>

  



  <h4 id=message-ports>9.5.3 Message ports</h4>

  <p>Each channel has two message ports. Data sent through one port is received by the other port,
  and vice versa.</p>

  <pre class=idl>[Exposed=(Window,Worker)]
interface <dfn id=messageport>MessagePort</dfn> : <a id=message-ports:eventtarget href=infrastructure.html#eventtarget>EventTarget</a> {
  void <a href=#dom-messageport-postmessage id=message-ports:dom-messageport-postmessage>postMessage</a>(any message, optional sequence&lt;<a id=message-ports:transferable href=infrastructure.html#transferable>Transferable</a>> transfer);
  void <a href=#dom-messageport-start id=message-ports:dom-messageport-start>start</a>();
  void <a href=#dom-messageport-close id=message-ports:dom-messageport-close>close</a>();

  // event handlers
  attribute <a id=message-ports:eventhandler href=webappapis.html#eventhandler>EventHandler</a> <a href=#handler-messageport-onmessage id=message-ports:handler-messageport-onmessage>onmessage</a>;
};
// <a href=#messageport id=message-ports:messageport>MessagePort</a> implements <a id=message-ports:transferable-2 href=infrastructure.html#transferable>Transferable</a>;</pre>

  <dl class=domintro><dt><var>port</var> . <code id=message-ports:dom-messageport-postmessage-2><a href=#dom-messageport-postmessage>postMessage</a></code>(<var>message</var> [, <var>transfer</var>] )<dd>

    <p>Posts a message through the channel. Objects listed in <var>transfer</var> are
    transferred, not just cloned, meaning that they are no longer usable on the sending side.</p>

    <p>Throws a <code id=message-ports:datacloneerror><a href=infrastructure.html#datacloneerror>DataCloneError</a></code> exception if <var>transfer</var> array contains
    duplicate objects or the source or target ports, or if <var>message</var> could not be
    cloned.</p>

   <dt><var>port</var> . <code id=message-ports:dom-messageport-start-2><a href=#dom-messageport-start>start</a></code>()<dd>

    <p>Begins dispatching messages received on the port.</p>

   <dt><var>port</var> . <code id=message-ports:dom-messageport-close-2><a href=#dom-messageport-close>close</a></code>()<dd>

    <p>Disconnects the port, so that it is no longer active.</p>

   </dl>

  

  <p>Each <code id=message-ports:messageport-2><a href=#messageport>MessagePort</a></code> object can be entangled with another (a symmetric relationship).
  Each <code id=message-ports:messageport-3><a href=#messageport>MessagePort</a></code> object also has a <a id=message-ports:task-source href=webappapis.html#task-source>task source</a> called the <dfn id=port-message-queue>port
  message queue</dfn>, initially empty. A <a href=#port-message-queue id=message-ports:port-message-queue>port message queue</a> can be enabled or
  disabled, and is initially disabled. Once enabled, a port can never be disabled again (though
  messages in the queue can get moved to another queue or removed altogether, which has much the
  same effect). A <code id=message-ports:messageport-4><a href=#messageport>MessagePort</a></code> also has a <dfn id=has-been-shipped>has been shipped</dfn> flag, which must
  initially be false, and an <dfn id=concept-port-owner>owner</dfn>, which is a <a id=message-ports:settings-object href=webappapis.html#settings-object>settings
  object</a> set when the object is created, as described below.</p>

  <p>When a port's <a href=#port-message-queue id=message-ports:port-message-queue-2>port message queue</a> is enabled, the <a id=message-ports:event-loop href=webappapis.html#event-loop>event loop</a> must use
  it as one of its <a href=webappapis.html#task-source id=message-ports:task-source-2>task sources</a>. When a port's <a href=#concept-port-owner id=message-ports:concept-port-owner>owner</a> specifies a <a id=message-ports:responsible-event-loop href=webappapis.html#responsible-event-loop>responsible event loop</a> that is a
  <a id=message-ports:browsing-context href=browsers.html#browsing-context>browsing context</a> <a id=message-ports:event-loop-2 href=webappapis.html#event-loop>event loop</a>, all <a href=webappapis.html#concept-task id=message-ports:concept-task>tasks</a> <a href=webappapis.html#queue-a-task id=message-ports:queue-a-task>queued</a> on its <a href=#port-message-queue id=message-ports:port-message-queue-3>port
  message queue</a> must be associated with the <a id=message-ports:responsible-document href=webappapis.html#responsible-document>responsible document</a> specified by
  the port's <a href=#concept-port-owner id=message-ports:concept-port-owner-2>owner</a>.</p>

  <p class=note>If the port's <a href=#concept-port-owner id=message-ports:concept-port-owner-3>owner</a> specifies a
  <a id=message-ports:responsible-document-2 href=webappapis.html#responsible-document>responsible document</a> that is <a id=message-ports:fully-active href=browsers.html#fully-active>fully active</a>, but the event listeners all
  have scripts whose <a href=webappapis.html#settings-object id=message-ports:settings-object-2>settings objects</a> specify <a href=webappapis.html#responsible-document id=message-ports:responsible-document-3>responsible documents</a> that are <em>not</em> <a id=message-ports:fully-active-2 href=browsers.html#fully-active>fully
  active</a>, then the messages will be lost.</p> 

  <p>Each <a id=message-ports:event-loop-3 href=webappapis.html#event-loop>event loop</a> has a <a id=message-ports:task-source-3 href=webappapis.html#task-source>task source</a> called the <dfn id=unshipped-port-message-queue>unshipped port
  message queue</dfn>. This is a virtual <a id=message-ports:task-source-4 href=webappapis.html#task-source>task source</a>: it must act as if it contained
  the <a href=webappapis.html#concept-task id=message-ports:concept-task-2>tasks</a> of each <a href=#port-message-queue id=message-ports:port-message-queue-4>port message queue</a> of each
  <code id=message-ports:messageport-5><a href=#messageport>MessagePort</a></code> whose <a href=#has-been-shipped id=message-ports:has-been-shipped>has been shipped</a> flag is false, whose <a href=#port-message-queue id=message-ports:port-message-queue-5>port
  message queue</a> is enabled, and whose <a href=#concept-port-owner id=message-ports:concept-port-owner-4>owner</a>
  specifies that <a id=message-ports:event-loop-4 href=webappapis.html#event-loop>event loop</a> as the <a id=message-ports:responsible-event-loop-2 href=webappapis.html#responsible-event-loop>responsible event loop</a>, in the order in
  which they were added to their respective <a id=message-ports:task-source-5 href=webappapis.html#task-source>task source</a>. When a <a href=webappapis.html#concept-task id=message-ports:concept-task-3>task</a> would be removed from the <a href=#unshipped-port-message-queue id=message-ports:unshipped-port-message-queue>unshipped port message
  queue</a>, it must instead be removed from its <a href=#port-message-queue id=message-ports:port-message-queue-6>port message queue</a>.</p>

  <p>When a <code id=message-ports:messageport-6><a href=#messageport>MessagePort</a></code>'s <a href=#has-been-shipped id=message-ports:has-been-shipped-2>has been shipped</a> flag is false, its <a href=#port-message-queue id=message-ports:port-message-queue-7>port
  message queue</a> must be ignored for the purposes of the <a id=message-ports:event-loop-5 href=webappapis.html#event-loop>event loop</a>. (The
  <a href=#unshipped-port-message-queue id=message-ports:unshipped-port-message-queue-2>unshipped port message queue</a> is used instead.)</p>

  <p class=note>The <a href=#has-been-shipped id=message-ports:has-been-shipped-3>has been shipped</a> flag is set to true when a port, its twin, or
  the object it was cloned from, is or has been <a href=infrastructure.html#transfer-a-transferable-object id=message-ports:transfer-a-transferable-object>transferred</a>. When a <code id=message-ports:messageport-7><a href=#messageport>MessagePort</a></code>'s <a href=#has-been-shipped id=message-ports:has-been-shipped-4>has been shipped</a> flag
  is true, its <a href=#port-message-queue id=message-ports:port-message-queue-8>port message queue</a> acts as a first-class <a id=message-ports:task-source-6 href=webappapis.html#task-source>task source</a>,
  unaffected to any <a href=#unshipped-port-message-queue id=message-ports:unshipped-port-message-queue-3>unshipped port message queue</a>.</p>

  <p>When the user agent is to <dfn id=create-a-new-messageport-object>create a new <code>MessagePort</code> object</dfn> with a
  particular <a id=message-ports:settings-object-3 href=webappapis.html#settings-object>settings object</a> as its <var>owner</var>, it must instantiate a
  new <code id=message-ports:messageport-8><a href=#messageport>MessagePort</a></code> object, and let its <a href=#concept-port-owner id=message-ports:concept-port-owner-5>owner</a> be
  <var>owner</var>.</p>

  <p>When the user agent is to <dfn id=entangle>entangle</dfn> two <code id=message-ports:messageport-9><a href=#messageport>MessagePort</a></code> objects, it must run
  the following steps:</p>

  <ol><li>

    <p>If one of the ports is already entangled, then disentangle it and the port that it was
    entangled with.</p>

    <p class=note>If those two previously entangled ports were the two ports of a
    <code id=message-ports:messagechannel><a href=#messagechannel>MessageChannel</a></code> object, then that <code id=message-ports:messagechannel-2><a href=#messagechannel>MessageChannel</a></code> object no longer
    represents an actual channel: the two ports in that object are no longer entangled.</p>

   <li>

    <p>Associate the two ports to be entangled, so that they form the two parts of a new channel.
    (There is no <code id=message-ports:messagechannel-3><a href=#messagechannel>MessageChannel</a></code> object that represents this channel.)</p>

    <p>Two ports <var>A</var> and <var>B</var> that have gone through this step
    are now said to be entangled; one is entangled to the other, and vice versa.</p>

    <p class=note>While this specification describes this process as instantaneous,
    implementations are more likely to implement it via message passing. As with all algorithms, the
    key is "merely" that the end result be indistinguishable, in a black-box sense, from the
    specification.</p>

   </ol>

  <p>When the user agent is to <dfn id=clone-a-port>clone a port</dfn> <var>original port</var>, with the
  clone being owned by <var>owner</var>, it must run the following steps, which return a
  new <code id=message-ports:messageport-10><a href=#messageport>MessagePort</a></code> object. These steps must be run atomically.</p>

  <ol><li><p>Set <var>original port</var>'s <a href=#has-been-shipped id=message-ports:has-been-shipped-5>has been shipped</a> flag to
   true.<li><p><a href=#create-a-new-messageport-object id=message-ports:create-a-new-messageport-object>Create a new <code>MessagePort</code> object</a> whose <a href=#concept-port-owner id=message-ports:concept-port-owner-6>owner</a> is <var>owner</var>, and let <var>new port</var> be that object.<li><p>Set <var>new port</var>'s <a href=#has-been-shipped id=message-ports:has-been-shipped-6>has been shipped</a> flag to true.<li><p>Move all the <a href=webappapis.html#concept-task id=message-ports:concept-task-4>tasks</a> that are to fire <code id=message-ports:event-message><a href=indices.html#event-message>message</a></code> events in the <a href=#port-message-queue id=message-ports:port-message-queue-9>port message queue</a> of <var>original port</var> to the <a href=#port-message-queue id=message-ports:port-message-queue-10>port message queue</a> of <var>new
   port</var>, if any, leaving the <var>new port</var>'s <a href=#port-message-queue id=message-ports:port-message-queue-11>port message queue</a>
   in its initial disabled state, and, if the <var>new port</var>'s <a href=#concept-port-owner id=message-ports:concept-port-owner-7>owner</a> specifies a <a id=message-ports:responsible-event-loop-3 href=webappapis.html#responsible-event-loop>responsible event loop</a> that is
   a <a id=message-ports:browsing-context-2 href=browsers.html#browsing-context>browsing context</a> <a id=message-ports:event-loop-6 href=webappapis.html#event-loop>event loop</a>, associating the moved <a href=webappapis.html#concept-task id=message-ports:concept-task-5>tasks</a> with the <a id=message-ports:responsible-document-4 href=webappapis.html#responsible-document>responsible document</a> specified by <var>new port</var>'s <a href=#concept-port-owner id=message-ports:concept-port-owner-8>owner</a>.<li>

    <p>If the <var>original port</var> is entangled with another port, then run these
    substeps:</p>

    <ol><li><p>Let the <var>remote port</var> be the port with which the <var>original port</var> is entangled.<li><p>Set <var>remote port</var>'s <a href=#has-been-shipped id=message-ports:has-been-shipped-7>has been shipped</a> flag to
     true.<li><p><a href=#entangle id=message-ports:entangle>Entangle</a> the <var>remote port</var> and <var>new
     port</var> objects. The <var>original port</var> object will be disentangled by this
     process.</ol>

   <li><p>Return <var>new port</var>. It is the clone.</ol>

  <p id=transferMessagePort>To <a href=infrastructure.html#transfer-a-transferable-object id=message-ports:transfer-a-transferable-object-2>transfer</a> a
  <code id=message-ports:messageport-11><a href=#messageport>MessagePort</a></code> object <var>old</var> to a new owner <var>owner</var>,
  a user agent must <a href=#clone-a-port id=message-ports:clone-a-port>clone</a> the <var>old</var> object with
  the clone being owned by <var>owner</var>, thus obtaining <var>new</var>, must
  <a href=infrastructure.html#concept-transferable-neutered id=message-ports:concept-transferable-neutered>neuter</a> the <var>old</var> port, and
  must finally return <var>new</var>.</p>

  <hr>

  <p>The <dfn id=dom-messageport-postmessage><code>postMessage()</code></dfn> method, when
  called on a port <var>source port</var>, must cause the user agent to run the following
  steps:</p>

  <ol><li><p>Let <var>target port</var> be the port with which <var>source port</var>
   is entangled, if any.<li>

    <p>Let <var>doomed</var> be false. It is set to true if a condition is detected that
    will make this message cause the port to be unusable; specifically, if the message contains <var>target port</var> as one of the objects being <a href=infrastructure.html#transfer-a-transferable-object id=message-ports:transfer-a-transferable-object-3>transferred</a>. (This condition cannot necessarily be detected when the method is called.)</p>

   <li>

    <p>Let <var>new ports</var> be an empty array.</p>

   <li>

    <p>Let <var>transfer map</var> be an empty association list of
    <code id=message-ports:transferable-3><a href=infrastructure.html#transferable>Transferable</a></code> objects to placeholder objects.</p>

   <li>

    <p>If the method was invoked with a second argument <var>transfer</var>, run these
    substeps:</p>

    <ol><li>

      <p>If any object is listed in <var>transfer</var> more than once, or any of the
      <code id=message-ports:transferable-4><a href=infrastructure.html#transferable>Transferable</a></code> objects listed in <var>transfer</var> are marked as <a href=infrastructure.html#concept-transferable-neutered id=message-ports:concept-transferable-neutered-2>neutered</a>, then throw a
      <code id=message-ports:datacloneerror-2><a href=infrastructure.html#datacloneerror>DataCloneError</a></code> exception and abort these steps.</p>

     <li>

      <p>If any of the objects in <var>transfer</var> are the <var>source
      port</var>, then throw a <code id=message-ports:datacloneerror-3><a href=infrastructure.html#datacloneerror>DataCloneError</a></code> exception and abort these steps.</p>

     <li>

      <p>If any of the objects in <var>transfer</var> are the <var>target
      port</var>, if any, then let <var>doomed</var> be true, and optionally report to a
      developer console that the target port was posted to itself, causing the communication channel
      to be lost.</p>

     <li>

      <p>For each object <var>x</var> in <var>transfer</var> in turn, add a
      mapping from <var>x</var> to a new unique placeholder object created for <var>x</var> to <var>transfer map</var>, and if <var>x</var> is a
      <code id=message-ports:messageport-12><a href=#messageport>MessagePort</a></code> object, also append the placeholder object to the <var>new
      ports</var> array.</p>

     </ol>

   <li>

    <p>Let <var>message clone</var> be the result of obtaining a <a id=message-ports:structured-clone href=infrastructure.html#structured-clone>structured
    clone</a> of the <var>message</var> argument, with <var>transfer map</var>
    as the <i>transfer map</i>. If this throws an exception, then throw that exception and abort
    these steps.</p>

   <li>

    <p>If the method was invoked with a second argument <var>transfer</var>, run these
    substeps:</p>

    <ol><li>

      <p>Let <var>new owner</var> be the <a href=#concept-port-owner id=message-ports:concept-port-owner-9>owner</a> of
      <var>target port</var>, if there is a <var>target port</var> and <var>doomed</var> is false, or else some arbitrary owner. (This <var>new
      owner</var> is used when transferring objects below. If there is no <var>target
      port</var>, or if the <var>target port</var> is one of the objects being <a href=infrastructure.html#transfer-a-transferable-object id=message-ports:transfer-a-transferable-object-4>transferred</a>, the <code id=message-ports:transferable-5><a href=infrastructure.html#transferable>Transferable</a></code>
      objects given in the second argument, if any, are still <a href=infrastructure.html#transfer-a-transferable-object id=message-ports:transfer-a-transferable-object-5>transferred</a>, but since they are then discarded, it doesn't matter where they
      are transferred to.)</p>

     <li>

      <p>For each object <var>x</var> in <var>transfer</var> in turn, obtain a
      new object <var>y</var> by <a href=infrastructure.html#transfer-a-transferable-object id=message-ports:transfer-a-transferable-object-6>transferring</a> the object <var>x</var> to <var>new
      owner</var>, and replace the placeholder object that was created for the object <var>x</var> by the new object <var>y</var> wherever the placeholder exists
      (i.e. in <var>message clone</var> and in <var>new ports</var>).</p>

     </ol>

   <li>

    <p>Make <var>new ports</var> into a <a href=infrastructure.html#dfn-read-only-array id=message-ports:dfn-read-only-array>read only</a>
    array.</p>

   <li><p>If there is no <var>target port</var> (i.e. if <var>source port</var>
   is not entangled), or if <var>doomed</var> is true, then abort these steps.<li><p>Create an event <var>e</var> that uses the <code id=message-ports:messageevent><a href=#messageevent>MessageEvent</a></code> interface, with the name <code id=message-ports:event-message-2><a href=indices.html#event-message>message</a></code>, which does not bubble, is not cancelable, and has no
   default action.<li><p>Let the <code id=message-ports:dom-messageevent-data><a href=#dom-messageevent-data>data</a></code> attribute of <var>e</var> be
   initialised to the value of <var>message clone</var>.<li><p>Let the <code id=message-ports:dom-messageevent-ports><a href=#dom-messageevent-ports>ports</a></code> attribute of <var>e</var> be
   initialised to the <var>new ports</var> array.<li>

    <p>Add a <a href=webappapis.html#concept-task id=message-ports:concept-task-6>task</a> that runs the following steps to the <a href=#port-message-queue id=message-ports:port-message-queue-12>port
    message queue</a> of <var>target port</var>:</p>

    <ol><li><p>Let <var>target</var> be the <code id=message-ports:messageport-13><a href=#messageport>MessagePort</a></code> in whose <a href=#port-message-queue id=message-ports:port-message-queue-13>port message
     queue</a> the event <var>e</var> now finds itself.<li><p><a href=infrastructure.html#concept-event-dispatch id=message-ports:concept-event-dispatch>Dispatch</a> <var>e</var> at
     <var>target</var>.</ol>

   </ol>


  <hr>

  <p>The <dfn id=dom-messageport-start><code>start()</code></dfn> method must enable its port's
  <a href=#port-message-queue id=message-ports:port-message-queue-14>port message queue</a>, if it is not already enabled.</p>

  <hr>

  <p>The <dfn id=dom-messageport-close><code>close()</code></dfn> method, when called on a port
  <var>local port</var> that is entangled with another port, must cause the user agent to
  disentangle the two ports. If the method is called on a port that is not entangled, then the
  method must do nothing.</p>



  <hr>

  <p>The following are the <a id=message-ports:event-handlers href=webappapis.html#event-handlers>event handlers</a> (and their corresponding <a href=webappapis.html#event-handler-event-type id=message-ports:event-handler-event-type>event handler event types</a>) that must be supported, as <a id=message-ports:event-handler-idl-attributes href=webappapis.html#event-handler-idl-attributes>event
  handler IDL attributes</a>, by all objects implementing the <code id=message-ports:messageport-14><a href=#messageport>MessagePort</a></code>
  interface:</p>

  <table><thead><tr><th><a href=webappapis.html#event-handlers id=message-ports:event-handlers-2>Event handler</a> <th><a id=message-ports:event-handler-event-type-2 href=webappapis.html#event-handler-event-type>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-messageport-onmessage><code>onmessage</code></dfn> <td> <code id=message-ports:event-message-3><a href=indices.html#event-message>message</a></code>
  </table>

  <p>The first time a <code id=message-ports:messageport-15><a href=#messageport>MessagePort</a></code> object's <code id=message-ports:handler-messageport-onmessage-2><a href=#handler-messageport-onmessage>onmessage</a></code> IDL attribute is set, the port's <a href=#port-message-queue id=message-ports:port-message-queue-15>port
  message queue</a> must be enabled, as if the <code id=message-ports:dom-messageport-start-3><a href=#dom-messageport-start>start()</a></code>
  method had been called.</p>

  


  <h4 id=broadcasting-to-many-ports>9.5.4 Broadcasting to many ports</h4>

  <p class=critical>The API described in this section is controversial, as, in an attempt to solve
  an architectural memory leak, it instead exposes the details of Garbage Collection. This is a
  lose-lose scenario. A better solution is really needed here.</p>

  <p>Broadcasting to many ports is in principle relatively simple: keep an array of
  <code id=broadcasting-to-many-ports:messageport><a href=#messageport>MessagePort</a></code> objects to send messages to, and iterate through the array to send a
  message. However, this has one rather unfortunate effect: it prevents the ports from being garbage
  collected, even if the other side has gone away.</p>

  <p>To avoid this problem, the <code id=broadcasting-to-many-ports:portcollection><a href=#portcollection>PortCollection</a></code> object can be used. It acts as an opaque
  array of <code id=broadcasting-to-many-ports:messageport-2><a href=#messageport>MessagePort</a></code> objects, thus allowing the objects to be garbage collected when
  they stop being relevant, while still allowing scripts to iterate over the
  <code id=broadcasting-to-many-ports:messageport-3><a href=#messageport>MessagePort</a></code> objects.</p>

  <pre class=idl>[<a href=#dom-portcollection id=broadcasting-to-many-ports:dom-portcollection>Constructor</a>, Exposed=(Window,Worker)]
interface <dfn id=portcollection>PortCollection</dfn> {
  void <a href=#dom-portcollection-add id=broadcasting-to-many-ports:dom-portcollection-add>add</a>(<a href=#messageport id=broadcasting-to-many-ports:messageport-4>MessagePort</a> port);
  void <a href=#dom-portcollection-remove id=broadcasting-to-many-ports:dom-portcollection-remove>remove</a>(<a href=#messageport id=broadcasting-to-many-ports:messageport-5>MessagePort</a> port);
  void <a href=#dom-portcollection-clear id=broadcasting-to-many-ports:dom-portcollection-clear>clear</a>();
  void <a href=#dom-portcollection-iterate id=broadcasting-to-many-ports:dom-portcollection-iterate>iterate</a>(<a href=#portcollectioncallback id=broadcasting-to-many-ports:portcollectioncallback>PortCollectionCallback</a> callback);
};

callback <dfn id=portcollectioncallback>PortCollectionCallback</dfn> = void (<a href=#messageport id=broadcasting-to-many-ports:messageport-6>MessagePort</a> port);</pre>

  <dl class=domintro><dt><var>portCollection</var> = new <code id=broadcasting-to-many-ports:dom-portcollection-2><a href=#dom-portcollection>PortCollection</a></code>()<dd>

    <p>Returns a new empty <code id=broadcasting-to-many-ports:portcollection-2><a href=#portcollection>PortCollection</a></code> object.</p>

   <dt><var>portCollection</var> . <code id=broadcasting-to-many-ports:dom-portcollection-add-2><a href=#dom-portcollection-add>add</a></code>(<var>port</var>)<dd>

    <p>Adds <var>port</var> to the collection, if it isn't already present.</p>

   <dt><var>portCollection</var> . <code id=broadcasting-to-many-ports:dom-portcollection-remove-2><a href=#dom-portcollection-remove>remove</a></code>(<var>port</var>)<dd>

    <p>Removes <var>port</var> from the collection, if it is present.</p>

   <dt><var>portCollection</var> . <code id=broadcasting-to-many-ports:dom-portcollection-clear-2><a href=#dom-portcollection-clear>clear</a></code>()<dd>

    <p>Removes all ports from the collection.</p>

   <dt><var>portCollection</var> . <code id=broadcasting-to-many-ports:dom-portcollection-iterate-2><a href=#dom-portcollection-iterate>iterate</a></code>(<var>callback</var>)<dd>

    <p>Calls <var>callback</var> for each port in the collection.</p>

   </dl>

  

  <p>A <code id=broadcasting-to-many-ports:portcollection-3><a href=#portcollection>PortCollection</a></code> object has an initially empty <dfn id=concept-portcollection-list>list of ports</dfn>. When a <code id=broadcasting-to-many-ports:messageport-7><a href=#messageport>MessagePort</a></code> object in
  a <a href=#concept-portcollection-list id=broadcasting-to-many-ports:concept-portcollection-list>list of ports</a> is garbage collected, it must be
  silently removed from that <a href=#concept-portcollection-list id=broadcasting-to-many-ports:concept-portcollection-list-2>list of ports</a>. Objects
  in a <a href=#concept-portcollection-list id=broadcasting-to-many-ports:concept-portcollection-list-3>list of ports</a> are ordered chronologically by
  the time at which they were most recently added; the least-recently added <code id=broadcasting-to-many-ports:messageport-8><a href=#messageport>MessagePort</a></code>
  object is the first in the list, and the most-recently added <code id=broadcasting-to-many-ports:messageport-9><a href=#messageport>MessagePort</a></code> is the last
  in the list.</p>

  <p>The <dfn id=dom-portcollection><code>PortCollection()</code></dfn> constructor must return
  a new <code id=broadcasting-to-many-ports:portcollection-4><a href=#portcollection>PortCollection</a></code> object (with an empty <a href=#concept-portcollection-list id=broadcasting-to-many-ports:concept-portcollection-list-4>list of ports</a>).</p>

  <p>The <dfn id=dom-portcollection-add><code>add()</code></dfn> method must add the
  <code id=broadcasting-to-many-ports:messageport-10><a href=#messageport>MessagePort</a></code> given by the argument to the <code id=broadcasting-to-many-ports:portcollection-5><a href=#portcollection>PortCollection</a></code> object's <a href=#concept-portcollection-list id=broadcasting-to-many-ports:concept-portcollection-list-5>list of ports</a>, unless the <code id=broadcasting-to-many-ports:messageport-11><a href=#messageport>MessagePort</a></code> is
  already in the <a href=#concept-portcollection-list id=broadcasting-to-many-ports:concept-portcollection-list-6>list of ports</a>, in which case the
  method does nothing. (Calling this method with a port already in the list does not move the port
  to the end of the list.)</p>

  <p>The <dfn id=dom-portcollection-remove><code>remove()</code></dfn> method must remove the
  <code id=broadcasting-to-many-ports:messageport-12><a href=#messageport>MessagePort</a></code> given by the argument from the <code id=broadcasting-to-many-ports:portcollection-6><a href=#portcollection>PortCollection</a></code> object's <a href=#concept-portcollection-list id=broadcasting-to-many-ports:concept-portcollection-list-7>list of ports</a>, unless the <code id=broadcasting-to-many-ports:messageport-13><a href=#messageport>MessagePort</a></code> is
  not in the <a href=#concept-portcollection-list id=broadcasting-to-many-ports:concept-portcollection-list-8>list of ports</a>, in which case the
  method does nothing.</p>

  <p>The <dfn id=dom-portcollection-clear><code>clear()</code></dfn> method must remove all
  <code id=broadcasting-to-many-ports:messageport-14><a href=#messageport>MessagePort</a></code> objects from the <code id=broadcasting-to-many-ports:portcollection-7><a href=#portcollection>PortCollection</a></code> object's <a href=#concept-portcollection-list id=broadcasting-to-many-ports:concept-portcollection-list-9>list of ports</a>, returning it to the initial empty state.
  If the <a href=#concept-portcollection-list id=broadcasting-to-many-ports:concept-portcollection-list-10>list of ports</a> is already empty, the method
  does nothing.</p>

  <p>The <dfn id=dom-portcollection-iterate><code>iterate()</code></dfn> method must invoke its
  <code id=broadcasting-to-many-ports:portcollectioncallback-2><a href=#portcollectioncallback>PortCollectionCallback</a></code> argument once for each <code id=broadcasting-to-many-ports:messageport-15><a href=#messageport>MessagePort</a></code> object in the
  object's <a href=#concept-portcollection-list id=broadcasting-to-many-ports:concept-portcollection-list-11>list of ports</a>, in the order defined
  above, with each invocation being passed the corresponding <code id=broadcasting-to-many-ports:messageport-16><a href=#messageport>MessagePort</a></code> object as the
  callback's sole argument.</p>

  


  <h4 id=ports-and-garbage-collection>9.5.5 Ports and garbage collection</h4>

  

  <p>When a <code id=ports-and-garbage-collection:messageport><a href=#messageport>MessagePort</a></code> object <var>o</var> is entangled, user agents must
  either act as if <var>o</var>'s entangled <code id=ports-and-garbage-collection:messageport-2><a href=#messageport>MessagePort</a></code> object has a strong
  reference to <var>o</var>, or as if the <a id=ports-and-garbage-collection:global-object href=webappapis.html#global-object>global object</a> specified by <var>o</var>'s <a href=#concept-port-owner id=ports-and-garbage-collection:concept-port-owner>owner</a> has a strong reference to <var>o</var>.</p>

  <div class=note>

   <p>Thus, a message port can be received, given an event listener, and then forgotten, and so long
   as that event listener could receive a message, the channel will be maintained.</p>

   <p>Of course, if this was to occur on both sides of the channel, then both ports could be garbage
   collected, since they would not be reachable from live code, despite having a strong reference to
   each other.</p>

  </div>

  <p>Furthermore, a <code id=ports-and-garbage-collection:messageport-3><a href=#messageport>MessagePort</a></code> object must not be garbage collected while there exists
  an event referenced by a <a href=webappapis.html#concept-task id=ports-and-garbage-collection:concept-task>task</a> in a <a id=ports-and-garbage-collection:task-queue href=webappapis.html#task-queue>task queue</a> that is to be dispatched on that <code id=ports-and-garbage-collection:messageport-4><a href=#messageport>MessagePort</a></code>
  object, or while the <code id=ports-and-garbage-collection:messageport-5><a href=#messageport>MessagePort</a></code> object's <a href=#port-message-queue id=ports-and-garbage-collection:port-message-queue>port message queue</a> is enabled
  and not empty.</p> 

  

  <p>There are no strong references from a <code id=ports-and-garbage-collection:portcollection><a href=#portcollection>PortCollection</a></code> object to its
  <code id=ports-and-garbage-collection:messageport-6><a href=#messageport>MessagePort</a></code> objects. (That is in fact the whole point of <code id=ports-and-garbage-collection:portcollection-2><a href=#portcollection>PortCollection</a></code>
  objects: they allow for <code id=ports-and-garbage-collection:messageport-7><a href=#messageport>MessagePort</a></code> objects to be referenced without preventing them
  from being garbage collected.)</p>

  

  <p class=note>Authors are strongly encouraged to explicitly close <code id=ports-and-garbage-collection:messageport-8><a href=#messageport>MessagePort</a></code>
  objects to disentangle them, so that their resources can be recollected. Creating many
  <code id=ports-and-garbage-collection:messageport-9><a href=#messageport>MessagePort</a></code> objects and discarding them without closing them can lead to high
  transient memory usage since garbage collection is not necessarily performed promptly, especially
  for <code id=ports-and-garbage-collection:messageport-10><a href=#messageport>MessagePort</a></code>s where garbage collection can involve cross-process coordination.</p>



  <h3 id=broadcasting-to-other-browsing-contexts>9.6 <dfn>Broadcasting to other browsing contexts</dfn></h3>

  <p>Pages on a single <a id=broadcasting-to-other-browsing-contexts:origin-2 href=browsers.html#origin-2>origin</a> opened by the same user in the same user agent but in
  different unrelated <a href=browsers.html#browsing-context id=broadcasting-to-other-browsing-contexts:browsing-context>browsing contexts</a> sometimes need to
  send notifications to each other, for example "hey, the user logged in over here, check your
  credentials again".</p>

  <p>For elaborate cases, e.g. to manage locking of shared state, to manage synchronisation of
  resources between a server and multiple local clients, to share a <code id=broadcasting-to-other-browsing-contexts:websocket><a href=#websocket>WebSocket</a></code>
  connection with a remote host, and so forth, <a href=workers.html#sharedworker id=broadcasting-to-other-browsing-contexts:sharedworker>shared workers</a> are
  the most appropriate solution.</p>

  <p>For simple cases, though, where a shared worker would be an unreasonable overhead, authors can
  use the simple channel-based broadcast mechanism described in this section.</p>

  <pre class=idl>[<a href=#dom-broadcastchannel id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel>Constructor</a>(DOMString channel), Exposed=(Window,Worker)]
interface <dfn id=broadcastchannel>BroadcastChannel</dfn> : <a id=broadcasting-to-other-browsing-contexts:eventtarget href=infrastructure.html#eventtarget>EventTarget</a> {
  readonly attribute DOMString <a href=#dom-broadcastchannel-name id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-name>name</a>;
  void <a href=#dom-broadcastchannel-postmessage id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-postmessage>postMessage</a>(any message);
  void <a href=#dom-broadcastchannel-close id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-close>close</a>();
  attribute <a id=broadcasting-to-other-browsing-contexts:eventhandler href=webappapis.html#eventhandler>EventHandler</a> <a href=#handler-broadcastchannel-onmessage id=broadcasting-to-other-browsing-contexts:handler-broadcastchannel-onmessage>onmessage</a>;
};</pre>

  <dl class=domintro><dt><var>broadcastChannel</var> = new <code id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-2><a href=#dom-broadcastchannel>BroadcastChannel</a></code>(<var>channel</var>)<dd>

    <p>Returns a new <code id=broadcasting-to-other-browsing-contexts:broadcastchannel><a href=#broadcastchannel>BroadcastChannel</a></code> object via which messages for the given channel can be sent and received.</p>

   <dt><var>broadcastChannel</var> . <code id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-name-2><a href=#dom-broadcastchannel-name>name</a></code><dd>

    <p>Returns the channel ID (as passed to the constructor).</p>

   <dt><var>broadcastChannel</var> . <code id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-postmessage-2><a href=#dom-broadcastchannel-postmessage>postMessage</a></code>(<var>message</var>)<dd>

    <p>Sends the given message to other <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-2><a href=#broadcastchannel>BroadcastChannel</a></code> objects set up for this channel. Messages can be structured objects, e.g. nested objects and arrays.</p>

   <dt><var>broadcastChannel</var> . <code id=broadcasting-to-other-browsing-contexts:dom-broadcastchannel-close-2><a href=#dom-broadcastchannel-close>close</a></code>()<dd>

    <p>Closes the <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-3><a href=#broadcastchannel>BroadcastChannel</a></code> object, opening it up to garbage collection.</p>

   </dl>

  

  <p>A <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-4><a href=#broadcastchannel>BroadcastChannel</a></code> object has a <dfn id=channel-name>channel name</dfn>, a
  <dfn id=broadcastchannel-settings-object><code>BroadcastChannel</code> settings object</dfn>, and a <dfn id=concept-broadcastchannel-closed>closed flag</dfn>.</p>

  <p>The <dfn id=dom-broadcastchannel><code>BroadcastChannel()</code></dfn> constructor, when
  invoked, must create and return a <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-5><a href=#broadcastchannel>BroadcastChannel</a></code> object whose <a href=#channel-name id=broadcasting-to-other-browsing-contexts:channel-name>channel
  name</a> is the constructor's first argument, whose <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object><code>BroadcastChannel</code>
  settings object</a> is the <a id=broadcasting-to-other-browsing-contexts:incumbent-settings-object href=webappapis.html#incumbent-settings-object>incumbent settings object</a>, and whose <a href=#concept-broadcastchannel-closed id=broadcasting-to-other-browsing-contexts:concept-broadcastchannel-closed>closed flag</a> is false.</p>

  <p>The <dfn id=dom-broadcastchannel-name><code>name</code></dfn> attribute must return the
  <a href=#channel-name id=broadcasting-to-other-browsing-contexts:channel-name-2>channel name</a>.</p>

  <p>The <dfn id=dom-broadcastchannel-postmessage><code>postMessage()</code></dfn> method,
  when invoked on a <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-6><a href=#broadcastchannel>BroadcastChannel</a></code> object <var>source</var> with an
  argument <var>message</var>, must run the following steps:</p>

  <ol><li><p>Let <var>source settings</var> be <var>source</var>'s
   <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-2><code>BroadcastChannel</code> settings object</a>.</p>

   <li><p>If <var>source</var>'s <a href=#concept-broadcastchannel-closed id=broadcasting-to-other-browsing-contexts:concept-broadcastchannel-closed-2>closed flag</a> is
   true, then throw an <code id=broadcasting-to-other-browsing-contexts:invalidstateerror><a href=infrastructure.html#invalidstateerror>InvalidStateError</a></code> exception and abort these steps.<li><p>Let <var>source channel</var> be <var>source</var>'s
   <a href=#channel-name id=broadcasting-to-other-browsing-contexts:channel-name-3>channel name</a>.</p>

   <li><p>Let <var>cloned message</var> be a <a id=broadcasting-to-other-browsing-contexts:structured-clone href=infrastructure.html#structured-clone>structured clone</a> of the <var>message</var> argument. If this throws an exception, then rethrow that exception and
   abort these steps.<li>

    <p>Let <var>destinations</var> be a list of <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-7><a href=#broadcastchannel>BroadcastChannel</a></code> objects that
    match the following criteria:</p>

    <ul><li>

      <p>Their <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-3><code>BroadcastChannel</code> settings object</a> specifies either:</p>

      <ul><li><p>a <a id=broadcasting-to-other-browsing-contexts:global-object href=webappapis.html#global-object>global object</a> that is a <code id=broadcasting-to-other-browsing-contexts:window><a href=browsers.html#window>Window</a></code> object and a
       <a id=broadcasting-to-other-browsing-contexts:responsible-document href=webappapis.html#responsible-document>responsible document</a> that is <a id=broadcasting-to-other-browsing-contexts:fully-active href=browsers.html#fully-active>fully active</a>, or<li><p>a <a id=broadcasting-to-other-browsing-contexts:global-object-2 href=webappapis.html#global-object>global object</a> that is a <code id=broadcasting-to-other-browsing-contexts:workerglobalscope><a href=workers.html#workerglobalscope>WorkerGlobalScope</a></code> object whose
       <code id=broadcasting-to-other-browsing-contexts:dom-workerglobalscope-closing><a href=workers.html#dom-workerglobalscope-closing>closing</a></code> flag is false and whose
       <a id=broadcasting-to-other-browsing-contexts:worker href=workers.html#worker>worker</a> is a <a id=broadcasting-to-other-browsing-contexts:suspendable-worker href=workers.html#suspendable-worker>suspendable worker</a>.</ul>

     <li><p>Their <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-4><code>BroadcastChannel</code> settings object</a> specifies an
     <a id=broadcasting-to-other-browsing-contexts:origin-2-2 href=browsers.html#origin-2>origin</a> that is the <a id=broadcasting-to-other-browsing-contexts:same-origin href=browsers.html#same-origin>same origin</a> as the <a id=broadcasting-to-other-browsing-contexts:origin-2-3 href=browsers.html#origin-2>origin</a> specified
     by <var>source settings</var>.<li><p>Their <a href=#channel-name id=broadcasting-to-other-browsing-contexts:channel-name-4>channel name</a> is a <a id=broadcasting-to-other-browsing-contexts:case-sensitive href=infrastructure.html#case-sensitive>case-sensitive</a> match for <var>source channel</var>.<li><p>Their <a href=#concept-broadcastchannel-closed id=broadcasting-to-other-browsing-contexts:concept-broadcastchannel-closed-3>closed flag</a> is
     false.</ul>

   <li><p>Remove <var>source</var> from <var>destinations</var>.<li>

    <p>Sort <var>destinations</var> such that all <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-8><a href=#broadcastchannel>BroadcastChannel</a></code> objects
    whose <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-5><code>BroadcastChannel</code> settings
    objects</a> specify the same <a id=broadcasting-to-other-browsing-contexts:responsible-event-loop href=webappapis.html#responsible-event-loop>responsible event loop</a> are sorted in creation
    order, oldest first. (This does not define a complete ordering. Within this constraint, user
    agents may sort the list in any user-agent defined manner.)</p>

   <li>

    <p>For each <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-9><a href=#broadcastchannel>BroadcastChannel</a></code> object in <var>destinations</var>,
    <a id=broadcasting-to-other-browsing-contexts:queue-a-task href=webappapis.html#queue-a-task>queue a task</a> that runs the following steps:</p>

    <ol><li><p>Create an event that uses the <code id=broadcasting-to-other-browsing-contexts:messageevent><a href=#messageevent>MessageEvent</a></code> interface, with the event type
     <code id=broadcasting-to-other-browsing-contexts:event-message><a href=indices.html#event-message>message</a></code>, which does not bubble, is not cancelable, and has
     no default action. The <code id=broadcasting-to-other-browsing-contexts:dom-messageevent-data><a href=#dom-messageevent-data>data</a></code> attribute must be
     initialised to a <a id=broadcasting-to-other-browsing-contexts:structured-clone-2 href=infrastructure.html#structured-clone>structured clone</a> of <var>cloned message</var>, and the <code id=broadcasting-to-other-browsing-contexts:dom-messageevent-origin><a href=#dom-messageevent-origin>origin</a></code> attribute must be initialised
     to the <a href=browsers.html#unicode-serialisation-of-an-origin id=broadcasting-to-other-browsing-contexts:unicode-serialisation-of-an-origin>Unicode serialisation</a> of the
     <a id=broadcasting-to-other-browsing-contexts:origin-2-4 href=browsers.html#origin-2>origin</a> specified by <var>source settings</var>. This event is not <a href=infrastructure.html#concept-events-trusted id=broadcasting-to-other-browsing-contexts:concept-events-trusted>trusted</a>.<li><p><a href=infrastructure.html#concept-event-dispatch id=broadcasting-to-other-browsing-contexts:concept-event-dispatch>Dispatch</a> the event at the
     <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-10><a href=#broadcastchannel>BroadcastChannel</a></code> object.</ol>

    <p>The <a href=webappapis.html#concept-task id=broadcasting-to-other-browsing-contexts:concept-task>tasks</a> must use the <a id=broadcasting-to-other-browsing-contexts:dom-manipulation-task-source href=webappapis.html#dom-manipulation-task-source>DOM
    manipulation task source</a>, and, for those where the <a id=broadcasting-to-other-browsing-contexts:event-loop href=webappapis.html#event-loop>event loop</a> specified by the target <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-11><a href=#broadcastchannel>BroadcastChannel</a></code> object's
    <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-6><code>BroadcastChannel</code> settings object</a> is a <a id=broadcasting-to-other-browsing-contexts:browsing-context-2 href=browsers.html#browsing-context>browsing context</a> <a id=broadcasting-to-other-browsing-contexts:event-loop-2 href=webappapis.html#event-loop>event loop</a>, must
    be associated with the <a id=broadcasting-to-other-browsing-contexts:responsible-document-2 href=webappapis.html#responsible-document>responsible
    document</a> specified by that target <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-12><a href=#broadcastchannel>BroadcastChannel</a></code> object's
    <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-7><code>BroadcastChannel</code> settings object</a>.</p>

   </ol>

  <p>While a <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-13><a href=#broadcastchannel>BroadcastChannel</a></code> object whose <a href=#concept-broadcastchannel-closed id=broadcasting-to-other-browsing-contexts:concept-broadcastchannel-closed-4>closed flag</a> is false has an event listener
  registered for <code id=broadcasting-to-other-browsing-contexts:event-message-2><a href=indices.html#event-message>message</a></code> events, there must be a strong
  reference from <a id=broadcasting-to-other-browsing-contexts:global-object-3 href=webappapis.html#global-object>global object</a> specified by the <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-14><a href=#broadcastchannel>BroadcastChannel</a></code> object's
  <a href=#broadcastchannel-settings-object id=broadcasting-to-other-browsing-contexts:broadcastchannel-settings-object-8><code>BroadcastChannel</code> settings object</a> to the <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-15><a href=#broadcastchannel>BroadcastChannel</a></code>
  object itself.</p>

  <p>The <dfn id=dom-broadcastchannel-close><code>close()</code></dfn> method must set the
  <a href=#concept-broadcastchannel-closed id=broadcasting-to-other-browsing-contexts:concept-broadcastchannel-closed-5>closed flag</a> of the
  <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-16><a href=#broadcastchannel>BroadcastChannel</a></code> object on which it was invoked to true.</p>

  <p class=note>Authors are strongly encouraged to explicitly close <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-17><a href=#broadcastchannel>BroadcastChannel</a></code>
  objects when they are no longer needed, so that they can be garbage collected. Creating many
  <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-18><a href=#broadcastchannel>BroadcastChannel</a></code> objects and discarding them while leaving them with an event
  listener and without closing them can lead to an apparent memory leak, since the objects will
  continue to live for as long as they have an event listener (or until their page or worker is
  closed).</p>

  <hr>

  <p>The following are the <a id=broadcasting-to-other-browsing-contexts:event-handlers href=webappapis.html#event-handlers>event handlers</a> (and their corresponding <a href=webappapis.html#event-handler-event-type id=broadcasting-to-other-browsing-contexts:event-handler-event-type>event handler event types</a>) that must be supported, as <a id=broadcasting-to-other-browsing-contexts:event-handler-idl-attributes href=webappapis.html#event-handler-idl-attributes>event
  handler IDL attributes</a>, by all objects implementing the <code id=broadcasting-to-other-browsing-contexts:broadcastchannel-19><a href=#broadcastchannel>BroadcastChannel</a></code>
  interface:</p>

  <table><thead><tr><th><a href=webappapis.html#event-handlers id=broadcasting-to-other-browsing-contexts:event-handlers-2>Event handler</a> <th><a id=broadcasting-to-other-browsing-contexts:event-handler-event-type-2 href=webappapis.html#event-handler-event-type>Event handler event type</a>
   <tbody><tr><td><dfn id=handler-broadcastchannel-onmessage><code>onmessage</code></dfn> <td> <code id=broadcasting-to-other-browsing-contexts:event-message-3><a href=indices.html#event-message>message</a></code>
  </table>

  

  <div class=example>

   <p>Suppose a page wants to know when the user logs out, even when the user does so from another
   tab at the same site:</p>

   <pre>var authChannel = new BroadcastChannel('auth');
authChannel.onmessage = function (event) {
  if (event.data == 'logout')
    showLogout();
}

function logoutRequested() {
  // called when the user asks us to log them out
  doLogout();
  showLogout();
  authChannel.postMessage('logout');
}

function doLogout() {
  // actually log the user out (e.g. clearing cookies)
  // ...
}

function showLogout() {
  // update the UI to indicate we're logged out
  // ...
}</pre>

  </div>





  <nav><a href=webappapis.html>← 8 Web application APIs</a> — <a href=index.html>Table of Contents</a> — <a href=workers.html>10 Web workers →</a></nav>
